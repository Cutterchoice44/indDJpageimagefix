<?php
// dj-selects-config.php
declare(strict_types=1);
header('Access-Control-Allow-Origin: *');
header('Content-Type: application/json; charset=utf-8');

$ACTION       = $_GET['action'] ?? 'load';
$CONFIG_PATH  = __DIR__ . '/dj-selects-config.json';
$SERVER_TOKEN = 'CCR_TEMP_TOKEN_!2025'; // <-- MUST match window.DJ_SELECTS.SAVE_TOKEN in the HTML

if ($ACTION === 'load') {
  if (is_file($CONFIG_PATH)) {
    $raw = file_get_contents($CONFIG_PATH);
    echo $raw !== false ? $raw : '{}';
  } else {
    echo '{}';
  }
  exit;
}

if ($ACTION === 'save') {
  $input = json_decode(file_get_contents('php://input') ?: '{}', true);
  if (!is_array($input) || ($input['token'] ?? '') !== $SERVER_TOKEN) {
    http_response_code(403);
    echo json_encode(['error'=>'Forbidden']);
    exit;
  }
  $data = $input['data'] ?? [];
  if (!is_array($data)) $data = [];

  // minimal schema hardening â€“ only allow expected keys
  $allow = ['djName','profileImage','stationId','apiKey','tracks','contributorId','contributorSlug','contributorKind'];
  $clean = [];
  foreach ($allow as $k) {
    if (isset($data[$k])) $clean[$k] = $data[$k];
  }

  // write atomically
  $tmp = $CONFIG_PATH . '.tmp';
  file_put_contents($tmp, json_encode($clean, JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES));
  rename($tmp, $CONFIG_PATH);

  echo json_encode(['ok'=>true]);
  exit;
}

echo '{}';
