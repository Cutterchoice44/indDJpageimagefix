<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cutty Ranks — Cutters Choice Radio</title>

  <!-- SEO -->
  <meta name="description" content="Cutty Ranks: the best-of archive — YouTube picks from Cutters Choice Radio selectors.">
  <meta name="robots" content="index, follow">
  <meta name="theme-color" content="#5A8785">

  <!-- Social preview -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Cutty Ranks — Cutters Choice Radio">
  <meta property="og:description" content="A best-of archive of YouTube selections from the CCR crew.">
  <meta property="og:url" content="https://cutterschoiceradio.com/cutty-ranks.html">
  <meta property="og:site_name" content="Cutters Choice Radio">
  <meta property="og:image" content="https://cutterschoiceradio.com/images/logo.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Cutty Ranks — Cutters Choice Radio">
  <meta name="twitter:description" content="A best-of archive of YouTube selections from the CCR crew.">
  <meta name="twitter:image" content="https://cutterschoiceradio.com/images/logo.png">

  <!-- Performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.youtube-nocookie.com" crossorigin>

  <!-- Global site styles -->
  <link rel="stylesheet" href="/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root{
      --brand-teal:#5A8785;
      --ink:#eaffff; --ink-dim:#bfe7e4;
      --panel:#0b0f0f; --panel-2:#0e1414; --line:#264745;
      --tile:#0a0f0f; --tile-line:#1d3533;
      --gap:12px;
      --usable:70vh;
    }

    /* ===== Header (unchanged) ===== */
    .header-banner{
      position:relative; display:flex; align-items:center; justify-content:center;
      padding:clamp(16px,3vw,28px) .6rem;
      background:#000 center/cover no-repeat;
      background-image:url('/images/cutty_a.png');
      border-top:2px solid #000; border-bottom:2px solid #000; isolation:isolate;
    }
    .header-banner .title{ text-align:center; }
    .header-banner .title h1{
      margin:0; font-family:'Bebas Neue',sans-serif;
      font-size:clamp(2.3rem,6.2vw,4rem); line-height:1; color:#fff;
      text-shadow:0 2px 12px rgba(0,0,0,.6);
    }
    .header-banner .title .tagline{ margin:.2rem 0 0; color:#fff; text-shadow:0 2px 10px rgba(0,0,0,.6); }
    .header-gif-right,.header-gif-left,.header-wave,.logo-container{ display:none !important; }
    .nav-sep{height:2px;background-color:var(--brand-teal);}

    /* Nav (unchanged) */
    #main-nav .nav-menu{ justify-content: space-evenly !important; }
    #main-nav .nav-link, #main-nav summary.nav-link{
      color:#fff !important; font-family:'Bebas Neue',sans-serif !important;
      font-size:2rem !important; text-transform:uppercase !important;
      text-decoration:none !important; white-space:nowrap !important;
      list-style:none !important; cursor:pointer !important; display:inline-flex; align-items:center;
    }
    .nav-details{ position:relative; }
    .nav-details .about-panel{
      position:absolute; top:calc(100% + 8px); right:0; width:min(520px,86vw);
      background:#000; color:#fff; border:2px solid var(--brand-teal);
      border-radius:8px; padding:.75rem .9rem; line-height:1.35;
      box-shadow:0 8px 18px rgba(0,0,0,.45); display:none; z-index:1100;
    }
    .nav-details[open] .about-panel{ display:block; }
    .nav-details > summary::-webkit-details-marker{ display:none; }

    @media (max-width:768px){
      body.cutty nav#main-nav{
        display:flex !important; flex-direction:row !important; align-items:center !important;
        justify-content:space-between !important; padding:.40rem .65rem !important;
      }
      body.cutty nav#main-nav .nav-menu{
        display:flex !important; gap:.35rem !important; flex-wrap:nowrap !important;
        overflow-x:auto !important; white-space:nowrap !important; scrollbar-width:none;
      }
      body.cutty nav#main-nav .nav-menu::-webkit-scrollbar{ display:none; }
      body.cutty nav#main-nav .nav-link, body.cutty nav#main-nav summary.nav-link{
        font-size:clamp(.8rem,3.2vw,1rem) !important; padding:.2rem .25rem !important;
      }
      .nav-sep{ display:none !important; }
    }

    /* ----- Title band (unchanged artwork) ----- */
    .cutty-title{
      position:relative; border-top:2px solid var(--brand-teal); border-bottom:2px solid var(--brand-teal);
      min-height:110px; display:flex; align-items:center; justify-content:flex-start;
      padding:.35rem .6rem; background: url('/images/cutty_b.png') right center / contain no-repeat, #000;
    }
    .cutty-title::before{
      content:""; position:absolute; inset:0;
      background:linear-gradient(90deg, rgba(0,0,0,.55), rgba(0,0,0,.25) 35%, rgba(0,0,0,0));
      pointer-events:none;
    }
    .cutty-title h2{
      position:relative; z-index:1; color:#fff; font-family:'Bebas Neue',sans-serif;
      font-size:clamp(2.6rem,5.2vw,3.6rem); line-height:1; margin:0; letter-spacing:.6px;
      text-shadow:0 2px 10px rgba(0,0,0,.65);
    }

    /* ===== Concept 4 layout ===== */
    .c4-grid{
      display:grid; gap:var(--gap);
      grid-template-columns: minmax(280px, 1.1fr) minmax(420px,1.1fr) minmax(480px,1.2fr);
      align-items:start; padding:.6rem;
    }

    /* Left: DJ gallery */
    .dj-gallery{
      background:#000; border:2px solid var(--line); border-radius:10px;
      padding:10px; height:var(--usable); overflow:auto;
    }
    .dj-grid{
      display:grid; grid-template-columns:repeat(2, minmax(120px,1fr)); gap:10px;
    }
    .dj-tile{
      position:relative; border:1px solid var(--tile-line); border-radius:12px; overflow:hidden;
      background:#0a0a0a center/cover no-repeat; min-height:140px; cursor:pointer;
      transition:transform .08s ease-in-out, box-shadow .12s ease-in-out, outline .08s;
    }
    .dj-tile:hover{ transform:translateY(-1px); box-shadow:0 8px 24px rgba(0,0,0,.35); }
    .dj-tile.active{ outline:2px solid var(--brand-teal); outline-offset:-2px; }
    .dj-name{
      position:absolute; left:0; right:0; bottom:0; padding:.45rem .55rem;
      background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.75) 60%);
      color:#fff; font-family:'Bebas Neue',sans-serif; font-size:1.25rem; letter-spacing:.5px;
    }

    /* Center: Card stack for selected DJ */
    .stack{
      background:#000; border:2px solid var(--line); border-radius:10px; padding:10px;
      height:var(--usable); display:flex; flex-direction:column; gap:10px;
    }
    .stack .stack-header{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .stack .playall{
      font:600 12px/1 system-ui; color:var(--ink); background:#0b2322;
      border:1px solid var(--brand-teal); border-radius:999px; padding:.5rem .7rem; cursor:pointer;
    }
    .cards{
      display:flex; flex-direction:column; gap:10px; overflow:auto;
    }
    .card{
      display:grid; grid-template-columns:100px 1fr auto; gap:10px; align-items:center;
      padding:8px; border:1px solid var(--tile-line); border-radius:10px; background:#0a0a0a;
    }
    .thumb{
      width:100px; aspect-ratio:16/9; border-radius:6px; background:#111 center/cover no-repeat;
      border:1px solid #122; overflow:hidden;
    }
    .meta .title{
      color:#e7fbf9; font:600 14px/1.2 system-ui; margin:0 0 2px;
    }
    .meta .sub{ color:#86b8b5; font:12px/1.2 system-ui; }
    .card .btn{
      width:36px; height:36px; border-radius:999px; display:grid; place-items:center;
      background:rgba(255,255,255,.12); color:#fff; border:0; cursor:pointer;
    }
    .idx-dot{
      width:28px; height:28px; border-radius:999px; display:grid; place-items:center;
      background:#123; border:1px solid #2a5653; color:#bfe7e4; font:600 12px/1 system-ui;
      margin-right:6px;
    }

    /* Right: Now playing */
    .nowp{
      background:#000; border:2px solid var(--line); border-radius:10px; padding:10px;
      height:var(--usable); display:flex; flex-direction:column; gap:10px;
    }
    .nowp h3{
      font-family:'Bebas Neue',sans-serif; color:#fff; letter-spacing:.6px; margin:.2rem .2rem;
      display:flex; align-items:center; gap:10px;
    }
    .player-shell{
      position:relative; background:#000 center/cover no-repeat; background-image:url('/images/cutty_c.png');
      border:1px solid var(--brand-teal); border-radius:8px; padding:6px; overflow:hidden;
    }
    #mainPreview iframe{ width:100%; aspect-ratio:16/9; height:auto; border:0; display:block; }
    .queue{
      margin-top:auto; background:#060b0b; border:1px solid #1a2f2e; border-radius:8px; padding:8px; overflow:auto;
    }
    .q-item{
      display:flex; align-items:center; gap:8px; padding:6px 8px; border-radius:8px; cursor:pointer;
      color:#d7f9f6;
    }
    .q-item:hover{ background:#0c1716; }
    .q-item.active{ outline:1px dashed var(--brand-teal); outline-offset:-2px; }

    /* Scrollbar aesthetic */
    .dj-gallery::-webkit-scrollbar, .cards::-webkit-scrollbar, .queue::-webkit-scrollbar { width:10px; }
    .dj-gallery::-webkit-scrollbar-track, .cards::-webkit-scrollbar-track, .queue::-webkit-scrollbar-track { background:#061010; }
    .dj-gallery::-webkit-scrollbar-thumb, .cards::-webkit-scrollbar-thumb, .queue::-webkit-scrollbar-thumb { background:#274947; border-radius:10px; border:2px solid #061010; }

    /* ===== Admin overlay (unchanged + extra fields) ===== */
    .adminHidden{ display:none !important; }
    #adminOverlay{
      position:fixed; inset:0; background:rgba(0,0,0,.82); color:#fff; z-index:9999;
      display:flex; align-items:center; justify-content:center;
    }
    #adminPanel{
      width:min(980px,95vw); max-height:92vh; overflow:auto;
      background:#0e1414; border:2px solid var(--brand-teal); border-radius:10px; padding:16px;
      box-shadow:0 12px 40px rgba(0,0,0,.55);
    }
    #adminPanel h3{ font-family:'Bebas Neue',sans-serif; letter-spacing:.5px; margin:0 0 10px; color:#fff; }
    #adminPanel .entry{ border:1px solid #2a5653; border-radius:8px; padding:10px; margin:10px 0; background:#081111; }
    #adminPanel .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:6px 0; }
    #adminPanel input[type="text"]{ flex:1 1 240px; min-width:200px; background:#050808; color:#eaffff; border:1px solid #2a5653; border-radius:6px; padding:8px; }
    #adminPanel label{ font-size:.95rem; opacity:.9; color:#fff; min-width:92px; }
    #adminPanel button{ padding:8px 12px; border-radius:6px; border:1px solid #2a5653; background:#0b2322; color:#eaffff; cursor:pointer; }
    #adminStatus{ opacity:.9; font-size:.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:52ch; margin-left:auto; }
    #clearImgCache{ margin-left:8px; }

    /* ===== Mobile (Concept 5) ===== */
    @media (max-width:980px){
      .c4-grid{ grid-template-columns: 1fr; gap:8px; padding:.4rem .5rem 4.5rem; } /* bottom padding for mini player */
      .dj-gallery{ height:auto; }
      .stack{ height:auto; }
      .nowp{ height:auto; }
      .player-shell{ order:1; }
      .dj-accordion { display:block; background:#000; border:2px solid var(--line); border-radius:10px; overflow:hidden; }
      .dj-accordion details{ border-top:1px solid #1a2f2e; }
      .dj-accordion summary{
        list-style:none; cursor:pointer; padding:12px 14px; color:#fff; font-family:'Bebas Neue',sans-serif; font-size:1.4rem;
        display:flex; align-items:center; gap:10px; background:#0b1111;
      }
      .dj-accordion summary::-webkit-details-marker{ display:none; }
      .dj-accordion .acc-inner{ padding:8px 12px 12px; background:#050808; }
      .acc-card{ display:flex; gap:10px; align-items:center; padding:8px 0; border-bottom:1px solid #101a1a; }
      .acc-thumb{ width:100px; aspect-ratio:16/9; border-radius:6px; background:#111 center/cover no-repeat; border:1px solid #122; }
      .acc-title{ color:#d7f9f6; font:600 14px/1.2 system-ui; }
    }

    /* Sticky mini player (mobile only) */
    #miniPlayer{
      position:fixed; left:0; right:0; bottom:0; z-index:1200;
      background:#0b1515; border-top:2px solid var(--brand-teal);
      display:none; grid-template-columns: auto 1fr auto auto; gap:10px; align-items:center;
      padding:10px 12px;
    }
    #miniPlayer .mp-thumb{ width:64px; aspect-ratio:16/9; border-radius:6px; background:#111 center/cover no-repeat; border:1px solid #122; }
    #miniPlayer .mp-title{ color:#eaffff; font:600 13px/1.2 system-ui; }
    #miniPlayer .mp-sub{ color:#86b8b5; font:12px/1.1 system-ui; }
    #miniPlayer .mp-btn{ width:36px; height:36px; border-radius:999px; border:1px solid #2a5653; background:#0b2322; color:#eaffff; display:grid; place-items:center; }
    @media (max-width:980px){ #miniPlayer{ display:grid; } }
  </style>

  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>
</head>

<body class="cutty">
  <!-- HEADER (unchanged) -->
  <header class="header-banner" role="banner">
    <div class="title">
      <h1>Cutters Choice Radio</h1>
      <p class="tagline">The home of relentless flavas and significant bangers!</p>
    </div>
  </header>

  <div class="nav-sep top"></div>

  <!-- Primary Nav (unchanged) -->
  <nav id="main-nav" aria-label="Primary">
    <div class="nav-menu">
      <a href="/"                  class="nav-link">HOME</a>
      <a href="/our-story.html"    class="nav-link">OUR STORY</a>
      <a href="/index-ourDJS.html" class="nav-link">OUR DJS</a>
      <a href="/dj-selects.html"   class="nav-link">DJ SELECTS</a>
      <a href="/schedule.html"     class="nav-link">SCHEDULE</a>
      <a href="/merch.html"        class="nav-link">MERCH</a>

      <details class="nav-details">
        <summary class="nav-link" aria-label="About Cutty Ranks">ABOUT CUTTY RANKS</summary>
        <div class="about-panel">
          <p>Pick a DJ on the left, cue their 5 clips in the center, and watch on the right. Shift+A to admin.</p>
        </div>
      </details>
    </div>
  </nav>

  <!-- Title band (unchanged artwork) -->
  <section class="cutty-title">
    <h2>CUTTY RANKS: THE SELECTOR ARCHIVES</h2>
  </section>

  <!-- Concept 4 grid -->
  <main class="c4-grid" role="main">
    <!-- LEFT: DJ Gallery -->
    <section class="dj-gallery" aria-label="Selectors">
      <div id="djGrid" class="dj-grid" role="list"></div>
    </section>

    <!-- CENTER: Stack -->
    <section class="stack" aria-label="Picks">
      <div class="stack-header">
        <h3 class="h title" style="font-family:'Bebas Neue',sans-serif;color:#fff;letter-spacing:.6px;margin:.2rem .2rem;">PICKS</h3>
        <div>
          <button id="playAllBtn" class="playall" title="Play all (selected DJ)">▶ Play All</button>
          <button id="shuffleBtn" class="playall" title="Shuffle (selected DJ)">🔀 Shuffle</button>
        </div>
      </div>
      <div id="cards" class="cards"></div>
    </section>

    <!-- RIGHT: Now Playing -->
    <aside class="nowp" aria-label="Now Playing">
      <h3>Now Playing</h3>
      <div class="player-shell">
        <div id="mainPreview"><!-- player injected --></div>
      </div>
      <div class="queue" id="queueBox" aria-label="Queue"></div>
    </aside>

    <!-- MOBILE: Accordion list (only visible on mobile via CSS) -->
    <section class="dj-accordion" id="djAccordion" aria-label="Mobile Selectors" style="display:none;"></section>
  </main>

  <!-- Sticky Mini Player (mobile) -->
  <div id="miniPlayer" aria-live="polite">
    <div class="mp-thumb" id="mpThumb"></div>
    <div>
      <div class="mp-title" id="mpTitle">Nothing playing</div>
      <div class="mp-sub" id="mpSub">Select a clip</div>
    </div>
    <button id="mpPrev" class="mp-btn" title="Previous">⏮</button>
    <button id="mpPlayPause" class="mp-btn" title="Play/Pause">⏯</button>
    <button id="mpNext" class="mp-btn" title="Next">⏭</button>
  </div>

  <!-- Hidden Admin Overlay -->
  <div id="adminOverlay" class="adminHidden" aria-hidden="true">
    <div id="adminPanel" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
      <h3 id="adminTitle">Cutty Ranks — Admin</h3>
      <div id="adminEntries"></div>
      <div id="adminActions" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <button id="addEntryBtn"><i class="fa fa-plus"></i>&nbsp; Add DJ</button>
        <button id="adminSave">Save</button>
        <button id="adminClose">Close</button>
        <button id="clearImgCache" title="Clear cached Radio Cult images">Clear Image Cache</button>
        <div id="adminStatus"></div>
      </div>
    </div>
  </div>

  <!-- Config -->
  <script>
    window.CUTTY_RANKS = {
      CONFIG_ENDPOINT: 'cutty-ranks-config.php',
      ADMIN_HASH_HEX: '446b03243337b8bb55581f2c94647468d02b9dc09aa07968701be1f65071599e'
    };
    window.RC = {
      API_KEY: 'pk_0b8abc6f834b444f949f727e88a728e0',
      // Try these common search endpoints (first one that returns an image wins)
      ENDPOINTS: [
        'https://api.radiocult.fm/v1/search/artists?q=',
        'https://api.radiocult.app/v1/search/artists?q=',
        'https://api.radiocult.io/v1/search/artists?q=',
        'https://radiocult.fm/api/search?type=artist&q='
      ],
      // Optional CDN pattern fallback if you know your slugs: /images/djs/{slug}.jpg on your site.
      LOCAL_DJ_IMAGE_PREFIX: '/images/djs/' // e.g. /images/djs/benny-forz.jpg
    };
  </script>

  <script>
  (() => {
    const CFG = window.CUTTY_RANKS || {};
    const RC  = window.RC || {};
    const $   = (s, r=document) => r.querySelector(s);
    const $$  = (s, r=document) => [...r.querySelectorAll(s)];

    /* ====== Elements ====== */
    const rootMain   = document.querySelector('main.c4-grid');
    const djGrid     = $('#djGrid');
    const cardsBox   = $('#cards');
    const queueBox   = $('#queueBox');
    const mainPreview= $('#mainPreview');

    const playAllBtn = $('#playAllBtn');
    const shuffleBtn = $('#shuffleBtn');

    const mpBar      = $('#miniPlayer');
    const mpThumb    = $('#mpThumb');
    const mpTitle    = $('#mpTitle');
    const mpSub      = $('#mpSub');
    const mpPrev     = $('#mpPrev');
    const mpPP       = $('#mpPlayPause');
    const mpNext     = $('#mpNext');

    const adminOverlay   = $('#adminOverlay');
    const adminEntriesBox= $('#adminEntries');
    const addEntryBtn    = $('#addEntryBtn');
    const adminSaveBtn   = $('#adminSave');
    const adminCloseBtn  = $('#adminClose');
    const adminStatus    = $('#adminStatus');
    const clearImgCache  = $('#clearImgCache');

    const state = {
      entries: [],            // [{name, links[], rcSlug?, image?}]
      authed:false,
      selected: 0,            // selected DJ index
      queue: [],              // current queue of YT ids for selected DJ
      qidx: 0,                // index within queue
      apiReady:false,
      player:null,
      rcImgCache:{},          // name/slug -> image URL
      lastVideoData:{title:'', video_id:''}
    };

    /* ====== Layout sizing ====== */
    function setHeights(){
      const rect = rootMain.getBoundingClientRect();
      const usable = Math.max(360, window.innerHeight - rect.top - 12);
      document.documentElement.style.setProperty('--usable', usable+'px');
    }
    window.addEventListener('resize', setHeights, {passive:true});
    window.addEventListener('load', setHeights, {passive:true});

    /* ====== YouTube helpers ====== */
    const ytId = (u) => {
      try{
        const x = new URL(u);
        const h = x.hostname.toLowerCase();
        if(h === 'youtu.be') return x.pathname.slice(1);
        if(x.pathname.startsWith('/shorts/')) return x.pathname.split('/')[2] || '';
        if(x.searchParams.get('v')) return x.searchParams.get('v');
        if(/^\/embed\//.test(x.pathname)) return x.pathname.split('/').pop();
        return '';
      }catch{ return ''; }
    };
    window.onYouTubeIframeAPIReady = () => { state.apiReady = true; };

    function ensurePlayer(){
      if ($('#ytPlayer')) return;
      mainPreview.innerHTML = `<div id="ytPlayer"></div>`;
    }
    function createOrLoad(videoId, autoplay){
      ensurePlayer();
      const doPlay = () => {
        if (!state.player){
          state.player = new YT.Player('ytPlayer', {
            host:'https://www.youtube-nocookie.com',
            videoId,
            playerVars:{ rel:0, modestbranding:1, playsinline:1, enablejsapi:1 },
            events:{
              onReady: (e)=>{ autoplay ? e.target.playVideo() : e.target.cueVideoById(videoId); updateMiniMeta(); },
              onStateChange: (e)=>{
                // Update Now Playing text from YT when available
                try {
                  const d = state.player?.getVideoData?.() || {};
                  if (d?.title) { state.lastVideoData.title = d.title; }
                }catch{}
                if (e.data === YT.PlayerState.ENDED && state.queue.length){
                  if (state.qidx < state.queue.length - 1){
                    state.qidx += 1; playAtIndex(state.qidx, true);
                  }
                }
                highlightQueue();
                updateMiniMeta();
              }
            }
          });
        } else {
          autoplay ? state.player.loadVideoById(videoId) : state.player.cueVideoById(videoId);
        }
      };
      if (state.apiReady) doPlay(); else {
        const iv = setInterval(()=>{ if(state.apiReady){ clearInterval(iv); doPlay(); } }, 50);
        setTimeout(()=>clearInterval(iv), 4000);
      }
    }

    function playAtIndex(idx, autoplay=true){
      const id = state.queue[idx];
      if (!id) return;
      state.qidx = idx;
      createOrLoad(id, autoplay);
      highlightQueue();
      updateMiniMeta();
    }

    function updateMiniMeta(){
      // Try to populate title from YT player if possible
      let title = state.lastVideoData.title || '';
      try { title = state.player?.getVideoData?.().title || title; }catch{}
      const dj = state.entries[state.selected]?.name || '—';
      mpTitle.textContent = title || 'Playing…';
      mpSub.textContent = dj;
      const vid = state.queue[state.qidx];
      if (vid) mpThumb.style.backgroundImage = `url('https://i.ytimg.com/vi/${vid}/hqdefault.jpg')`;
    }

    /* ====== Radio Cult images ====== */
    function slugify(s){ return (s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
    function loadImgCache(){
      try{ state.rcImgCache = JSON.parse(localStorage.getItem('rc_img_cache')||'{}'); }catch{ state.rcImgCache={}; }
    }
    function saveImgCache(){ localStorage.setItem('rc_img_cache', JSON.stringify(state.rcImgCache)); }
    async function fetchRcImage(name, rcSlug, imageOverride){
      // Priority: explicit image URL > cached > try endpoints > local pattern fallback
      if (imageOverride) return imageOverride;
      const keyName = rcSlug || name;
      if (state.rcImgCache[keyName]) return state.rcImgCache[keyName];

      const headers = RC.API_KEY ? { 'Authorization': 'Bearer '+RC.API_KEY } : {};
      const tryEndpoints = (RC.ENDPOINTS||[]).slice(0,4);

      for (const base of tryEndpoints){
        try{
          const q = encodeURIComponent(rcSlug || name);
          const r = await fetch(base+q, {headers, mode:'cors'});
          if (!r.ok) continue;
          const j = await r.json();
          // Attempt a few common shapes
          const cand =
            j?.items?.[0]?.image_url ||
            j?.items?.[0]?.image ||
            j?.results?.[0]?.image_url ||
            j?.results?.[0]?.image ||
            j?.[0]?.image_url ||
            j?.[0]?.image ||
            null;
          if (cand && /^https?:\/\//i.test(cand)){
            state.rcImgCache[keyName] = cand; saveImgCache(); return cand;
          }
        }catch(_){} // keep trying
      }
      // Local convention fallback: /images/djs/{slug}.jpg
      return RC.LOCAL_DJ_IMAGE_PREFIX ? (RC.LOCAL_DJ_IMAGE_PREFIX + (rcSlug||slugify(name)) + '.jpg') : '';
    }

    /* ====== Build UI ====== */
    function buildQueueForSelected(shuffle=false){
      const entry = state.entries[state.selected] || {};
      let vids = (entry.links||[]).map(ytId).filter(Boolean);
      if (shuffle){
        for (let i=vids.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [vids[i],vids[j]]=[vids[j],vids[i]]; }
      }
      state.queue = vids; state.qidx = 0;
    }

    function highlightQueue(){
      $$('.q-item', queueBox).forEach((el,i)=>{
        el.classList.toggle('active', i===state.qidx);
      });
      // highlight card stack too
      $$('.card', cardsBox).forEach((el,i)=> el.style.outline = (i===state.qidx?'2px solid var(--brand-teal)':'0'));
    }

    function renderQueue(){
      queueBox.innerHTML = '';
      const entry = state.entries[state.selected] || {name:'—'};
      state.queue.forEach((vid,i)=>{
        const qi = document.createElement('div');
        qi.className = 'q-item';
        qi.innerHTML = `<div class="idx-dot">${i+1}</div><div>${entry.name}</div>`;
        qi.addEventListener('click', ()=> playAtIndex(i,true), {passive:true});
        queueBox.appendChild(qi);
      });
      highlightQueue();
    }

    async function renderCards(){
      cardsBox.innerHTML = '';
      const entry = state.entries[state.selected] || {};
      const name = entry.name || 'Untitled';

      // Fetch DJ image for small overlay thumb when needed (not critical)
      for (let i=0;i<Math.min(5,(entry.links||[]).length);i++){
        const u = entry.links[i]; const id = ytId(u); if (!id) continue;
        const card = document.createElement('div'); card.className='card';
        const t = document.createElement('div'); t.className='thumb'; t.style.backgroundImage=`url('https://i.ytimg.com/vi/${id}/hqdefault.jpg')`;
        const meta = document.createElement('div'); meta.className='meta';
        meta.innerHTML = `<div class="title">Clip ${i+1}</div><div class="sub">${name}</div>`;
        const play = document.createElement('button'); play.className='btn'; play.innerHTML='▶';
        play.addEventListener('click', ()=> { state.qidx = i; playAtIndex(i,true); }, {passive:true});
        card.appendChild(t); card.appendChild(meta); card.appendChild(play);
        cardsBox.appendChild(card);
      }
      highlightQueue();
    }

    async function renderDjGallery(){
      djGrid.innerHTML = '';
      const promises = [];
      state.entries.forEach((e, idx)=>{
        const tile = document.createElement('div');
        tile.className = 'dj-tile'; tile.setAttribute('role','listitem');
        const label = document.createElement('div'); label.className='dj-name'; label.textContent = e.name || 'Untitled';
        tile.appendChild(label);
        tile.addEventListener('click', ()=>{
          state.selected = idx;
          $$('.dj-tile', djGrid).forEach(el=>el.classList.remove('active'));
          tile.classList.add('active');
          buildQueueForSelected(false);
          renderCards(); renderQueue(); playAtIndex(0,false);
        }, {passive:true});
        promises.push(
          fetchRcImage(e.name, e.rcSlug, e.image).then(url=>{
            if (url) tile.style.backgroundImage = `url('${url.replace(/'/g,"%27")}')`;
          })
        );
        djGrid.appendChild(tile);
        if (idx===state.selected) tile.classList.add('active');
      });
      await Promise.allSettled(promises);
    }

    function renderMobileAccordion(){
      const acc = $('#djAccordion');
      if (!acc) return;
      // show block on mobile (CSS adds padding to main already)
      if (window.matchMedia('(max-width: 980px)').matches) acc.style.display='block';
      else acc.style.display='none';

      acc.innerHTML = '';
      state.entries.forEach((e,idx)=>{
        const d = document.createElement('details');
        const sum = document.createElement('summary'); sum.textContent = e.name || 'Untitled';
        d.appendChild(sum);

        const inner = document.createElement('div'); inner.className='acc-inner';
        (e.links||[]).slice(0,5).forEach((u,i)=>{
          const id = ytId(u); if (!id) return;
          const row = document.createElement('div'); row.className='acc-card';
          const th = document.createElement('div'); th.className='acc-thumb'; th.style.backgroundImage = `url('https://i.ytimg.com/vi/${id}/hqdefault.jpg')`;
          const ttl = document.createElement('div'); ttl.className='acc-title'; ttl.textContent = `Clip ${i+1}`;
          row.appendChild(th); row.appendChild(ttl);
          row.addEventListener('click', ()=>{
            state.selected = idx; buildQueueForSelected(false); renderQueue();
            // play and open mini player cue
            playAtIndex(i,true);
            // ensure the mini shows correct text
            updateMiniMeta();
          }, {passive:true});
          inner.appendChild(row);
        });
        d.appendChild(inner);
        acc.appendChild(d);
      });
    }

    function firstPlayable(){
      for (let i=0;i<state.entries.length;i++){
        const links = state.entries[i]?.links||[];
        if (links.some(u=>ytId(u))) return i;
      }
      return 0;
    }

    /* ===== Load / Save config (server & local) ===== */
    async function serverLoad(){
      try{
        const r = await fetch(`${CFG.CONFIG_ENDPOINT}?action=load`, {cache:'no-store'});
        if (r.ok){ const j = await r.json(); if (Array.isArray(j?.entries)) return j.entries; }
      }catch(_){}
      try{
        const r = await fetch('cutty-ranks-data.json', {cache:'no-store'});
        if (r.ok){ const j = await r.json(); if (Array.isArray(j?.entries)) return j.entries; }
      }catch(_){}
      try{
        const s = localStorage.getItem('cutty_ranks_entries'); if (s){ const a = JSON.parse(s); if (Array.isArray(a)) return a; }
      }catch(_){}
      return [];
    }
    async function serverSave(entries){
      const r = await fetch(CFG.CONFIG_ENDPOINT+'?action=save', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({entries, auth: CFG.ADMIN_HASH_HEX})
      });
      const txt = await r.text(); let j=null; try{ j=JSON.parse(txt);}catch{}
      if(!r.ok || !(j&&j.ok)) throw new Error(j?.error ? ('Server error: '+j.error) : ('HTTP '+r.status+' '+txt.slice(0,180)));
      return j.entries || entries;
    }

    /* ===== Admin (Shift+A) ===== */
    function entryRow(data={}){
      const wrap = document.createElement('div'); wrap.className='entry';
      wrap.innerHTML = `
        <div class="row"><label>DJ</label><input type="text" class="djName" placeholder="Name"></div>
        <div class="row"><label>RC Slug</label><input type="text" class="rcSlug" placeholder="radiocult slug (optional)"></div>
        <div class="row"><label>Image URL</label><input type="text" class="imgUrl" placeholder="override image URL (optional)"></div>
        <div class="row"><label>Link 1</label><input type="text" class="l l1" placeholder="YouTube URL"></div>
        <div class="row"><label>Link 2</label><input type="text" class="l l2" placeholder="YouTube URL"></div>
        <div class="row"><label>Link 3</label><input type="text" class="l l3" placeholder="YouTube URL"></div>
        <div class="row"><label>Link 4</label><input type="text" class="l l4" placeholder="YouTube URL"></div>
        <div class="row"><label>Link 5</label><input type="text" class="l l5" placeholder="YouTube URL"></div>
        <div class="row"><button class="delBtn"><i class="fa fa-trash"></i>&nbsp; Remove DJ</button></div>
      `;
      wrap.querySelector('.djName').value = data.name || '';
      wrap.querySelector('.rcSlug').value = data.rcSlug || '';
      wrap.querySelector('.imgUrl').value = data.image || '';
      (data.links||[]).slice(0,5).forEach((u,i)=> wrap.querySelector('.l'+(i+1)).value = u);
      wrap.querySelector('.delBtn').addEventListener('click', () => { wrap.remove(); }, {passive:true});
      return wrap;
    }
    function openAdmin(){
      adminEntriesBox.innerHTML = '';
      (state.entries || []).forEach(e => adminEntriesBox.appendChild(entryRow(e)));
      adminOverlay.classList.remove('adminHidden'); adminOverlay.setAttribute('aria-hidden','false');
      adminStatus.textContent = '';
    }
    function closeAdmin(){
      adminOverlay.classList.add('adminHidden'); adminOverlay.setAttribute('aria-hidden','true');
    }
    adminCloseBtn.addEventListener('click', closeAdmin, {passive:true});
    addEntryBtn.addEventListener('click', ()=> adminEntriesBox.appendChild(entryRow()), {passive:true});
    clearImgCache.addEventListener('click', ()=>{ localStorage.removeItem('rc_img_cache'); loadImgCache(); adminStatus.textContent='Image cache cleared.'; });

    adminSaveBtn.addEventListener('click', async ()=>{
      const entries = $$('.entry', adminEntriesBox).map(box => {
        const name = box.querySelector('.djName').value.trim();
        const rcSlug= box.querySelector('.rcSlug').value.trim();
        const image = box.querySelector('.imgUrl').value.trim();
        const links = $$('.l', box).map(i=>i.value.trim()).filter(Boolean).slice(0,5);
        return name || rcSlug || image || links.length ? {name, rcSlug, image, links} : null;
      }).filter(Boolean);
      if(!entries.length){ adminStatus.textContent='Nothing to save.'; return; }

      const ok = (u)=>/^https?:\/\/(www\.)?(youtube\.com|youtu\.be)\//i.test(u);
      for(const e of entries){
        if(!e.name){ adminStatus.textContent='Each DJ needs a name.'; return; }
        if(e.links.some(u=>!ok(u))) { adminStatus.textContent='Only YouTube links supported.'; return; }
      }

      adminStatus.textContent='Saving…';
      try{
        const saved = await serverSave(entries);
        state.entries = saved;
        localStorage.setItem('cutty_ranks_entries', JSON.stringify(saved));
        await postLoadRender();
        adminStatus.textContent='Saved.';
      }catch(err){
        console.error(err);
        state.entries = entries;
        localStorage.setItem('cutty_ranks_entries', JSON.stringify(entries));
        await postLoadRender();
        adminStatus.textContent='Saved locally (check server).';
      }
    });

    function isTypingTarget(el){
      if (!el) return false;
      const tag = el.tagName;
      return tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT' || el.isContentEditable;
    }
    window.addEventListener('keydown', async (e)=>{
      const key = (e.key || '').toLowerCase();
      const isShiftA = e.shiftKey && (key === 'a' || e.code === 'KeyA');
      if (!isShiftA) return;
      if (isTypingTarget(document.activeElement)) return;

      e.preventDefault();
      if(!state.authed){
        const pw = prompt('Enter passphrase'); if(!pw) return;
        try{
          const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pw));
          const hex = [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
          if(hex===CFG.ADMIN_HASH_HEX){ state.authed=true; openAdmin(); } else alert('Incorrect passphrase');
        }catch(err){ console.warn('digest error', err); }
      } else openAdmin();
    }, true);

    function adminWantedFromURL(){ const p=new URLSearchParams(location.search); return p.get('admin')==='1' || location.hash==='#admin'; }

    /* ===== Playlist control buttons ===== */
    playAllBtn.addEventListener('click', ()=>{ buildQueueForSelected(false); renderQueue(); playAtIndex(0,true); }, {passive:true});
    shuffleBtn.addEventListener('click', ()=>{ buildQueueForSelected(true); renderQueue(); playAtIndex(0,true); }, {passive:true});

    /* ===== Mini player controls ===== */
    mpPrev.addEventListener('click', ()=>{ if (state.qidx>0){ state.qidx--; playAtIndex(state.qidx,true);} }, {passive:true});
    mpNext.addEventListener('click', ()=>{ if (state.qidx<state.queue.length-1){ state.qidx++; playAtIndex(state.qidx,true);} }, {passive:true});
    mpPP.addEventListener('click', ()=>{
      try{
        const s = state.player?.getPlayerState?.();
        if (s===YT.PlayerState.PLAYING) state.player.pauseVideo();
        else state.player.playVideo();
      }catch{}
    }, {passive:true});

    /* ===== Boot ===== */
    async function postLoadRender(){
      loadImgCache();
      if (!state.entries.length) state.entries = [];
      state.selected = firstPlayable();
      await renderDjGallery();
      buildQueueForSelected(false);
      await renderCards();
      renderQueue();
      playAtIndex(0,false);
      renderMobileAccordion();
      setHeights();
      if (adminWantedFromURL()){
        const pw = prompt('Enter passphrase');
        if (pw) {
          const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pw));
          const hex = [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
          if(hex===CFG.ADMIN_HASH_HEX){ state.authed=true; openAdmin(); } else alert('Incorrect passphrase');
        }
      }
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      // Show mini bar on mobile always (it will show placeholder until play)
      if (window.matchMedia('(max-width: 980px)').matches) mpBar.style.display='grid';
      state.entries = await serverLoad();
      await postLoadRender();
    });
  })();
  </script>
</body>
</html>
