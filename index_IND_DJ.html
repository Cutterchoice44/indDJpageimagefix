<?php
// rc-proxy.php â€” small proxy for external metadata requests
// Supports: ?fn=bandcamp_oembed&url=...

declare(strict_types=1);
header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-store');

function out($arr, int $code = 200) {
  http_response_code($code);
  echo json_encode($arr, JSON_UNESCAPED_SLASHES|JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT);
  exit;
}

$fn = strtolower($_GET['fn'] ?? '');

if ($fn === 'bandcamp_oembed') {
  $url = trim((string)($_GET['url'] ?? ''));
  if ($url === '' || !preg_match('~^https?://[^/]*bandcamp\.com/.*~i', $url)) {
    out(['ok' => false, 'error' => 'Invalid Bandcamp URL'], 400);
  }

  $endpoint = 'https://bandcamp.com/oembed?format=json&url=' . urlencode($url);

  // Use cURL for reliability on shared hosts
  $ch = curl_init($endpoint);
  curl_setopt_array($ch, [
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_FOLLOWLOCATION => true,
    CURLOPT_CONNECTTIMEOUT => 6,
    CURLOPT_TIMEOUT => 10,
    CURLOPT_USERAGENT => 'CCR-DJ-Selects/1.0 (+https://cutterschoiceradio.com/)',
  ]);
  $resp = curl_exec($ch);
  $err  = curl_error($ch);
  $code = (int)curl_getinfo($ch, CURLINFO_HTTP_CODE);
  curl_close($ch);

  if ($resp === false || $code < 200 || $code >= 300) {
    out(['ok' => false, 'error' => 'Bandcamp fetch failed', 'http' => $code, 'detail' => $err], 502);
  }

  // Return Bandcamp's JSON straight through
  echo $resp;
  exit;
}

out(['ok' => false, 'error' => 'Unknown function'], 400);
