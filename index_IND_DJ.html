<?php
/**
 * Cutters Choice Radio — Radio Cult API proxy
 *
 * Why a proxy?
 * - Keeps your API key out of client JS
 * - Normalizes response shape (always JSON)
 * - Adds short caching and CORS
 *
 * Usage examples:
 *   /rc-proxy.php?fn=presenters&stationId=cutters-choice-radio
 *   /rc-proxy.php?fn=presenter_schedule&stationId=cutters-choice-radio&presenterId=abc123&startDate=2025-01-01T00:00:00Z&endDate=2026-01-01T00:00:00Z
 *   /rc-proxy.php?fn=artists&stationId=cutters-choice-radio
 *   /rc-proxy.php?fn=artist_schedule&stationId=cutters-choice-radio&artistId=abc123&startDate=...&endDate=...
 *   /rc-proxy.php?fn=upcoming&stationId=cutters-choice-radio&limit=50
 *   /rc-proxy.php?fn=schedule_range&stationId=cutters-choice-radio&startDate=...&endDate=...
 *
 * Provide the key either as ?key=pk_xxx or set env RC_PUBLISHABLE_KEY.
 */

header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');
header('Vary: Origin');
header('Cache-Control: public, max-age=60, s-maxage=60');

$envKey = getenv('RC_PUBLISHABLE_KEY');  // optional, can be set server-side
$key    = $_GET['key'] ?? $envKey ?? '';
$fn     = $_GET['fn'] ?? '';
$stationId = $_GET['stationId'] ?? '';

$startDate = $_GET['startDate'] ?? ($_GET['from'] ?? '');
$endDate   = $_GET['endDate']   ?? ($_GET['to']   ?? '');
$artistId      = $_GET['artistId'] ?? '';
$presenterId   = $_GET['presenterId'] ?? '';
$limit = isset($_GET['limit']) ? (int)$_GET['limit'] : 50;
$limit = max(1, min(200, $limit));

/* ---------- validation ---------- */

// publishable key (pk_...) — allow empty only for local tests
if ($key !== '' && !preg_match('/^pk_[A-Za-z0-9]+$/', $key)) {
  http_response_code(400);
  echo json_encode(['error' => 'bad_key']);
  exit;
}

// station id like "cutters-choice-radio"
if ($stationId === '' || !preg_match('/^[a-z0-9-_.]{3,}$/i', $stationId)) {
  http_response_code(400);
  echo json_encode(['error' => 'bad_stationId']);
  exit;
}

// id format used by RC (alphanumeric + _ -)
$validId = '/^[A-Za-z0-9_-]{4,}$/';

/* ---------- route mapping ---------- */

$base = "https://api.radiocult.fm/api/station/" . rawurlencode($stationId);
$url  = null;

switch ($fn) {
  /* People listings */
  case 'presenters':
    $url = "$base/presenters";
    break;

  case 'artists':
    $url = "$base/artists";
    break;

  /* Individual schedules */
  case 'presenter_schedule':
    if ($presenterId === '' || !preg_match($validId, $presenterId)) {
      http_response_code(400); echo json_encode(['error'=>'bad_presenterId']); exit;
    }
    if ($startDate === '' || $endDate === '') {
      http_response_code(400); echo json_encode(['error'=>'missing_dates']); exit;
    }
    $url = "$base/presenters/" . rawurlencode($presenterId)
         . "/schedule?startDate=" . rawurlencode($startDate)
         . "&endDate=" . rawurlencode($endDate);
    break;

  case 'artist_schedule':
    if ($artistId === '' || !preg_match($validId, $artistId)) {
      http_response_code(400); echo json_encode(['error'=>'bad_artistId']); exit;
    }
    if ($startDate === '' || $endDate === '') {
      http_response_code(400); echo json_encode(['error'=>'missing_dates']); exit;
    }
    $url = "$base/artists/" . rawurlencode($artistId)
         . "/schedule?startDate=" . rawurlencode($startDate)
         . "&endDate=" . rawurlencode($endDate);
    break;

  /* Station schedules */
  case 'schedule_live':
    $url = "$base/schedule/live";
    break;

  case 'upcoming':
    // expand=artist helps name matching on the front-end
    $url = "$base/schedule/upcoming?limit=$limit&expand=artist";
    break;

  case 'schedule_range':
    if ($startDate === '' || $endDate === '') {
      http_response_code(400); echo json_encode(['error'=>'missing_dates']); exit;
    }
    $url = "$base/schedule?startDate=" . rawurlencode($startDate)
         . "&endDate=" . rawurlencode($endDate)
         . "&expand=artist";
    break;

  default:
    http_response_code(400);
    echo json_encode(['error' => 'bad_fn', 'allowed' =>
      ['presenters','presenter_schedule','artists','artist_schedule','schedule_live','upcoming','schedule_range']
    ]);
    exit;
}

/* ---------- upstream call ---------- */

$ch = curl_init($url);
$headers = ['Accept: application/json'];
if ($key !== '') { $headers[] = 'x-api-key: ' . $key; }

curl_setopt_array($ch, [
  CURLOPT_RETURNTRANSFER => true,
  CURLOPT_HTTPHEADER     => $headers,
  CURLOPT_USERAGENT      => 'CuttersChoiceRadio-Proxy/3.0',
  CURLOPT_TIMEOUT        => 15,
  CURLOPT_CONNECTTIMEOUT => 8,
]);

$out  = curl_exec($ch);
$http = curl_getinfo($ch, CURLINFO_HTTP_CODE);
$err  = curl_error($ch);
curl_close($ch);

if ($out === false) {
  http_response_code(502);
  echo json_encode(['error' => 'proxy_failed', 'detail' => $err, 'upstream' => $url]);
  exit;
}

/* ---------- normalize to JSON ---------- */

$decoded = json_decode($out, true);
if ($decoded === null && json_last_error() !== JSON_ERROR_NONE) {
  // Upstream might have returned HTML (e.g., an error page).
  http_response_code($http ?: 200);
  echo json_encode([
    'error'  => 'upstream_non_json',
    'status' => $http,
    'body'   => substr($out, 0, 4000)  // truncate to be safe
  ]);
  exit;
}

/* ---------- success ---------- */

http_response_code($http ?: 200);
echo json_encode($decoded, JSON_UNESCAPED_SLASHES);
