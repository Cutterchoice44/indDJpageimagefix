<?php
// rc-proxy.php
header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-store, must-revalidate');
header('Access-Control-Allow-Origin: *');

$fn  = isset($_GET['fn'])  ? $_GET['fn']  : '';
$url = isset($_GET['url']) ? $_GET['url'] : '';

if ($fn !== 'bandcamp_oembed' || !$url) {
  http_response_code(400);
  echo json_encode(['error'=>'Bad request'], JSON_UNESCAPED_SLASHES);
  exit;
}

// Allow only Bandcamp
if (!preg_match('~^https?://([a-z0-9-]+\.)*bandcamp\.com/.*$~i', $url)) {
  http_response_code(400);
  echo json_encode(['error'=>'Only Bandcamp URLs are allowed'], JSON_UNESCAPED_SLASHES);
  exit;
}

$endpoint = 'https://bandcamp.com/oembed?format=json&url=' . rawurlencode($url);

// Fetch
$ch = curl_init($endpoint);
curl_setopt_array($ch, [
  CURLOPT_RETURNTRANSFER => true,
  CURLOPT_FOLLOWLOCATION => true,
  CURLOPT_CONNECTTIMEOUT => 6,
  CURLOPT_TIMEOUT        => 10,
  CURLOPT_USERAGENT      => 'CCR-Proxy/1.0'
]);
$body = curl_exec($ch);
$err  = curl_error($ch);
$code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

if ($body === false || $code >= 400) {
  http_response_code(502);
  echo json_encode(['error'=>'Upstream error','status'=>$code,'detail'=>$err], JSON_UNESCAPED_SLASHES);
  exit;
}

echo $body;
