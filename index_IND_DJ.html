<?php
/**
 * dj-selects-config.php — simple config store for DJ Selects
 * GET  ?action=load
 * POST ?action=save   body: {"token":"...","data":{...}}
 */
declare(strict_types=1);

header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-store, must-revalidate');
header('Access-Control-Allow-Origin: *');

$DATA_FILE    = __DIR__ . '/dj-selects-data.json';
$SERVER_TOKEN = 'CCR_TEMP_TOKEN_!2025';   // must match SAVE_TOKEN in the HTML

function out($arr, $code=200){ http_response_code($code); echo json_encode($arr, JSON_UNESCAPED_SLASHES); exit; }

$action = $_GET['action'] ?? '';
if ($action === 'load') {
  if (!is_file($DATA_FILE)) out([]);
  $raw = @file_get_contents($DATA_FILE);
  if ($raw === false) out(['error'=>'read_failed'], 500);
  $json = json_decode($raw, true);
  // don’t leak anything unexpected
  $allow = ['djName','profileImage','stationId','tracks','apiKey'];
  $safe  = array_intersect_key((array)$json, array_flip($allow));
  out($safe ?: []);
}

if ($action === 'save') {
  $body = json_decode(file_get_contents('php://input') ?: '[]', true);
  $token = $body['token'] ?? '';
  if ($token !== $SERVER_TOKEN) out(['error'=>'forbidden'], 403);

  $data = $body['data'] ?? [];
  if (!is_array($data)) out(['error'=>'bad_data'], 400);

  // whitelist keys
  $allow = ['djName','profileImage','stationId','tracks','apiKey'];
  $clean = array_intersect_key($data, array_flip($allow));

  // basic normalisation
  $clean['djName']       = trim((string)($clean['djName'] ?? 'DJ NAME'));
  $clean['profileImage'] = trim((string)($clean['profileImage'] ?? '/images/default-dj.png'));
  $clean['stationId']    = trim((string)($clean['stationId'] ?? 'cutters-choice-radio'));
  $clean['tracks']       = array_values(array_slice(array_filter((array)($clean['tracks'] ?? []), 'strlen'), 0, 5));

  $tmp = $DATA_FILE . '.tmp';
  if (@file_put_contents($tmp, json_encode($clean, JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES)) === false)
    out(['error'=>'write_failed'], 500);

  @rename($tmp, $DATA_FILE);
  @chmod($DATA_FILE, 0644);
  out(['ok'=>true]);
}

out(['error'=>'bad_action'], 400);
