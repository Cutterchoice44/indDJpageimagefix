<?php
/**
 * Radio Cult proxy for DJ Selects (server-side, avoids 403/CORS)
 * Supports: artists, presenters, upcoming, artist_schedule, presenter_schedule, ping
 */
declare(strict_types=1);

header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-store, must-revalidate');
header('Access-Control-Allow-Origin: *');

$RC_BASE = 'https://api.radiocult.fm/api';

/* ---- SET YOUR PUBLISHABLE RC KEY ----
   Option A (quick): put it here
*/
$RC_API_KEY = ''; // e.g. 'pk_abc123...'

/* Option B (safer): set an env var RC_PUBLISHABLE_KEY in your hosting panel */
if (!$RC_API_KEY) {
  $env = getenv('RC_PUBLISHABLE_KEY');
  if ($env) $RC_API_KEY = $env;
}

/* (optional) allow ?key= for quick testing */
if (!$RC_API_KEY && isset($_GET['key'])) {
  $RC_API_KEY = $_GET['key'];
}

$fn        = $_GET['fn']        ?? 'ping';
$stationId = $_GET['stationId'] ?? '';
$limit     = isset($_GET['limit']) ? max(1, (int)$_GET['limit']) : 50;
$expand    = $_GET['expand']    ?? '';

if ($fn === 'ping') { echo json_encode(['ok'=>true]); exit; }
if (!$stationId && $fn !== 'ping') { http_response_code(400); echo json_encode(['error'=>'stationId_required']); exit; }

function build_url($base, $path, $qs=[]) {
  $q = http_build_query(array_filter($qs, fn($v)=>$v!=='' && $v!==null));
  return rtrim($base, '/') . $path . ($q ? ('?' . $q) : '');
}

switch ($fn) {
  case 'artists':
    $upstream = build_url($RC_BASE, '/station/' . rawurlencode($stationId) . '/artists');
    break;
  case 'presenters':
    $upstream = build_url($RC_BASE, '/station/' . rawurlencode($stationId) . '/presenters');
    break;
  case 'upcoming':
    $upstream = build_url($RC_BASE, '/station/' . rawurlencode($stationId) . '/upcoming', ['limit'=>$limit, 'expand'=>$expand]);
    break;
  case 'artist_schedule':
    $artistId  = $_GET['artistId']  ?? '';
    $startDate = $_GET['startDate'] ?? '';
    $endDate   = $_GET['endDate']   ?? '';
    if (!$artistId) { http_response_code(400); echo json_encode(['error'=>'artistId_required']); exit; }
    $upstream = build_url($RC_BASE, '/station/' . rawurlencode($stationId) . '/artists/' . rawurlencode($artistId) . '/schedule', ['startDate'=>$startDate,'endDate'=>$endDate]);
    break;
  case 'presenter_schedule':
    $presenterId  = $_GET['presenterId']  ?? '';
    $startDate = $_GET['startDate'] ?? '';
    $endDate   = $_GET['endDate']   ?? '';
    if (!$presenterId) { http_response_code(400); echo json_encode(['error'=>'presenterId_required']); exit; }
    $upstream = build_url($RC_BASE, '/station/' . rawurlencode($stationId) . '/presenters/' . rawurlencode($presenterId) . '/schedule', ['startDate'=>$startDate,'endDate'=>$endDate]);
    break;
  default:
    http_response_code(400); echo json_encode(['error'=>'bad_fn']); exit;
}

$ch = curl_init($upstream);
curl_setopt_array($ch, [
  CURLOPT_RETURNTRANSFER => true,
  CURLOPT_FOLLOWLOCATION => true,
  CURLOPT_TIMEOUT        => 15,
  CURLOPT_HTTPHEADER     => array_filter([
    'Accept: application/json',
    $RC_API_KEY ? 'x-api-key: '.$RC_API_KEY : null,
  ]),
]);

$resp = curl_exec($ch);
$code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
$err  = curl_error($ch);
curl_close($ch);

if ($resp === false || $code >= 400) {
  http_response_code(502);
  echo json_encode(['error'=>'upstream_error','status'=>$code,'detail'=>$err ?: $resp]);
  exit;
}

echo $resp;
