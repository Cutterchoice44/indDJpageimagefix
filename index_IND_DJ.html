<?php
// dj-selects-config.php
// Load and save up to 5 track URLs.
// GET  ?action=load → { "tracks":[...] }
// POST ?action=save with JSON { "tracks":[...], "auth":"<hex>" } → { "ok":true, "tracks":[...] }

header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-store, must-revalidate');
header('Access-Control-Allow-Origin: *');

$STORE = __DIR__ . '/dj-selects-config.json';
$ADMIN_HASH_HEX = '446b03243337b8bb55581f2c94647468d02b9dc09aa07968701be1f65071599e';

$action = isset($_GET['action']) ? strtolower($_GET['action']) : 'load';

function safe_tracks($arr){
  $out = [];
  foreach ((array)$arr as $u) {
    $u = trim((string)$u);
    if ($u === '') continue;
    if (!preg_match('~^https?://~i', $u)) continue; // http(s) only
    $out[] = $u;
  }
  return array_values(array_unique($out));
}

if ($action === 'load') {
  if (!is_file($STORE)) {
    @file_put_contents($STORE, json_encode(['tracks'=>[]], JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES));
  }
  $data = json_decode(@file_get_contents($STORE), true);
  if (!is_array($data)) $data = ['tracks'=>[]];
  $data['tracks'] = safe_tracks($data['tracks'] ?? []);
  echo json_encode(['tracks'=>$data['tracks']], JSON_UNESCAPED_SLASHES);
  exit;
}

if ($action === 'save') {
  // Accept JSON or form-encoded
  $raw = file_get_contents('php://input');
  $body = json_decode($raw, true);
  if (!is_array($body)) $body = $_POST;

  $auth = isset($body['auth']) ? (string)$body['auth'] : '';
  if ($auth !== $ADMIN_HASH_HEX) {
    http_response_code(403);
    echo json_encode(['error'=>'Forbidden'], JSON_UNESCAPED_SLASHES);
    exit;
  }

  $tracks = safe_tracks($body['tracks'] ?? []);
  $ok = @file_put_contents($STORE, json_encode(['tracks'=>$tracks], JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES));
  if ($ok === false) {
    http_response_code(500);
    echo json_encode(['error'=>'Write failed (check file permissions on dj-selects-config.json)'], JSON_UNESCAPED_SLASHES);
    exit;
  }
  echo json_encode(['ok'=>true, 'tracks'=>$tracks], JSON_UNESCAPED_SLASHES);
  exit;
}

http_response_code(400);
echo json_encode(['error'=>'Unsupported action'], JSON_UNESCAPED_SLASHES);
