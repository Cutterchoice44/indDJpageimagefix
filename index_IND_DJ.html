<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cutty Ranks ‚Äî Cutters Choice Radio</title>

  <!-- SEO -->
  <meta name="description" content="Cutty Ranks: the best-of archive ‚Äî YouTube picks from Cutters Choice Radio selectors.">
  <meta name="robots" content="index, follow">
  <meta name="theme-color" content="#5A8785">

  <!-- Social preview -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Cutty Ranks ‚Äî Cutters Choice Radio">
  <meta property="og:description" content="A best-of archive of YouTube selections from the CCR crew.">
  <meta property="og:url" content="https://cutterschoiceradio.com/cutty-ranks.html">
  <meta property="og:site_name" content="Cutters Choice Radio">
  <meta property="og:image" content="https://cutterschoiceradio.com/images/logo.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Cutty Ranks ‚Äî Cutters Choice Radio">
  <meta name="twitter:description" content="A best-of archive of YouTube selections from the CCR crew.">
  <meta name="twitter:image" content="https://cutterschoiceradio.com/images/logo.png">

  <!-- Performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.youtube-nocookie.com" crossorigin>

  <!-- Global site styles -->
  <link rel="stylesheet" href="/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root{
      --brand-teal:#5A8785;
      --ink:#eaffff; --ink-d:#bfe7e4;
      --line:#264745;
      --gap:14px;
      --usable:70vh;
    }

    /* ===== Header & Nav (KEEPING your artwork/titles) ===== */
    .header-banner{
      position:relative; display:flex; align-items:center; justify-content:center;
      padding:clamp(16px,3vw,28px) .6rem;
      background:#000 center/cover no-repeat;
      background-image:url('/images/cutty_a.png');
      border-top:2px solid #000; border-bottom:2px solid #000; isolation:isolate;
    }
    .header-banner .title{ text-align:center; }
    .header-banner .title h1{
      margin:0; font-family:'Bebas Neue',sans-serif;
      font-size:clamp(2.3rem,6.2vw,4rem); line-height:1; color:#fff;
      text-shadow:0 2px 12px rgba(0,0,0,.6);
    }
    .header-banner .title .tagline{ margin:.2rem 0 0; color:#fff; text-shadow:0 2px 10px rgba(0,0,0,.6); }
    .header-gif-right,.header-gif-left,.header-wave,.logo-container{ display:none !important; }
    .nav-sep{height:2px;background-color:var(--brand-teal);}

    /* Site nav (unchanged visuals) */
    #main-nav .nav-menu{ justify-content: space-evenly !important; }
    #main-nav .nav-link, #main-nav summary.nav-link{
      color:#fff !important; font-family:'Bebas Neue',sans-serif !important;
      font-size:2rem !important; text-transform:uppercase !important;
      text-decoration:none !important; white-space:nowrap !important;
      list-style:none !important; cursor:pointer !important; display:inline-flex; align-items:center;
    }
    .nav-details{ position:relative; }
    .nav-details .about-panel{
      position:absolute; top:calc(100% + 8px); right:0; width:min(520px,86vw);
      background:#000; color:#fff; border:2px solid var(--brand-teal);
      border-radius:8px; padding:.75rem .9rem; line-height:1.35;
      box-shadow:0 8px 18px rgba(0,0,0,.45); display:none; z-index:1100;
    }
    .nav-details[open] .about-panel{ display:block; }
    .nav-details > summary::-webkit-details-marker{ display:none; }

    @media (max-width:768px){
      body.cutty nav#main-nav{
        display:flex !important; flex-direction:row !important; align-items:center !important;
        justify-content:space-between !important; padding:.40rem .65rem !important;
      }
      body.cutty nav#main-nav .nav-menu{
        display:flex !important; gap:.35rem !important; flex-wrap:nowrap !important;
        overflow-x:auto !important; white-space:nowrap !important; scrollbar-width:none;
      }
      body.cutty nav#main-nav .nav-menu::-webkit-scrollbar{ display:none; }
      body.cutty nav#main-nav .nav-link, body.cutty nav#main-nav summary.nav-link{
        font-size:clamp(.8rem,3.2vw,1rem) !important; padding:.2rem .25rem !important;
      }
      .nav-sep{ display:none !important; }
    }

    /* ----- Title band (KEEPING your image) ----- */
    .cutty-title{
      position:relative; border-top:2px solid var(--brand-teal); border-bottom:2px solid var(--brand-teal);
      min-height:110px; display:flex; align-items:center; justify-content:flex-start;
      padding:.35rem .6rem; background: url('/images/cutty_b.png') right center / contain no-repeat, #000;
    }
    .cutty-title::before{
      content:""; position:absolute; inset:0;
      background:linear-gradient(90deg, rgba(0,0,0,.55), rgba(0,0,0,.25) 35%, rgba(0,0,0,0));
      pointer-events:none;
    }
    .cutty-title h2{
      position:relative; z-index:1; color:#fff; font-family:'Bebas Neue',sans-serif;
      font-size:clamp(2.6rem,5.2vw,3.6rem); line-height:1; margin:0; letter-spacing:.6px;
      text-shadow:0 2px 10px rgba(0,0,0,.65);
    }

    /* ===== Concept 4 layout ===== */
    .c4-grid{
      display:grid; gap:var(--gap);
      /* viewer column made WIDER; stack also widened */
      grid-template-columns:
        minmax(380px, 1.1fr)   /* Left ‚Äî DJ tiles (big squares) */
        minmax(640px, 1.2fr)   /* Center ‚Äî wider cards */
        minmax(880px, 1.6fr);  /* Right ‚Äî larger viewer */
      align-items:start; padding:.6rem;
    }

    /* LEFT: DJ big squares, scrollable as list grows */
    .dj-gallery{ background:#000; border:2px solid var(--line); border-radius:10px; padding:12px; height:var(--usable); overflow:auto; }
    .dj-grid{ display:grid; grid-template-columns:repeat(2, minmax(160px,1fr)); gap:12px; }
    @media (min-width:1600px){ .dj-grid{ grid-template-columns:repeat(3, minmax(160px,1fr)); } }
    .dj-tile{
      position:relative; border:1px solid #1d3533; border-radius:14px; overflow:hidden;
      background:#0a0a0a center/cover no-repeat; aspect-ratio:1/1; cursor:pointer;
      transition:transform .08s ease-in-out, box-shadow .12s ease-in-out, outline .08s;
    }
    .dj-tile:hover{ transform:translateY(-1px); box-shadow:0 12px 26px rgba(0,0,0,.35); }
    .dj-tile.active{ outline:2px solid var(--brand-teal); outline-offset:-2px; }
    .dj-name{ position:absolute; left:0; right:0; bottom:0; padding:.5rem .6rem;
      background:linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,.78) 60%);
      color:#fff; font-family:'Bebas Neue',sans-serif; font-size:1.35rem; letter-spacing:.5px; }

    /* CENTER: wider card stack */
    .stack{ background:#000; border:2px solid var(--line); border-radius:10px; padding:12px; height:var(--usable); display:flex; flex-direction:column; gap:12px; }
    .stack .stack-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .stack .btn{
      font:600 12px/1 system-ui; color:var(--ink); background:#0b2322; border:1px solid var(--brand-teal);
      border-radius:999px; padding:.5rem .7rem; cursor:pointer; margin-left:6px;
    }
    .cards{ display:flex; flex-direction:column; gap:12px; overflow:auto; }
    .card{
      display:grid; grid-template-columns:180px 1fr auto; gap:12px; align-items:center;
      padding:12px; border:1px solid #1d3533; border-radius:12px; background:#0a0a0a;
    }
    .thumb{ width:180px; aspect-ratio:16/9; border-radius:8px; background:#111 center/cover no-repeat; border:1px solid #122; overflow:hidden; }
    .meta .title{ color:#e7fbf9; font:600 15px/1.2 system-ui; margin:0 0 2px; }
    .meta .sub{ color:#86b8b5; font:12px/1.2 system-ui; }
    .card .play{ width:42px; height:42px; border-radius:999px; display:grid; place-items:center; background:rgba(255,255,255,.12); color:#fff; border:0; cursor:pointer; }

    /* RIGHT: Now Playing + full queue under it */
    .nowp{ background:#000; border:2px solid var(--line); border-radius:10px; padding:12px; height:var(--usable); display:flex; flex-direction:column; gap:12px; }
    .nowp h3{ font-family:'Bebas Neue',sans-serif; color:#fff; letter-spacing:.6px; margin:.2rem .2rem; }
    .player-shell{
      position:relative; background:#000 center/cover no-repeat; background-image:url('/images/cutty_c.png');
      border:1px solid var(--brand-teal); border-radius:8px; padding:6px; overflow:hidden;
    }
    #mainPreview iframe{ width:100%; aspect-ratio:16/9; height:auto; border:0; display:block; }

    .queue{ background:#060b0b; border:1px solid #1a2f2e; border-radius:8px; padding:8px; overflow:auto; height:100%; }
    .q-item{ display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:8px; cursor:pointer; color:#d7f9f6; }
    .q-item:hover{ background:#0c1716; }
    .q-item.active{ outline:1px dashed var(--brand-teal); outline-offset:-2px; }
    .q-num{ width:28px; height:28px; border-radius:999px; display:grid; place-items:center; background:#123; border:1px solid #2a5653; color:#bfe7e4; font:600 12px/1 system-ui; }
    .q-title{ flex:1 1 auto; }
    .q-who{ color:#86b8b5; font:12px/1.1 system-ui; margin-left:12px; white-space:nowrap; }

    /* Scrollbars */
    .dj-gallery::-webkit-scrollbar, .cards::-webkit-scrollbar, .queue::-webkit-scrollbar { width:10px; }
    .dj-gallery::-webkit-scrollbar-track, .cards::-webkit-scrollbar-track, .queue::-webkit-scrollbar-track { background:#061010; }
    .dj-gallery::-webkit-scrollbar-thumb, .cards::-webkit-scrollbar-thumb, .queue::-webkit-scrollbar-thumb { background:#274947; border-radius:10px; border:2px solid #061010; }

    /* ===== Admin overlay ===== */
    .adminHidden{ display:none !important; }
    #adminOverlay{ position:fixed; inset:0; background:rgba(0,0,0,.82); color:#fff; z-index:9999; display:flex; align-items:center; justify-content:center; }
    #adminPanel{ width:min(980px,95vw); max-height:92vh; overflow:auto; background:#0e1414; border:2px solid var(--brand-teal); border-radius:10px; padding:16px; box-shadow:0 12px 40px rgba(0,0,0,.55); }
    #adminPanel h3{ font-family:'Bebas Neue',sans-serif; letter-spacing:.5px; margin:0 0 10px; color:#fff; }
    #adminPanel .entry{ border:1px solid #2a5653; border-radius:8px; padding:10px; margin:10px 0; background:#081111; }
    #adminPanel .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:6px 0; }
    #adminPanel input[type="text"]{ flex:1 1 240px; min-width:200px; background:#050808; color:#eaffff; border:1px solid #2a5653; border-radius:6px; padding:8px; }
    #adminPanel label{ font-size:.95rem; opacity:.9; color:#fff; min-width:92px; }
    #adminPanel button{ padding:8px 12px; border-radius:6px; border:1px solid #2a5653; background:#0b2322; color:#eaffff; cursor:pointer; }
    #adminStatus{ opacity:.9; font-size:.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:52ch; margin-left:auto; }
    #clearImgCache{ margin-left:8px; }

    /* ===== Mobile: sticky mini player ===== */
    @media (max-width:1180px){
      .c4-grid{ grid-template-columns:1fr; gap:10px; padding:.5rem .6rem 4.7rem; }
      .dj-gallery,.stack,.nowp{ height:auto; }
    }
    #miniPlayer{
      position:fixed; left:0; right:0; bottom:0; z-index:1200; background:#0b1515; border-top:2px solid var(--brand-teal);
      display:none; grid-template-columns:auto 1fr auto auto; gap:10px; align-items:center; padding:10px 12px;
    }
    #miniPlayer .mp-thumb{ width:64px; aspect-ratio:16/9; border-radius:6px; background:#111 center/cover no-repeat; border:1px solid #122; }
    #miniPlayer .mp-title{ color:#eaffff; font:600 13px/1.2 system-ui; }
    #miniPlayer .mp-sub{ color:#86b8b5; font:12px/1.1 system-ui; }
    #miniPlayer .mp-btn{ width:36px; height:36px; border-radius:999px; border:1px solid #2a5653; background:#0b2322; color:#eaffff; display:grid; place-items:center; }
    @media (max-width:1180px){ #miniPlayer{ display:grid; } }
  </style>

  <!-- YouTube IFrame API -->
  <script src="https://www.youtube.com/iframe_api"></script>
</head>

<body class="cutty">
  <!-- HEADER (unchanged artwork) -->
  <header class="header-banner" role="banner">
    <div class="title">
      <h1>Cutters Choice Radio</h1>
      <p class="tagline">The home of relentless flavas and significant bangers!</p>
    </div>
  </header>

  <div class="nav-sep top"></div>

  <!-- Primary Nav -->
  <nav id="main-nav" aria-label="Primary">
    <div class="nav-menu">
      <a href="/" class="nav-link">HOME</a>
      <a href="/our-story.html" class="nav-link">OUR STORY</a>
      <a href="/index-ourDJS.html" class="nav-link">OUR DJS</a>
      <a href="/dj-selects.html" class="nav-link">DJ SELECTS</a>
      <a href="/schedule.html" class="nav-link">SCHEDULE</a>
      <a href="/merch.html" class="nav-link">MERCH</a>
      <details class="nav-details">
        <summary class="nav-link" aria-label="About Cutty Ranks">ABOUT CUTTY RANKS</summary>
        <div class="about-panel">
          <p>Concept-4 layout. Pick a DJ left, their stack in the middle, and watch on the right. Shift+A for Admin.</p>
        </div>
      </details>
    </div>
  </nav>

  <!-- Title band -->
  <section class="cutty-title">
    <h2>CUTTY RANKS: THE SELECTOR ARCHIVES</h2>
  </section>

  <!-- Concept 4 grid -->
  <main id="grid" class="c4-grid" role="main">
    <!-- LEFT: DJ Gallery -->
    <section class="dj-gallery" aria-label="Selectors">
      <div id="djGrid" class="dj-grid" role="list"></div>
    </section>

    <!-- CENTER: Stack -->
    <section class="stack" aria-label="Picks">
      <div class="stack-header">
        <h3 style="font-family:'Bebas Neue',sans-serif;color:#fff;letter-spacing:.6px;margin:.2rem .2rem;">PICKS</h3>
        <div>
          <button id="playDJ" class="btn" title="Play all from selected DJ">‚ñ∂ Play DJ</button>
          <button id="shuffleDJ" class="btn" title="Shuffle selected DJ">üîÄ Shuffle DJ</button>
          <button id="playAll" class="btn" title="Play all DJs in order">‚ñ∂ Play All</button>
          <button id="shuffleAll" class="btn" title="Shuffle all DJs">üîÄ Shuffle All</button>
        </div>
      </div>
      <div id="cards" class="cards"></div>
    </section>

    <!-- RIGHT: Now Playing + full queue -->
    <aside class="nowp" aria-label="Now Playing">
      <h3>Now Playing</h3>
      <div class="player-shell"><div id="mainPreview"></div></div>
      <div class="queue" id="queueBox" aria-label="Playback order"></div>
    </aside>
  </main>

  <!-- Sticky Mini Player (mobile) -->
  <div id="miniPlayer" aria-live="polite">
    <div class="mp-thumb" id="mpThumb"></div>
    <div><div class="mp-title" id="mpTitle">Nothing playing</div><div class="mp-sub" id="mpSub">Select a clip</div></div>
    <button id="mpPrev" class="mp-btn" title="Previous">‚èÆ</button>
    <button id="mpPlayPause" class="mp-btn" title="Play/Pause">‚èØ</button>
    <button id="mpNext" class="mp-btn" title="Next">‚è≠</button>
  </div>

  <!-- Hidden Admin Overlay (Shift+A) -->
  <div id="adminOverlay" class="adminHidden" aria-hidden="true">
    <div id="adminPanel" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
      <h3 id="adminTitle">Cutty Ranks ‚Äî Admin</h3>
      <div id="adminEntries"></div>
      <div id="adminActions" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <button id="addEntryBtn"><i class="fa fa-plus"></i>&nbsp; Add DJ</button>
        <button id="adminSave">Save</button>
        <button id="adminClose">Close</button>
        <button id="clearImgCache" title="Clear cached Radio Cult images">Clear Image Cache</button>
        <div id="adminStatus"></div>
      </div>
    </div>
  </div>

  <!-- Config -->
  <script>
    window.CUTTY_RANKS = {
      CONFIG_ENDPOINT: 'cutty-ranks-config.php',
      ADMIN_HASH_HEX: '446b03243337b8bb55581f2c94647468d02b9dc09aa07968701be1f65071599e'
    };
    // EXACTLY like OUR DJS
    window.RC = {
      BASE_URL:   'https://api.radiocult.fm/api',
      STATION_ID: 'cutters-choice-radio',
      API_KEY:    'pk_0b8abc6f834b444f949f727e88a728e0'
    };
  </script>

  <script>
  (() => {
    const CFG = window.CUTTY_RANKS || {};
    const RC  = window.RC || {};
    const $   = (s, r=document) => r.querySelector(s);
    const $$  = (s, r=document) => [...r.querySelectorAll(s)];

    /* Elements */
    const gridEl  = $('#grid');
    const djGrid  = $('#djGrid');
    const cardsBox= $('#cards');
    const queueBox= $('#queueBox');
    const mainPrev= $('#mainPreview');

    const btnPlayDJ     = $('#playDJ');
    const btnShuffleDJ  = $('#shuffleDJ');
    const btnPlayAll    = $('#playAll');
    const btnShuffleAll = $('#shuffleAll');

    const mpBar   = $('#miniPlayer'), mpThumb = $('#mpThumb'), mpTitle = $('#mpTitle'), mpSub = $('#mpSub');
    const mpPrev  = $('#mpPrev'), mpPP = $('#mpPlayPause'), mpNext = $('#mpNext');

    /* State */
    const state = {
      entries: [],           // [{name, links[], image?}]
      selected: 0,
      queue: [],             // [{id,djIndex,clipIndex,title?}]
      qidx: 0,
      player:null, apiReady:false, lastVideoTitle:'',
      artistsMap:{},         // normalizedName -> artist
      titleCache:{}          // videoId -> title
    };

    /* Helpers */
    const norm = s => (s||'').toLowerCase().replace(/\s+/g,' ').trim();
    const slug = s => (s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    const ytId = (u) => { try{
      const x=new URL(u); const h=x.hostname.toLowerCase();
      if(h==='youtu.be') return x.pathname.slice(1);
      if(x.pathname.startsWith('/shorts/')) return x.pathname.split('/')[2]||'';
      if(x.searchParams.get('v')) return x.searchParams.get('v');
      if(/^\/embed\//.test(x.pathname)) return x.pathname.split('/').pop();
      return '';
    }catch{ return ''; } };

    /* Height calc so columns fit viewport and viewer never looks squashed */
    function setHeights(){
      const rect = gridEl.getBoundingClientRect();
      const usable = Math.max(360, window.innerHeight - rect.top - 12);
      document.documentElement.style.setProperty('--usable', usable + 'px');
    }
    window.addEventListener('resize', setHeights, {passive:true});

    /* YouTube API */
    window.onYouTubeIframeAPIReady = () => { state.apiReady = true; };
    function ensurePlayer(){
      if ($('#ytPlayer')) return;
      mainPrev.innerHTML = `<div id="ytPlayer"></div>`;
    }
    function createOrLoad(videoId, autoplay){
      ensurePlayer();
      const doPlay = () => {
        if (!state.player){
          state.player = new YT.Player('ytPlayer', {
            host:'https://www.youtube-nocookie.com',
            videoId,
            playerVars:{ rel:0, modestbranding:1, playsinline:1, enablejsapi:1 },
            events:{
              onReady: e => { autoplay ? e.target.playVideo() : e.target.cueVideoById(videoId); updateMini(); },
              onStateChange: e => {
                try{ state.lastVideoTitle = state.player?.getVideoData?.().title || state.lastVideoTitle; }catch{}
                if (e.data === YT.PlayerState.ENDED){
                  if (state.qidx < state.queue.length-1){ state.qidx++; playAt(state.qidx,true); }
                }
                highlightQueue(); updateMini();
              }
            }
          });
        } else {
          autoplay ? state.player.loadVideoById(videoId) : state.player.cueVideoById(videoId);
        }
      };
      if (state.apiReady) doPlay(); else {
        const iv = setInterval(()=>{ if(state.apiReady){ clearInterval(iv); doPlay(); } }, 60);
        setTimeout(()=>clearInterval(iv), 5000);
      }
    }
    function playAt(i, autoplay=true){
      const item = state.queue[i]; if (!item) return;
      state.qidx = i;
      createOrLoad(item.id, autoplay);
      highlightQueue(); updateMini();
    }

    /* Mini player (mobile) */
    function updateMini(){
      const item = state.queue[state.qidx] || {};
      const vid  = item.id;
      const who  = state.entries[item.djIndex]?.name || '‚Äî';
      const title= item.title || state.lastVideoTitle || `Clip ${ (item.clipIndex??0)+1 }`;
      mpTitle.textContent = title;
      mpSub.textContent   = who;
      if (vid) mpThumb.style.backgroundImage = `url('https://i.ytimg.com/vi/${vid}/hqdefault.jpg')`;
    }
    mpPrev.addEventListener('click', ()=>{ if (state.qidx>0){ state.qidx--; playAt(state.qidx,true);} }, {passive:true});
    mpNext.addEventListener('click', ()=>{ if (state.qidx<state.queue.length-1){ state.qidx++; playAt(state.qidx,true);} }, {passive:true});
    mpPP.addEventListener('click', ()=>{
      try{ const s = state.player?.getPlayerState?.(); (s===YT.PlayerState.PLAYING)?state.player.pauseVideo():state.player.playVideo(); }catch{}
    }, {passive:true});

    /* ===== Radio Cult (match OUR DJS exactly) ===== */
    async function loadStationArtists(){
      try{
        const res = await fetch(`${RC.BASE_URL}/station/${RC.STATION_ID}/artists`, {
          headers: { 'x-api-key': RC.API_KEY }
        });
        if(!res.ok) throw new Error(`RC ${res.status}`);
        const { artists = [] } = await res.json();
        const map = {};
        for(const a of artists){
          map[norm(a.name)] = a;
        }
        state.artistsMap = map;
      }catch(err){
        console.warn('Radio Cult artists fetch failed:', err);
        state.artistsMap = {};
      }
    }
    function djImageFor(name, override){
      if (override) return override;
      const a = state.artistsMap[norm(name)];
      const rc = a?.logo?.['512x512'] || a?.logo?.default || '';
      if (rc) return rc;
      return '/images/djs/' + slug(name) + '.jpg';
    }

    /* ===== Titles (oEmbed) + cache ===== */
    function loadTitleCache(){ try{ state.titleCache = JSON.parse(localStorage.getItem('yt_title_cache')||'{}'); }catch{ state.titleCache={}; } }
    function saveTitleCache(){ localStorage.setItem('yt_title_cache', JSON.stringify(state.titleCache)); }
    async function getTitleFor(id){
      if (!id) return '';
      if (state.titleCache[id]) return state.titleCache[id];
      try{
        const r = await fetch(`https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${id}&format=json`);
        if (!r.ok) throw new Error('oembed '+r.status);
        const j = await r.json();
        const title = String(j?.title || '').trim();
        if (title){ state.titleCache[id] = title; saveTitleCache(); return title; }
      }catch(_){}
      return '';
    }

    /* Queues */
    function buildQueueDJ(djIdx, shuffle=false){
      const entry = state.entries[djIdx] || {};
      let vids = (entry.links||[]).map(ytId).map((id, i)=> id?({id, djIndex:djIdx, clipIndex:i}):null).filter(Boolean);
      if (shuffle){ for(let i=vids.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [vids[i],vids[j]]=[vids[j],vids[i]]; } }
      state.queue = vids; state.qidx = 0;
    }
    function buildQueueAll(shuffle=false){
      const all = [];
      state.entries.forEach((e, djIdx)=>{
        (e.links||[]).forEach((u, i)=>{ const id=ytId(u); if(id) all.push({id, djIndex:djIdx, clipIndex:i}); });
      });
      if (shuffle){ for(let i=all.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [all[i],all[j]]=[all[j],all[i]]; } }
      state.queue = all; state.qidx = 0;
    }

    /* Renderers */
    async function renderDJGrid(){
      djGrid.innerHTML = '';
      const promises = state.entries.map(async (e, idx)=>{
        const url = djImageFor(e.name, e.image);
        const tile = document.createElement('div'); tile.className='dj-tile'; tile.style.backgroundImage = `url('${(url||'').replace(/'/g,"%27")}')`;
        tile.setAttribute('role','listitem');
        const label = document.createElement('div'); label.className='dj-name'; label.textContent = e.name || 'Untitled';
        tile.appendChild(label);
        tile.addEventListener('click', ()=>{
          state.selected = idx;
          $$('.dj-tile', djGrid).forEach(el=>el.classList.remove('active'));
          tile.classList.add('active');
          buildQueueDJ(idx,false); renderCards(); renderQueue(); playAt(0,false);
        }, {passive:true});
        if (idx===state.selected) tile.classList.add('active');
        djGrid.appendChild(tile);
      });
      await Promise.allSettled(promises);
    }

    async function renderCards(){
      cardsBox.innerHTML = '';
      const e = state.entries[state.selected] || {};
      const linkList = (e.links||[]).slice(0,5);
      for (let i=0;i<linkList.length;i++){
        const id = ytId(linkList[i]); if (!id) continue;
        const card = document.createElement('div'); card.className='card';
        const t = document.createElement('div'); t.className='thumb'; t.style.backgroundImage=`url('https://i.ytimg.com/vi/${id}/hqdefault.jpg')`;
        const meta = document.createElement('div'); meta.className='meta';
        const titleEl = document.createElement('div'); titleEl.className='title'; titleEl.textContent = `Clip ${i+1}`;
        const subEl = document.createElement('div'); subEl.className='sub'; subEl.textContent = e.name || '';
        meta.append(titleEl, subEl);
        const play = document.createElement('button'); play.className='play'; play.innerHTML='‚ñ∂';
        play.addEventListener('click', ()=>{
          buildQueueDJ(state.selected,false); state.qidx=i; playAt(i,true); renderQueue();
        }, {passive:true});
        card.append(t, meta, play);
        cardsBox.appendChild(card);

        // set real title once fetched
        getTitleFor(id).then(tt => { if (tt) titleEl.textContent = tt; });
      }
      highlightQueue();
    }

    async function renderQueue(){
      queueBox.innerHTML = '';
      // fetch titles lazily & fill
      const titlePromises = state.queue.map(async (q, i) => {
        const who = state.entries[q.djIndex]?.name || '';
        const item = document.createElement('div'); item.className='q-item';
        item.innerHTML = `<div class="q-num">${i+1}</div><div class="q-title" id="qt-${q.id}-${i}">Clip ${(q.clipIndex??0)+1}</div><div class="q-who">${who}</div>`;
        item.addEventListener('click', ()=> playAt(i,true), {passive:true});
        queueBox.appendChild(item);
        const tt = await getTitleFor(q.id);
        if (tt){ const el = document.getElementById(`qt-${q.id}-${i}`); if (el) el.textContent = tt; q.title = tt; }
      });
      await Promise.allSettled(titlePromises);
      highlightQueue();
    }
    function highlightQueue(){
      $$('.q-item', queueBox).forEach((el,i)=> el.classList.toggle('active', i===state.qidx));
    }

    /* Load / Save (same JSON/PHP as before) */
    async function loadEntries(){
      try{
        const r = await fetch(`${CFG.CONFIG_ENDPOINT}?action=load`, {cache:'no-store'});
        if (r.ok){ const j = await r.json(); if (Array.isArray(j?.entries)) return j.entries; }
      }catch(_){}
      try{
        const r = await fetch('cutty-ranks-data.json', {cache:'no-store'});
        if (r.ok){ const j = await r.json(); if (Array.isArray(j?.entries)) return j.entries; }
      }catch(_){}
      try{
        const s = localStorage.getItem('cutty_ranks_entries'); if (s){ const a=JSON.parse(s); if (Array.isArray(a)) return a; }
      }catch(_){}
      return [];
    }
    async function saveEntries(entries){
      const r = await fetch(CFG.CONFIG_ENDPOINT+'?action=save', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({entries, auth: CFG.ADMIN_HASH_HEX})
      });
      const txt = await r.text(); let j=null; try{ j=JSON.parse(txt);}catch{}
      if(!r.ok || !(j&&j.ok)) throw new Error(j?.error ? ('Server error: '+j.error) : ('HTTP '+r.status+' '+txt.slice(0,180)));
      return j.entries || entries;
    }

    /* Admin */
    const adminOverlay = $('#adminOverlay');
    const adminEntriesBox = $('#adminEntries');
    const addEntryBtn = $('#addEntryBtn');
    const adminSaveBtn = $('#adminSave');
    const adminCloseBtn = $('#adminClose');
    const clearImgCache = $('#clearImgCache');
    const adminStatus = $('#adminStatus');

    function entryRow(data={}){
      const wrap = document.createElement('div'); wrap.className='entry';
      wrap.innerHTML = `
        <div class="row"><label>DJ</label><input type="text" class="djName" placeholder="Name"></div>
        <div class="row"><label>Image URL</label><input type="text" class="imgUrl" placeholder="override image URL (optional)"></div>
        <div class="row"><label>Link 1</label><input type="text" class="l l1" placeholder="YouTube URL"></div>
        <div class="row"><label>Link 2</label><input type="text" class="l l2" placeholder="YouTube URL"></div>
        <div class="row"><label>Link 3</label><input type="text" class="l l3" placeholder="YouTube URL"></div>
        <div class="row"><label>Link 4</label><input type="text" class="l l4" placeholder="YouTube URL"></div>
        <div class="row"><label>Link 5</label><input type="text" class="l l5" placeholder="YouTube URL"></div>
        <div class="row"><button class="delBtn"><i class="fa fa-trash"></i>&nbsp; Remove DJ</button></div>
      `;
      wrap.querySelector('.djName').value = data.name || '';
      wrap.querySelector('.imgUrl').value = data.image || '';
      (data.links||[]).slice(0,5).forEach((u,i)=> wrap.querySelector('.l'+(i+1)).value = u);
      wrap.querySelector('.delBtn').addEventListener('click', () => { wrap.remove(); }, {passive:true});
      return wrap;
    }
    function openAdmin(){
      adminEntriesBox.innerHTML = '';
      (state.entries || []).forEach(e => adminEntriesBox.appendChild(entryRow(e)));
      adminOverlay.classList.remove('adminHidden'); adminOverlay.setAttribute('aria-hidden','false');
      adminStatus.textContent = '';
    }
    function closeAdmin(){ adminOverlay.classList.add('adminHidden'); adminOverlay.setAttribute('aria-hidden','true'); }
    adminCloseBtn.addEventListener('click', closeAdmin, {passive:true});
    addEntryBtn.addEventListener('click', ()=> adminEntriesBox.appendChild(entryRow()), {passive:true});
    clearImgCache.addEventListener('click', ()=>{ localStorage.removeItem('yt_title_cache'); adminStatus.textContent='Cleared YouTube title cache.'; });

    adminSaveBtn.addEventListener('click', async ()=>{
      const entries = $$('.entry', adminEntriesBox).map(box => {
        const name = box.querySelector('.djName').value.trim();
        const image= box.querySelector('.imgUrl').value.trim();
        const links = $$('.l', box).map(i=>i.value.trim()).filter(Boolean).slice(0,5);
        return name || image || links.length ? {name, image, links} : null;
      }).filter(Boolean);
      if(!entries.length){ adminStatus.textContent='Nothing to save.'; return; }

      const ok = u=>/^https?:\/\/(www\.)?(youtube\.com|youtu\.be)\//i.test(u);
      for(const e of entries){
        if(!e.name){ adminStatus.textContent='Each DJ needs a name.'; return; }
        if(e.links.some(u=>!ok(u))) { adminStatus.textContent='Only YouTube links supported.'; return; }
      }

      adminStatus.textContent='Saving‚Ä¶';
      try{
        const saved = await saveEntries(entries);
        state.entries = saved;
        localStorage.setItem('cutty_ranks_entries', JSON.stringify(saved));
        await bootRender();
        adminStatus.textContent='Saved.';
      }catch(err){
        console.error(err);
        state.entries = entries;
        localStorage.setItem('cutty_ranks_entries', JSON.stringify(entries));
        await bootRender();
        adminStatus.textContent='Saved locally (check server).';
      }
    });

    function isTypingTarget(el){ if (!el) return false; const t=el.tagName; return t==='INPUT'||t==='TEXTAREA'||t==='SELECT'||el.isContentEditable; }
    window.addEventListener('keydown', async (e)=>{
      const key=(e.key||'').toLowerCase(); const isShiftA=e.shiftKey && (key==='a'||e.code==='KeyA');
      if (!isShiftA) return; if (isTypingTarget(document.activeElement)) return;
      e.preventDefault();
      const pw = prompt('Enter passphrase'); if(!pw) return;
      try{
        const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pw));
        const hex = [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
        if(hex===CFG.ADMIN_HASH_HEX) openAdmin(); else alert('Incorrect passphrase');
      }catch(err){ console.warn('digest error', err); }
    }, true);

    /* Controls */
    btnPlayDJ.addEventListener('click', ()=>{ buildQueueDJ(state.selected,false); renderQueue(); playAt(0,true); }, {passive:true});
    btnShuffleDJ.addEventListener('click', ()=>{ buildQueueDJ(state.selected,true);  renderQueue(); playAt(0,true); }, {passive:true});
    btnPlayAll.addEventListener('click', ()=>{ buildQueueAll(false); renderQueue(); playAt(0,true); }, {passive:true});
    btnShuffleAll.addEventListener('click', ()=>{ buildQueueAll(true);  renderQueue(); playAt(0,true); }, {passive:true});

    /* Boot */
    async function bootRender(){
      setHeights();
      await loadStationArtists();   // pull DJ images exactly like OUR DJS
      await renderDJGrid();
      await renderCards();
      buildQueueDJ(Math.max(0, state.selected), false);
      await renderQueue();
      playAt(0,false);
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      if (window.matchMedia('(max-width: 1180px)').matches) mpBar.style.display='grid';
      loadTitleCache();
      state.entries = await loadEntries();
      await bootRender();
    });
  })();
  </script>
</body>
</html>
