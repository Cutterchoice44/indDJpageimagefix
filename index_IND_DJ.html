<?php
/**
 * rc-proxy.php â€” Radio Cult server-side proxy for DJ Selects
 * ----------------------------------------------------------
 * Why: Radio Cult blocks browser requests (403/CORS). This proxy calls RC
 *      from your server with x-api-key and returns JSON to the page.
 *
 * Endpoints (GET):
 *   ?fn=ping
 *   ?fn=artists&stationId=ID
 *   ?fn=presenters&stationId=ID
 *   ?fn=upcoming&stationId=ID&limit=50&expand=artist,presenter
 *   ?fn=artist_schedule&stationId=ID&artistId=ART&startDate=ISO&endDate=ISO
 *   ?fn=presenter_schedule&stationId=ID&presenterId=PR&startDate=ISO&endDate=ISO
 *
 * Notes:
 *   - Do NOT expose the key in HTML/JS. Keep it here server-side.
 *   - Returns raw JSON from RC on success; 4xx/5xx from this proxy on errors.
 */

declare(strict_types=1);

/* ---------- config ---------- */
const RC_BASE = 'https://api.radiocult.fm/api';

/* Your publishable Radio Cult key (provided by you) */
const RC_API_KEY = 'pk_0b8abc6f834b444f949f727e88a728e0';

/* ---------- headers ---------- */
header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-store, must-revalidate');
header('Access-Control-Allow-Origin: *');

/* ---------- helpers ---------- */
function build_url(string $base, string $path, array $qs = []): string {
  $q = http_build_query(array_filter($qs, static fn($v) => $v !== '' && $v !== null));
  return rtrim($base, '/') . $path . ($q ? ('?' . $q) : '');
}

function bail(int $status, array $payload): void {
  http_response_code($status);
  echo json_encode($payload, JSON_UNESCAPED_SLASHES);
  exit;
}

/* ---------- route ---------- */
$fn        = $_GET['fn']        ?? 'ping';
$stationId = $_GET['stationId'] ?? '';
$limit     = isset($_GET['limit']) ? max(1, (int)$_GET['limit']) : 50;
$expand    = $_GET['expand']    ?? '';

if ($fn === 'ping') {
  echo json_encode(['ok' => true], JSON_UNESCAPED_SLASHES);
  exit;
}

if (!$stationId) {
  bail(400, ['error' => 'stationId_required']);
}

$upstream = '';

switch ($fn) {
  case 'artists':
    $upstream = build_url(RC_BASE, '/station/' . rawurlencode($stationId) . '/artists');
    break;

  case 'presenters':
    $upstream = build_url(RC_BASE, '/station/' . rawurlencode($stationId) . '/presenters');
    break;

  case 'upcoming':
    $upstream = build_url(
      RC_BASE,
      '/station/' . rawurlencode($stationId) . '/upcoming',
      ['limit' => $limit, 'expand' => $expand]
    );
    break;

  case 'artist_schedule': {
    $artistId  = $_GET['artistId']  ?? '';
    $startDate = $_GET['startDate'] ?? '';
    $endDate   = $_GET['endDate']   ?? '';
    if (!$artistId) bail(400, ['error' => 'artistId_required']);
    $upstream = build_url(
      RC_BASE,
      '/station/' . rawurlencode($stationId) . '/artists/' . rawurlencode($artistId) . '/schedule',
      ['startDate'=>$startDate, 'endDate'=>$endDate]
    );
    break;
  }

  case 'presenter_schedule': {
    $presenterId  = $_GET['presenterId']  ?? '';
    $startDate = $_GET['startDate'] ?? '';
    $endDate   = $_GET['endDate']   ?? '';
    if (!$presenterId) bail(400, ['error' => 'presenterId_required']);
    $upstream = build_url(
      RC_BASE,
      '/station/' . rawurlencode($stationId) . '/presenters/' . rawurlencode($presenterId) . '/schedule',
      ['startDate'=>$startDate, 'endDate'=>$endDate]
    );
    break;
  }

  default:
    bail(400, ['error' => 'bad_fn']);
}

/* ---------- curl to RC ---------- */
$headers = [
  'Accept: application/json',
  'x-api-key: ' . RC_API_KEY,
];

$ch = curl_init($upstream);
curl_setopt_array($ch, [
  CURLOPT_RETURNTRANSFER => true,
  CURLOPT_FOLLOWLOCATION => true,
  CURLOPT_TIMEOUT        => 15,
  CURLOPT_HTTPHEADER     => $headers,
]);

$resp = curl_exec($ch);
$code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
$err  = curl_error($ch);
curl_close($ch);

if ($resp === false || $code >= 400) {
  bail(502, ['error' => 'upstream_error', 'status' => $code, 'detail' => $err ?: $resp]);
}

/* Success: return the RC JSON verbatim */
echo $resp;
