<?php
// dj-selects-config.php
declare(strict_types=1);
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Headers: Content-Type');
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
if ($_SERVER['REQUEST_METHOD']==='OPTIONS') exit;

$ACTION = $_GET['action'] ?? 'load';
$FILE   = __DIR__ . '/dj-selects-config.json';
$SERVER_TOKEN = 'CCR_TEMP_TOKEN_!2025';  // must match SAVE_TOKEN in the page

if ($ACTION === 'load') {
  header('Content-Type: application/json; charset=utf-8');
  if (!file_exists($FILE)) { echo json_encode([]); exit; }
  $raw = file_get_contents($FILE);
  echo $raw ?: '{}'; exit;
}

if ($ACTION === 'save') {
  $body = json_decode(file_get_contents('php://input') ?: '{}', true);
  if (!isset($body['token']) || $body['token'] !== $SERVER_TOKEN) {
    http_response_code(403); echo json_encode(['ok'=>false,'error'=>'bad token']); exit;
  }
  $data = $body['data'] ?? [];
  file_put_contents($FILE, json_encode($data, JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES));
  header('Content-Type: application/json; charset=utf-8');
  echo json_encode(['ok'=>true]); exit;
}

http_response_code(400);
echo json_encode(['error'=>'unknown action']);
