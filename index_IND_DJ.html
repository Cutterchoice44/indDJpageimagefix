<?php
// rc-proxy.php â€” resilient Radio Cult + Bandcamp proxy
// Tries multiple API shapes and falls back to scraping the shareable page.

declare(strict_types=1);
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Headers: Authorization, Content-Type, Accept, Origin, X-API-Key, x-api-key, X-Publishable-Key, x-publishable-key');
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') { exit; }

$fn        = $_GET['fn']        ?? '';
$stationId = $_GET['stationId'] ?? '';
$apiKey    = $_GET['apiKey']    ?? '';
$limit     = $_GET['limit']     ?? '200';
$expand    = $_GET['expand']    ?? '';
$id        = $_GET['id']        ?? '';
$slug      = $_GET['slug']      ?? '';
$start     = $_GET['startDate'] ?? '';
$end       = $_GET['endDate']   ?? '';
$kind      = $_GET['kind']      ?? ''; // artist | presenter (for smart_schedule)

function json_out($code, $obj){ http_response_code($code); header('Content-Type: application/json; charset=utf-8'); echo json_encode($obj, JSON_UNESCAPED_SLASHES); exit; }

function curl_get($url, $headers=[]){
  $ch = curl_init($url);
  curl_setopt_array($ch, [
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_FOLLOWLOCATION => true,
    CURLOPT_TIMEOUT => 25,
    CURLOPT_CONNECTTIMEOUT => 10,
    CURLOPT_HTTPHEADER => $headers
  ]);
  $res = curl_exec($ch);
  $err = curl_error($ch);
  $code= curl_getinfo($ch, CURLINFO_HTTP_CODE);
  curl_close($ch);
  return [$res, $code, $err];
}

function get_json($url, $key=''){
  $headerSets = [
    ['Accept: application/json','User-Agent: CCR-Proxy/1.3'],
  ];
  if ($key) {
    $headerSets[] = ['Accept: application/json','User-Agent: CCR-Proxy/1.3','Authorization: Bearer '.$key];
    $headerSets[] = ['Accept: application/json','User-Agent: CCR-Proxy/1.3','X-API-Key: '.$key];
    $headerSets[] = ['Accept: application/json','User-Agent: CCR-Proxy/1.3','x-api-key: '.$key];
    $headerSets[] = ['Accept: application/json','User-Agent: CCR-Proxy/1.3','X-Publishable-Key: '.$key];
    $headerSets[] = ['Accept: application/json','User-Agent: CCR-Proxy/1.3','x-publishable-key: '.$key];
    $headerSets[] = ['Accept: application/json','User-Agent: CCR-Proxy/1.3','apikey: '.$key];
  }
  foreach ($headerSets as $hs){
    [$res,$code,$err] = curl_get($url,$hs);
    if (!$err && $res!==false && $code>=200 && $code<400) {
      $j = json_decode($res,true);
      if (is_array($j)) return [$j,null];
    }
  }
  return [null,'HTTP fail'];
}

function first_json(array $urls, $key=''){
  foreach ($urls as $u){
    [$j,$e] = get_json($u,$key);
    if ($j!==null && !$e) return $j;
  }
  return null;
}

/* ---------- tiny HTML scrapers for shareable pages ---------- */
function get_html($url){
  [$res,$code,$err] = curl_get($url, ['User-Agent: CCR-Proxy/1.3']);
  if ($err || $code>=400 || $res===false) return null;
  return $res;
}
function scrape_meta($html){
  $out = ['name'=>'','image'=>'','description'=>'','slug'=>''];
  if (preg_match('~property=["\']og:title["\']\s+content=["\']([^"\']+)["\']~i',$html,$m)) $out['name']=$m[1];
  if (preg_match('~property=["\']og:image["\']\s+content=["\']([^"\']+)["\']~i',$html,$m)) $out['image']=$m[1];
  if (preg_match('~name=["\']description["\']\s+content=["\']([^"\']+)["\']~i',$html,$m)) $out['description']=$m[1];
  if (preg_match('~"slug"\s*:\s*"([^"]+)"~i',$html,$m)) $out['slug']=$m[1];
  return $out;
}

/* --------- endpoints --------- */

if ($fn==='ping') json_out(200,['pong'=>'ok']);

if ($fn==='bandcamp_oembed') {
  $url = $_GET['url'] ?? '';
  if (!$url) json_out(400,['error'=>'Missing url']);
  [$j,$e] = get_json('https://bandcamp.com/oembed?format=json&url='.rawurlencode($url));
  if (!$j) json_out(502,['error'=>'Bandcamp oEmbed failed']);
  json_out(200,$j);
}

/* selector_profile: find artist/presenter by slug "selector"
   1) try API variants; 2) try shareable page scrape */
if ($fn==='selector_profile'){
  if (!$stationId || !$slug) json_out(400,['error'=>'Missing stationId or slug']);

  $bases = [
    'https://api.radiocult.fm/v1',
    'https://radiocult.fm/api/v1',
    'https://api.radiocult.dev/v1'
  ];

  // 1) API search by slug (artists then presenters)
  foreach ($bases as $b){
    $qs = http_build_query(['slug'=>$slug,'limit'=>1,'expand'=>'tags,images']);
    $urls = [
      "$b/stations/".rawurlencode($stationId)."/artists?$qs",
      "$b/stations/".rawurlencode($stationId)."/presenters?$qs",
    ];
    $j = first_json($urls, $apiKey);
    if ($j){
      $item = $j['artists'][0] ?? $j['presenters'][0] ?? $j['data'][0] ?? null;
      if ($item){
        $img = $item['logo']['512x512'] ?? ($item['logo']['default'] ?? ($item['image'] ?? ($item['avatar'] ?? '')));
        $kind= isset($j['artists']) ? 'artist' : (isset($j['presenters']) ? 'presenter' : 'artist');
        $share = $item['shareUrl'] ?? ($item['url'] ?? '');
        json_out(200, [
          'kind'=>$kind,
          'id'=>$item['id'] ?? ($item['_id'] ?? ($item['uuid'] ?? '')),
          'slug'=>$item['slug'] ?? $slug,
          'name'=>$item['name'] ?? 'DJ',
          'image'=>$img ?: '',
          'description'=>($item['description'] ?? ($item['bio'] ?? ($item['about'] ?? ''))),
          'shareUrl'=>$share
        ]);
      }
    }
  }

  // 2) Scrape shareable page (artist then presenter dirs)
  $paths = [
    "https://app.radiocult.fm/".rawurlencode($stationId)."/artists/".rawurlencode($slug),
    "https://app.radiocult.fm/".rawurlencode($stationId)."/artist/".rawurlencode($slug),
    "https://radiocult.fm/".rawurlencode($stationId)."/artists/".rawurlencode($slug),
    "https://radiocult.fm/".rawurlencode($stationId)."/presenters/".rawurlencode($slug),
  ];
  foreach ($paths as $i => $u){
    $html = get_html($u);
    if ($html){
      $m = scrape_meta($html);
      $name = $m['name'] ?: 'DJ';
      $img  = $m['image'] ?: '';
      $desc = $m['description'] ?: '';
      $slugFound = $m['slug'] ?: $slug;
      $kindGuess = (strpos($u,'presenter')!==false) ? 'presenter' : 'artist';
      json_out(200, [
        'kind'=>$kindGuess,
        'id'=>'', 'slug'=>$slugFound, 'name'=>$name, 'image'=>$img, 'description'=>$desc,
        'shareUrl'=>$u
      ]);
    }
  }

  json_out(404,['error'=>'selector profile not found']);
}

/* smart_schedule: try artist/presenter schedules using id or slug and many param names */
if ($fn==='smart_schedule'){
  if (!$stationId) json_out(400,['error'=>'Missing stationId']);

  $bases = [
    'https://api.radiocult.fm/v1',
    'https://radiocult.fm/api/v1',
    'https://api.radiocult.dev/v1'
  ];
  $kind = $kind ?: 'artist';
  $keys = ($kind==='presenter')
    ? [['presenterId'=>$id],['presenter_id'=>$id],['presenterSlug'=>$slug],['presenter_slug'=>$slug],['presenter'=>$slug]]
    : [['artistId'=>$id],['artist_id'=>$id],['artistSlug'=>$slug],['artist_slug'=>$slug],['artist'=>$slug]];

  $urls = [];
  foreach ($bases as $b){
    foreach ($keys as $p){
      $params = array_filter(array_merge($p, [
        'startDate'=>$start ?: date(DATE_ATOM),
        'endDate'  =>$end   ?: date(DATE_ATOM, time()+3600*24*365),
        'limit'=>$limit
      ]), fn($v)=>$v!==null && $v!=='');
      $qs = http_build_query($params);
      $urls[] = "$b/stations/".rawurlencode($stationId)."/schedules?$qs";
    }
  }
  $j = first_json($urls, $apiKey);
  if (!$j) json_out(200,['schedules'=>[]]);
  json_out(200,$j);
}

json_out(400,['error'=>'Unknown fn']);
