<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cutters Choice Radio — Schedule</title>

  <!-- Canonical + SEO -->
  <link rel="canonical" href="https://cutterschoiceradio.com/schedule.html">
  <meta name="description" content="Monthly radio schedule for Cutters Choice Radio. Browse shows by day and time, with live timezone switching.">
  <meta name="robots" content="index, follow">
  <meta name="theme-color" content="#5A8785">

  <!-- Social preview -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Schedule — Cutters Choice Radio">
  <meta property="og:description" content="See what's on Cutters Choice Radio. Full 4-week grid of shows by day and time.">
  <meta property="og:url" content="https://cutterschoiceradio.com/schedule.html">
  <meta property="og:site_name" content="Cutters Choice Radio">
  <meta property="og:image" content="https://cutterschoiceradio.com/images/logo.png">
  <meta name="twitter:card" content="summary_large_image">

  <!-- Perf hints -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://api.radiocult.fm" crossorigin>

  <!-- Site CSS + Fonts -->
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Org JSON-LD -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Cutters Choice Radio",
    "url": "https://cutterschoiceradio.com",
    "logo": "https://cutterschoiceradio.com/images/logo.png",
    "sameAs": [
      "https://www.instagram.com/cutterschoiceradio",
      "https://www.facebook.com/cutterschoiceradio",
      "https://www.mixcloud.com/cutterschoiceradio",
      "https://tunein.com/radio/Cutters-Choice-Radio-s344746/"
    ]
  }
  </script>

  <!-- NAV + SCHEDULE STYLES -->
  <style>
    :root{
      --brand-teal:#5A8785;
      --hourH:52px;                /* desktop grid hour height */
      --qH:calc(var(--hourH)/4);
      --now-color:#ff5858;
    }

    /* NAV – match site, but smaller on mobile so it fits */
    #main-nav{
      display:flex!important;align-items:center!important;gap:.5rem!important;width:100%!important;
      padding:.10rem .65rem!important;margin:0!important;box-sizing:border-box!important;
      background-color:var(--brand-teal)!important;position:relative!important;z-index:1000!important;
      border-top:2px solid #000;border-bottom:2px solid #000;
    }
    #main-nav::before,#main-nav::after{content:none!important;}
    #main-nav .nav-menu{display:flex!important;align-items:center!important;justify-content:space-evenly!important;gap:1rem!important;flex:1 1 auto!important;min-width:0!important;}
    #main-nav a.nav-link{color:#fff!important;font-family:'Bebas Neue',sans-serif!important;font-size:2rem!important;text-transform:uppercase!important;text-decoration:none!important;white-space:nowrap!important;}
    @media (max-width:768px){
      #main-nav .nav-menu{gap:.35rem!important;}
      #main-nav a.nav-link{font-size:clamp(.95rem,3.5vw,1.15rem)!important;letter-spacing:.02em;padding:.1rem .2rem;}
    }

    /* PAGE base */
    html,body{background:#000;color:#fafafa;}
    *{box-sizing:border-box;}

    /* Header (removed in markup; styles left harmlessly) */
    .page-header{display:flex;align-items:center;justify-content:space-between;padding:.5rem .75rem;border-bottom:2px solid #000;background:var(--brand-teal);}
    .page-header h1{font-family:'Bebas Neue',sans-serif;font-size:2.2rem;letter-spacing:.5px;color:#fff;margin:0;text-shadow:0 1px 0 rgba(0,0,0,.35);}
    .utilities{display:flex;align-items:center;gap:.5rem;flex-wrap:wrap}
    .legend{display:flex;gap:.5rem;align-items:center}
    .chip{width:.9rem;height:.9rem;border-radius:2px;border:1px solid #1f1f1f;display:inline-block}

    /* Controls row */
    .month-controls{display:flex;gap:.5rem;align-items:center;justify-content:space-between;border-bottom:1px solid var(--brand-teal);padding:.6rem .75rem;position:sticky;top:0;background:#000;z-index:20;}
    .month-controls .title{font-family:'Bebas Neue',sans-serif;font-size:2rem;color:#fff;letter-spacing:.5px;text-shadow:0 1px 0 rgba(0,0,0,.35);}
    .ccr-btn{background:var(--brand-teal);color:#fff;border:none;border-radius:6px;padding:.45rem .7rem;cursor:pointer;font-weight:600;letter-spacing:.3px;}

    /* Desktop month grid */
    .weeks-stack{display:flex;flex-direction:column;gap:1.25rem;padding:1rem .75rem 2rem;}
    .week-grid{display:grid;grid-template-columns:64px repeat(7,1fr);grid-template-rows:auto 1fr;gap:6px;border:2px solid var(--brand-teal);border-radius:8px;overflow:hidden;background:#0f0f0f;padding:6px;}
    .time-head{grid-column:1;grid-row:1;}
    .time-col{grid-column:1;grid-row:2;position:relative;height:calc(var(--hourH)*24);border:1px solid #1c1c1c;border-radius:6px;background:#0b0b0b;background-image:linear-gradient(to bottom,#1e1e1e 1px,transparent 1px);background-size:100% var(--hourH);}
    .time-col .hour-label{position:absolute;left:6px;font-size:1rem;color:#fff;line-height:1;text-shadow:0 1px 0 rgba(0,0,0,.35);pointer-events:none;}
    .day-head{grid-row:1;background:#0d0d0d;border:1px solid #1e1e1e;padding:.48rem .6rem;border-radius:6px;color:#fff;}
    .day-head .dow{font-family:'Bebas Neue',sans-serif;font-size:1.38rem;color:#fff;text-shadow:0 1px 0 rgba(0,0,0,.35);}
    .day-head .date{font-size:1.06rem;color:#fff;text-shadow:0 1px 0 rgba(0,0,0,.35);}
    .day-body{grid-row:2;display:grid;grid-template-rows:repeat(96,var(--qH));position:relative;height:calc(var(--hourH)*24);border:1px solid #1c1c1c;border-radius:6px;overflow:hidden;background:#0b0b0b;background-image:linear-gradient(to bottom,#1a1a1a 1px,transparent 1px);background-size:100% var(--hourH);}
    .show{grid-column:1/-1;margin:2px 4px;background:var(--chip,#FBBF24);color:var(--fg,#1b0f00);border-radius:10px;padding:.48rem .6rem;overflow:hidden;box-shadow:inset 0 0 0 2px rgba(0,0,0,.2);}
    .show .time{font-size:.78rem;opacity:.95;}
    .show .title{font-weight:800;line-height:1.2;}
    .show .host{font-size:.85rem;opacity:.92;}

    /* Colour tokens */
    .tone-1{--chip:#FBBF24;--fg:#1b0f00}
    .tone-2{--chip:#FB923C;--fg:#1a0900}
    .tone-3{--chip:#EC4899;--fg:#220713}
    .tone-4{--chip:#A78BFA;--fg:#0e0a1a}
    .tone-5{--chip:#06B6D4;--fg:#001318}
    .tone-6{--chip:#60A5FA;--fg:#0a1a35}
    .tone-7{--chip:#10B981;--fg:#00150e}
    .tone-8{--chip:#4ADE80;--fg:#041307}
    .is-archive{--chip:#93C5FD;--fg:#0b1f3f}

    /* Mobile list view (uniform height items, starts at TODAY) */
    .mobile-only{display:none;}
    .mobile-stack{padding:.5rem .5rem 1.25rem;display:flex;flex-direction:column;gap:.7rem;}
    .m-day{background:#0b0b0b;border:1px solid #264745;border-radius:12px;overflow:hidden;}
    .m-day h3{margin:0;padding:.55rem .7rem;font-family:'Bebas Neue',sans-serif;font-size:1.35rem;background:#0d0d0d;border-bottom:1px solid #1e1e1e;color:#fff;display:flex;justify-content:space-between;gap:.5rem;}
    .m-list{display:flex;flex-direction:column;}
    .m-show{display:flex;align-items:center;gap:.6rem;padding:.6rem .72rem;border-bottom:1px solid rgba(0,0,0,.22);background:var(--chip,#FBBF24);color:var(--fg,#1b0f00);}
    .m-show:last-child{border-bottom:0;}
    .m-time{flex:0 0 90px;font-weight:800;font-size:.96rem;}
    .m-title{font-weight:900;line-height:1.05;font-size:1rem;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
    .m-host{font-size:.9rem;opacity:.92;}
    details.m-earlier summary{cursor:pointer;padding:.55rem .7rem;background:#101414;color:#d7ffff;border-top:1px solid #213;list-style:none;}
    details.m-earlier summary::-webkit-details-marker{display:none;}

    /* “Only keep timezone switcher” on mobile; hide clutter */
    @media (max-width:980px){
      .utilities{display:none;}
      .month-controls .title{display:none;}
      .month-controls > div:first-child{display:none;}       /* prev/next arrows */
      .weeks-stack.desktop-only{display:none;}
      .mobile-only{display:block;}
    }

    /* Now marker (desktop grid) */
    .now-line{position:absolute;left:0;right:0;height:2px;background:var(--now-color);pointer-events:none;z-index:6;}
    .now-dot{position:absolute;width:10px;height:10px;border-radius:50%;background:var(--now-color);left:4px;top:-4px;pointer-events:none;z-index:7;box-shadow:0 0 0 2px rgba(0,0,0,.25);}

    /* Footer */
    .banner{display:flex;gap:1rem;justify-content:center;padding:1rem;border-top:2px solid #000}
    .banner a{color:#fff;text-decoration:none}
  </style>
</head>

<body>
  <!-- NAV -->
  <nav id="main-nav" aria-label="Primary">
    <div class="nav-menu">
      <a href="index.html"         class="nav-link">HOME</a>
      <a href="our-story.html"     class="nav-link">OUR STORY</a>
      <a href="index-ourDJS.html"  class="nav-link">OUR DJS</a>
      <a href="dj-selects.html"    class="nav-link">DJ SELECTS</a>
      <a href="merch.html"         class="nav-link">MERCH</a>
    </div>
  </nav>

  <!-- Removed secondary header with "MONTHLY SCHEDULE" and colour legend -->

  <section class="month-controls">
    <div>
      <button class="ccr-btn" id="prevMonthBtn" aria-label="Previous 4 weeks">◀</button>
      <button class="ccr-btn" id="nextMonthBtn" aria-label="Next 4 weeks">▶</button>
    </div>
    <div class="title" id="monthTitle">Loading…</div>
    <div>
      <label style="display:flex;align-items:center;gap:.35rem;">
        <span style="font-size:.95rem;color:#fff">Times in</span>
        <select id="tzSelect" class="ccr-btn" style="background:#0a0a0a;border:1px solid #1c1c1c;color:#fff">
          <option value="local">Your local time</option>
          <option value="Europe/London">UK (Europe/London)</option>
          <option value="UTC">UTC</option>
        </select>
      </label>
    </div>
  </section>

  <!-- Desktop 4-week grid -->
  <main class="weeks-stack desktop-only" id="weeksStack" aria-live="polite">
    <p style="opacity:.8;color:#fff">Fetching…</p>
  </main>

  <!-- Mobile “Today → +6 days” list -->
  <main class="mobile-stack mobile-only" id="mobileStack" aria-live="polite">
    <p style="opacity:.8;color:#fff">Fetching…</p>
  </main>

  <footer class="banner">
    <a href="privacy-policy.html">PRIVACY POLICY</a>
    <a href="index.html">Back to Home</a>
  </footer>

  <script>
    /* ===== API ===== */
    const API_KEY    = "pk_0b8abc6f834b444f949f727e88a728e0";
    const STATION_ID = "cutters-choice-radio";
    const BASE_URL   = "https://api.radiocult.fm/api";

    const rcFetch = async (path) => {
      const res = await fetch(BASE_URL + path, { headers: { "x-api-key": API_KEY }, cache: "no-store" });
      if (!res.ok) throw new Error(`Fetch error ${res.status}`);
      return res.json();
    };

    /* ===== Date helpers ===== */
    const pad = n => String(n).padStart(2,"0");
    const addDaysUTC = (d, n) => { const x = new Date(d); x.setUTCDate(x.getUTCDate()+n); return x; };

    const startOfWeekUTC = (date) => {
      const d=new Date(Date.UTC(date.getUTCFullYear(),date.getUTCMonth(),date.getUTCDate()));
      const day=(d.getUTCDay()+6)%7; d.setUTCDate(d.getUTCDate()-day); d.setUTCHours(0,0,0,0); return d;
    };

    // yyyy-mm-dd in chosen tz
    const ymdInTz = (d, tz) => new Intl.DateTimeFormat('en-CA',{
      timeZone: tz==='local'?undefined:tz, year:'numeric',month:'2-digit',day:'2-digit'
    }).format(d);

    // minutes since day start in tz
    const minutesInDay = (d, tz) => {
      const parts = new Intl.DateTimeFormat('en-GB',{
        timeZone: tz==='local'?undefined:tz, hour:'2-digit', minute:'2-digit', hour12:false
      }).formatToParts(d);
      let hh=0,mm=0; for(const p of parts){ if(p.type==='hour') hh=parseInt(p.value,10); if(p.type==='minute') mm=parseInt(p.value,10); }
      return hh*60+mm;
    };

    const fmtHM = (min) => {
      let h = Math.floor(min/60), m = min % 60;
      const ampm = h >= 12 ? 'pm':'am';
      let hh = ((h + 11) % 12) + 1;
      return `${String(hh).padStart(2,'0')}:${String(m).padStart(2,'0')} ${ampm}`;
    };

    const dowInTz = (d, tz) =>
      new Intl.DateTimeFormat('en-GB', { timeZone: tz === 'local' ? undefined : tz, weekday: 'short' }).format(d).toUpperCase();

    const fmtDMtz = (d, tz) =>
      new Intl.DateTimeFormat(undefined, { timeZone: tz === 'local' ? undefined : tz, day: 'numeric', month: 'short' }).format(d);

    const rangeLabelInTz = (startUtc, endUtc, tz) => {
      const f = (d,opts)=> new Intl.DateTimeFormat(undefined, { ...(tz==='local'?{}:{timeZone:tz}), ...opts }).format(d);
      const sameMonthYear = f(startUtc,{month:'numeric',year:'numeric'}) === f(endUtc,{month:'numeric',year:'numeric'});
      if (sameMonthYear) {
        const moYr = f(startUtc,{month:'long',year:'numeric'});
        return `${moYr} • ${f(startUtc,{day:'2-digit',month:'short'})}–${f(endUtc,{day:'2-digit'})}`;
      }
      return `${f(startUtc,{day:'2-digit',month:'short'})} – ${f(endUtc,{day:'2-digit',month:'short',year:'numeric'})}`;
    };

    /* ===== Fetch 4-week block ===== */
    async function fetchRange(startUtc, endUtc) {
      const paddedStart = addDaysUTC(startUtc, -1).toISOString();
      const paddedEnd   = addDaysUTC(endUtc,   1).toISOString();
      const data = await rcFetch(`/station/${STATION_ID}/schedule?startDate=${encodeURIComponent(paddedStart)}&endDate=${encodeURIComponent(paddedEnd)}`);
      const schedules = Array.isArray(data?.schedules) ? data.schedules : Array.isArray(data) ? data : [];
      return schedules.map(s => ({
        start: s.startDateUtc || s.startDate || s.startAt || s.start,
        end:   s.endDateUtc   || s.endDate   || s.endAt   || s.end,
        title: s.title || s.content?.title || s.content?.name || "Untitled show",
        host:  (Array.isArray(s.content?.presenters) ? s.content.presenters.map(p => p.name).filter(Boolean).join(", ") : "")
               || s.metadata?.artist || s.dj || "",
      })).filter(s => s.start && s.end);
    }

    /* ===== Colour / ordering ===== */
    const ORDER_CLASSES = ['tone-1','tone-2','tone-3','tone-4','tone-5','tone-6','tone-7','tone-8'];
    const isArchive = (s) => `${s.title||''} ${s.host||''}`.toLowerCase().includes('archive');

    const incYMD = (s) => { const [y,m,d]=s.split('-').map(Number); const dt=new Date(Date.UTC(y,m-1,d)); dt.setUTCDate(dt.getUTCDate()+1); return `${dt.getUTCFullYear()}-${pad(dt.getUTCMonth()+1)}-${pad(dt.getUTCDate())}`; };

    function splitShowsIntoDailySegments(shows, tz) {
      const map = new Map();
      for (const s of shows) {
        const st = new Date(s.start), en = new Date(s.end);
        const kStart = ymdInTz(st, tz), kEnd = ymdInTz(en, tz);
        let key = kStart;
        while (true) {
          const segStartMin = (key===kStart) ? minutesInDay(st, tz) : 0;
          const segEndMin   = (key===kEnd)   ? minutesInDay(en, tz) : 24*60;
          const seg = { ...s, segStartMin, segEndMin: Math.max(segStartMin+15, segEndMin), archive: isArchive(s) };
          if (!map.has(key)) map.set(key, []);
          map.get(key).push(seg);
          if (key===kEnd) break;
          key = incYMD(key);
        }
      }
      for (const [key, arr] of map) {
        arr.sort((a,b)=> a.segStartMin - b.segStartMin);
      }
      return map;
    }

    function buildUkOrderLookup(shows){
      const tz = 'Europe/London';
      const byDay = new Map();
      for(const s of shows){
        if (isArchive(s)) continue;
        const st = new Date(s.start);
        const key = ymdInTz(st, tz);
        if(!byDay.has(key)) byDay.set(key, []);
        byDay.get(key).push(s);
      }
      for(const [,arr] of byDay){ arr.sort((a,b)=> new Date(a.start) - new Date(b.start)); }
      const lookup = new Map();
      for(const [,arr] of byDay){
        arr.forEach((s, idx)=> lookup.set((s.start||'') + '|' + (s.title||''), idx));
      }
      return lookup;
    }

    function buildTimeRuler(){
      const col=document.createElement('div'); col.className='time-col';
      for(let h=0;h<24;h++){
        const lab=document.createElement('div'); lab.className='hour-label';
        lab.style.top=`calc(${h} * var(--hourH))`;
        lab.textContent=String(h).padStart(2,'0')+':00';
        col.appendChild(lab);
      }
      return col;
    }

    /* ===== Desktop render ===== */
    function renderFourWeeks(anchorUtc, shows, tz, ukOrderLookup){
      const mount=document.getElementById('weeksStack'); mount.innerHTML='';
      const endUtc = addDaysUTC(anchorUtc, 27);
      document.getElementById('monthTitle').textContent = rangeLabelInTz(anchorUtc, endUtc, tz);

      const buckets = splitShowsIntoDailySegments(shows, tz);

      for (let w=0; w<4; w++){
        const weekEl=document.createElement('section'); weekEl.className='week-grid';

        const spacer=document.createElement('div'); spacer.className='time-head';
        weekEl.appendChild(spacer);
        weekEl.appendChild(buildTimeRuler());

        for(let i=0;i<7;i++){
          const dayUtc = addDaysUTC(anchorUtc, w*7 + i);
          const head=document.createElement('div'); head.className='day-head';
          head.style.gridColumn = String(i+2);
          head.innerHTML = `<div class="dow">${dowInTz(dayUtc, tz)}</div><div class="date">${fmtDMtz(dayUtc, tz)}</div>`;
          weekEl.appendChild(head);

          const body=document.createElement('div'); body.className='day-body';
          body.style.gridColumn = String(i+2);

          const dayKey = ymdInTz(dayUtc, tz);
          body.dataset.day = dayKey;

          const segments = buckets.get(dayKey) || [];

          segments.forEach(seg=>{
            const startQ = Math.floor(seg.segStartMin/15);
            const spanQ  = Math.max(1, Math.ceil((seg.segEndMin - seg.segStartMin)/15));
            const show=document.createElement('div');
            let classes = 'show ';
            if (seg.archive) classes += 'is-archive';
            else {
              const ord = ukOrderLookup.get((seg.start||'') + '|' + (seg.title||'')) ?? 0;
              classes += ORDER_CLASSES[ord % ORDER_CLASSES.length];
            }
            show.className = classes;
            show.style.gridRow = `${startQ+1} / span ${spanQ}`;
            show.innerHTML = `
              <div class="time">${fmtHM(seg.segStartMin)}–${fmtHM(seg.segEndMin)}</div>
              <div class="title">${escapeHtml(seg.title)}</div>
              ${seg.host ? `<div class="host">${escapeHtml(seg.host)}</div>` : ""}
            `;
            body.appendChild(show);
          });

          weekEl.appendChild(body);
        }

        mount.appendChild(weekEl);
      }

      drawNowMarker(tz);
    }

    function drawNowMarker(tz){
      document.querySelectorAll('.now-line,.now-dot').forEach(el=>el.remove());
      const now = new Date();
      const todayKey = ymdInTz(now, tz);
      const body = document.querySelector(`.day-body[data-day="${todayKey}"]`);
      if (!body) return;
      const raw = getComputedStyle(document.documentElement).getPropertyValue('--hourH');
      const hourH = parseFloat(raw) || 52;
      const topPx = (minutesInDay(now, tz) / 60) * hourH;
      const line = document.createElement('div'); line.className = 'now-line'; line.style.top = `${topPx}px`; body.appendChild(line);
      const dot  = document.createElement('div'); dot.className  = 'now-dot';  dot.style.top  = `${topPx}px`; body.appendChild(dot);
    }

    /* ===== Mobile render (TODAY → +6 days) ===== */
    function renderMobileWeek(shows, tz, ukOrderLookup){
      const mount = document.getElementById('mobileStack');
      mount.innerHTML = '';

      const buckets = splitShowsIntoDailySegments(shows, tz);

      // Start from "today" in the SELECTED TZ (fixes the 'yesterday' bug)
      const now = new Date();
      let dayKey = ymdInTz(now, tz);
      const nowMin = minutesInDay(now, tz);

      for (let d=0; d<7; d++){
        const sections = buckets.get(dayKey) || [];
        const dayTitle = d===0 ? 'TODAY' : `${dowInTz(new Date(now.getTime()+d*86400000), tz)} • ${fmtDMtz(new Date(now.getTime()+d*86400000), tz)}`;

        const dayEl = document.createElement('section');
        dayEl.className = 'm-day';

        const h = document.createElement('h3');
        h.innerHTML = `<span>${dayTitle}</span><span style="font-size:.9rem;opacity:.9">Times in your ${tz==='local'?'local time':(tz==='UTC'?'UTC':'UK')}</span>`;
        dayEl.appendChild(h);

        const list = document.createElement('div'); list.className = 'm-list';

        if (d===0){
          const later = sections.filter(s => s.segEndMin > nowMin);
          const earlier = sections.filter(s => s.segEndMin <= nowMin);

          if (later.length){
            later.forEach(seg => list.appendChild(mobileShow(seg, ukOrderLookup)));
          } else {
            const none = document.createElement('div');
            none.className = 'm-show is-archive';
            none.innerHTML = `<div class="m-time">—</div><div class="m-title">No more shows today</div>`;
            list.appendChild(none);
          }

          if (earlier.length){
            const det = document.createElement('details'); det.className='m-earlier';
            det.innerHTML = `<summary>Earlier today</summary>`;
            const inner = document.createElement('div'); inner.className='m-list';
            earlier.forEach(seg => inner.appendChild(mobileShow(seg, ukOrderLookup)));
            det.appendChild(inner);
            list.appendChild(det);
          }
        } else {
          sections.forEach(seg => list.appendChild(mobileShow(seg, ukOrderLookup)));
        }

        dayEl.appendChild(list);
        mount.appendChild(dayEl);

        dayKey = incYMD(dayKey);
      }
    }

    function mobileShow(seg, ukOrderLookup){
      const el = document.createElement('div');
      let classes = 'm-show ';
      if (seg.archive) classes += 'is-archive';
      else {
        const ord = ukOrderLookup.get((seg.start||'') + '|' + (seg.title||'')) ?? 0;
        classes += ORDER_CLASSES[ord % ORDER_CLASSES.length];
      }
      el.className = classes;
      el.innerHTML = `
        <div class="m-time">${fmtHM(seg.segStartMin)}–${fmtHM(seg.segEndMin)}</div>
        <div style="min-width:0">
          <div class="m-title">${escapeHtml(seg.title)}</div>
          ${seg.host ? `<div class="m-host">${escapeHtml(seg.host)}</div>` : ""}
        </div>
      `;
      return el;
    }

    /* ===== Utilities ===== */
    const escapeHtml = (s='') => String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const isMobile = () => window.matchMedia('(max-width: 980px)').matches;

    /* ===== Boot ===== */
    let anchorUtc = startOfWeekUTC(new Date());
    let tzMode = "local";
    let nowTimer = null;
    let cachedShows = null;
    let ukOrderLookup = null;

    async function loadBlock(){
      const blockStart = anchorUtc;
      const blockEnd   = addDaysUTC(anchorUtc, 28);
      try{
        if (!cachedShows){
          cachedShows = await fetchRange(blockStart, blockEnd);
          ukOrderLookup = buildUkOrderLookup(cachedShows);
        }
        if (isMobile()){
          document.getElementById('monthTitle').textContent = 'This Week';
          renderMobileWeek(cachedShows, tzMode, ukOrderLookup);
        } else {
          renderFourWeeks(blockStart, cachedShows, tzMode, ukOrderLookup);
        }
        if (nowTimer) clearInterval(nowTimer);
        nowTimer = setInterval(()=> { if (isMobile()) renderMobileWeek(cachedShows, tzMode, ukOrderLookup); else drawNowMarker(tzMode); }, 60000);
      }catch(e){
        console.error(e);
        (isMobile()?document.getElementById('mobileStack'):document.getElementById('weeksStack')).innerHTML="<p style='color:#fff'>Couldn’t load schedule.</p>";
      }
    }

    // Controls
    document.getElementById('prevMonthBtn').addEventListener('click',()=>{ anchorUtc = addDaysUTC(anchorUtc, -28); cachedShows=null; loadBlock(); window.scrollTo({top:0}); });
    document.getElementById('nextMonthBtn').addEventListener('click',()=>{ anchorUtc = addDaysUTC(anchorUtc, +28); cachedShows=null; loadBlock(); window.scrollTo({top:0}); });

    // Guarded: todayBtn existed in removed header
    const todayBtn = document.getElementById('todayBtn');
    if (todayBtn){
      todayBtn.addEventListener('click',()=>{ anchorUtc = startOfWeekUTC(new Date()); cachedShows=null; loadBlock(); window.scrollTo({top:0,behavior:'smooth'}); });
    }

    document.getElementById('tzSelect').addEventListener('change',e=>{ tzMode=e.target.value; loadBlock(); });

    // Re-render on viewport switch
    window.addEventListener('resize', () => loadBlock());
    document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) (isMobile()?loadBlock():drawNowMarker(tzMode)); });

    loadBlock();
  </script>
</body>
</html>
