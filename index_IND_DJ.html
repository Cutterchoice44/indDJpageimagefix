<?php
// rc-proxy.php â€” Radio Cult + Bandcamp oEmbed passthrough

declare(strict_types=1);
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Headers: Authorization, Content-Type, Accept, Origin');
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') { exit; }

$fn        = $_GET['fn']        ?? '';
$stationId = $_GET['stationId'] ?? '';
$apiKey    = $_GET['apiKey']    ?? '';
$limit     = $_GET['limit']     ?? '200';
$expand    = $_GET['expand']    ?? '';
$id        = $_GET['id']        ?? '';
$slug      = $_GET['slug']      ?? '';
$start     = $_GET['startDate'] ?? '';
$end       = $_GET['endDate']   ?? '';

define('RC_API', 'https://api.radiocult.fm/v1');

function out($code, $obj){ http_response_code($code); header('Content-Type: application/json; charset=utf-8'); echo json_encode($obj, JSON_UNESCAPED_SLASHES); exit; }

function req($url, $headers=[]){
  $ch = curl_init($url);
  curl_setopt_array($ch, [
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_FOLLOWLOCATION => true,
    CURLOPT_TIMEOUT => 25,
    CURLOPT_CONNECTTIMEOUT => 10,
    CURLOPT_HTTPHEADER => array_merge(['Accept: application/json','User-Agent: CCR-Proxy/1.2'], $headers)
  ]);
  $res = curl_exec($ch);
  $err = curl_error($ch);
  $code= curl_getinfo($ch, CURLINFO_HTTP_CODE);
  curl_close($ch);
  if($err || $res===false || $code>=400) return [null, $err?:('HTTP '.$code)];
  return [json_decode($res, true), null];
}
function first_ok($urls, $headers=[]){
  foreach($urls as $u){ [$j,$e]=req($u,$headers); if(!$e && $j!==null) return $j; }
  return null;
}

if ($fn==='ping') out(200,['pong'=>'ok']);

/* -------- Bandcamp oEmbed -------- */
if ($fn==='bandcamp_oembed') {
  $url = $_GET['url'] ?? '';
  if(!$url) out(400,['error'=>'Missing url']);
  [$j,$e] = req('https://bandcamp.com/oembed?format=json&url='.rawurlencode($url));
  if($e) out(502,['error'=>'Upstream error','detail'=>$e]);
  out(200,$j);
}

$auth = [];
if($apiKey) $auth[] = 'Authorization: Bearer '.$apiKey;

/* require station for station-scoped endpoints */
$needsStation = ['artists','presenters','artist_by_slug','presenter_by_slug','artist_schedule','presenter_schedule','upcoming'];
if (in_array($fn,$needsStation,true) && !$stationId) out(400,['error'=>'Missing stationId']);

/* -------- Lists (with expand=tags) -------- */
if ($fn==='artists'){
  $qs = http_build_query(array_filter(['limit'=>$limit,'expand'=>$expand]));
  [$j,$e] = req(RC_API.'/stations/'.rawurlencode($stationId).'/artists'.($qs?'?'.$qs:''), $auth);
  if($e) out(502,['error'=>'Upstream','detail'=>$e]);
  out(200,$j);
}
if ($fn==='presenters'){
  $qs = http_build_query(array_filter(['limit'=>$limit,'expand'=>$expand]));
  [$j,$e] = req(RC_API.'/stations/'.rawurlencode($stationId).'/presenters'.($qs?'?'.$qs:''), $auth);
  if($e) out(502,['error'=>'Upstream','detail'=>$e]);
  out(200,$j);
}

/* -------- Details by id OR slug -------- */
if ($fn==='artist'){
  if(!$id) out(400,['error'=>'Missing id']);
  $qs = http_build_query(array_filter(['expand'=>$expand]));
  $urls = [
    RC_API.'/artists/'.rawurlencode($id).($qs?'?'.$qs:''),
    RC_API.'/stations/'.rawurlencode($stationId).'/artists/'.rawurlencode($id).($qs?'?'.$qs:''),
  ];
  $j=first_ok($urls,$auth); if(!$j) out(404,['error'=>'Artist not found','tried'=>$urls]); out(200,$j);
}
if ($fn==='presenter'){
  if(!$id) out(400,['error'=>'Missing id']);
  $qs = http_build_query(array_filter(['expand'=>$expand]));
  $urls = [
    RC_API.'/presenters/'.rawurlencode($id).($qs?'?'.$qs:''),
    RC_API.'/stations/'.rawurlencode($stationId).'/presenters/'.rawurlencode($id).($qs?'?'.$qs:''),
  ];
  $j=first_ok($urls,$auth); if(!$j) out(404,['error'=>'Presenter not found','tried'=>$urls]); out(200,$j);
}
if ($fn==='artist_by_slug'){
  if(!$slug) out(400,['error'=>'Missing slug']);
  $qs = http_build_query(array_filter(['slug'=>$slug,'limit'=>1,'expand'=>$expand]));
  [$j,$e] = req(RC_API.'/stations/'.rawurlencode($stationId).'/artists?'.$qs,$auth);
  if($e) out(502,['error'=>'Upstream','detail'=>$e]);
  $item = $j['artists'][0] ?? $j['data'][0] ?? null;
  if(!$item) out(404,['error'=>'Not found']);
  out(200,$item);
}
if ($fn==='presenter_by_slug'){
  if(!$slug) out(400,['error'=>'Missing slug']);
  $qs = http_build_query(array_filter(['slug'=>$slug,'limit'=>1,'expand'=>$expand]));
  [$j,$e] = req(RC_API.'/stations/'.rawurlencode($stationId).'/presenters?'.$qs,$auth);
  if($e) out(502,['error'=>'Upstream','detail'=>$e]);
  $item = $j['presenters'][0] ?? $j['data'][0] ?? null;
  if(!$item) out(404,['error'=>'Not found']);
  out(200,$item);
}

/* -------- Schedules (try many param names; accept id OR slug) -------- */
if ($fn==='artist_schedule'){
  $params = [];
  if($id)   $params[] = ['artistId'=>$id];
  if($id)   $params[] = ['artist_id'=>$id];
  if($slug) $params[] = ['artistSlug'=>$slug];
  if($slug) $params[] = ['artist_slug'=>$slug];
  if($slug) $params[] = ['artist'=>$slug];

  if(!$params) out(200,['schedules'=>[]]);

  $urls=[];
  foreach($params as $p){
    $qs = http_build_query(array_merge($p,[
      'startDate'=>$start ?: date(DATE_ATOM),
      'endDate'=>$end ?: date(DATE_ATOM, time()+3600*24*365),
      'limit'=>$limit
    ]));
    $urls[] = RC_API.'/stations/'.rawurlencode($stationId).'/schedules?'.$qs;
  }
  $j=first_ok($urls,$auth); if(!$j) out(200,['schedules'=>[]]); out(200,$j);
}
if ($fn==='presenter_schedule'){
  $params = [];
  if($id)   $params[] = ['presenterId'=>$id];
  if($id)   $params[] = ['presenter_id'=>$id];
  if($slug) $params[] = ['presenterSlug'=>$slug];
  if($slug) $params[] = ['presenter_slug'=>$slug];
  if($slug) $params[] = ['presenter'=>$slug];

  if(!$params) out(200,['schedules'=>[]]);

  $urls=[];
  foreach($params as $p){
    $qs = http_build_query(array_merge($p,[
      'startDate'=>$start ?: date(DATE_ATOM),
      'endDate'=>$end ?: date(DATE_ATOM, time()+3600*24*365),
      'limit'=>$limit
    ]));
    $urls[] = RC_API.'/stations/'.rawurlencode($stationId).'/schedules?'.$qs;
  }
  $j=first_ok($urls,$auth); if(!$j) out(200,['schedules'=>[]]); out(200,$j);
}

/* -------- optional helper -------- */
if ($fn==='upcoming'){
  $qs = http_build_query(['startDate'=>date(DATE_ATOM),'limit'=>$limit,'expand'=>'artist,presenter']);
  [$j,$e] = req(RC_API.'/stations/'.rawurlencode($stationId).'/schedules/upcoming?'.$qs,$auth);
  if($e) out(502,['error'=>'Upstream','detail'=>$e]);
  out(200,$j);
}

out(400,['error'=>'Unknown fn']);
