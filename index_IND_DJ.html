<?php
// rc-proxy.php â€” Radio Cult + Bandcamp oEmbed passthrough
// Put this file next to dj-selects.html

declare(strict_types=1);
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Headers: Authorization, Content-Type, Accept, Origin');
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') { exit; }

$fn          = $_GET['fn']          ?? '';
$stationId   = $_GET['stationId']   ?? '';
$artistId    = $_GET['id']          ?? ($_GET['artistId'] ?? ($_GET['artist_id'] ?? ''));
$presenterId = $_GET['id']          ?? ($_GET['presenterId'] ?? ($_GET['presenter_id'] ?? ''));
$startDate   = $_GET['startDate']   ?? '';
$endDate     = $_GET['endDate']     ?? '';
$limit       = $_GET['limit']       ?? '200';
$expand      = $_GET['expand']      ?? ''; // e.g. 'tags'
$apiKey      = $_GET['apiKey']      ?? '';

define('RC_API', 'https://api.radiocult.fm/v1'); // change only if RC gives another base

function go($url, $headers = []) {
  $ch = curl_init($url);
  curl_setopt_array($ch, [
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_FOLLOWLOCATION => true,
    CURLOPT_TIMEOUT => 25,
    CURLOPT_CONNECTTIMEOUT => 10,
    CURLOPT_HTTPHEADER => array_merge(['Accept: application/json','User-Agent: CCR-Proxy/1.0'], $headers)
  ]);
  $out = curl_exec($ch);
  $err = curl_error($ch);
  $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
  curl_close($ch);

  if ($err || $code >= 400 || $out === false) {
    http_response_code(502);
    header('Content-Type: application/json; charset=utf-8');
    echo json_encode(['error' => 'Upstream error', 'status'=>$code, 'detail'=>$err, 'url'=>$url], JSON_UNESCAPED_SLASHES);
    exit;
  }
  header('Content-Type: application/json; charset=utf-8');
  echo $out; exit;
}

function go_first($urls, $headers=[]){
  foreach ($urls as $u){
    $ch = curl_init($u);
    curl_setopt_array($ch, [
      CURLOPT_RETURNTRANSFER => true,
      CURLOPT_FOLLOWLOCATION => true,
      CURLOPT_TIMEOUT => 20,
      CURLOPT_CONNECTTIMEOUT => 8,
      CURLOPT_HTTPHEADER => array_merge(['Accept: application/json','User-Agent: CCR-Proxy/1.0'], $headers)
    ]);
    $out = curl_exec($ch);
    $err = curl_error($ch);
    $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    if (!$err && $out !== false && $code < 400) {
      header('Content-Type: application/json; charset=utf-8');
      echo $out; exit;
    }
  }
  http_response_code(502);
  header('Content-Type: application/json; charset=utf-8');
  echo json_encode(['error'=>'Upstream error', 'tried'=>$urls], JSON_UNESCAPED_SLASHES);
  exit;
}

/* ---------- Bandcamp ---------- */
if ($fn === 'bandcamp_oembed') {
  $url = $_GET['url'] ?? '';
  if (!$url) { header('Content-Type: application/json'); echo json_encode(['error'=>'Missing url']); exit; }
  $o = 'https://bandcamp.com/oembed?url='.rawurlencode($url).'&format=json';
  go($o, ['Accept: application/json']);
}

/* ---------- Ping ---------- */
if ($fn === 'ping') { header('Content-Type: application/json'); echo json_encode(['pong'=>'ok']); exit; }

/* ---------- Require station for RC endpoints ---------- */
if (!$stationId && !in_array($fn, ['bandcamp_oembed','ping','artist','presenter'])) {
  header('Content-Type: application/json'); echo json_encode(['error'=>'Missing stationId']); exit;
}

$h = [];
if ($apiKey) $h[] = 'Authorization: Bearer '.$apiKey;

/* ---------- Lists (allow expand=tags) ---------- */
if ($fn === 'artists') {
  $qs = http_build_query(array_filter(['limit'=>$limit, 'expand'=>$expand]));
  go(RC_API."/stations/".rawurlencode($stationId)."/artists".($qs?"?".$qs:""), $h);
}
if ($fn === 'presenters') {
  $qs = http_build_query(array_filter(['limit'=>$limit, 'expand'=>$expand]));
  go(RC_API."/stations/".rawurlencode($stationId)."/presenters".($qs?"?".$qs:""), $h);
}

/* ---------- Single detail (try both common patterns) ---------- */
if ($fn === 'artist') {
  if (!$artistId) { header('Content-Type: application/json'); echo json_encode(['error'=>'Missing id']); exit; }
  $qs = http_build_query(array_filter(['expand'=>$expand]));
  $urls = [
    RC_API."/artists/".rawurlencode($artistId).($qs?"?".$qs:""),
    RC_API."/stations/".rawurlencode($stationId)."/artists/".rawurlencode($artistId).($qs?"?".$qs:""),
  ];
  go_first($urls, $h);
}
if ($fn === 'presenter') {
  if (!$presenterId) { header('Content-Type: application/json'); echo json_encode(['error'=>'Missing id']); exit; }
  $qs = http_build_query(array_filter(['expand'=>$expand]));
  $urls = [
    RC_API."/presenters/".rawurlencode($presenterId).($qs?"?".$qs:""),
    RC_API."/stations/".rawurlencode($stationId)."/presenters/".rawurlencode($presenterId).($qs?"?".$qs:""),
  ];
  go_first($urls, $h);
}

/* ---------- Schedules ---------- */
if ($fn === 'artist_schedule') {
  if (!$artistId) { header('Content-Type: application/json'); echo json_encode(['schedules'=>[]]); exit; }
  $qs = http_build_query([
    'artistId'=>$artistId,
    'startDate'=>$startDate ?: date(DATE_ATOM),
    'endDate'=>$endDate ?: date(DATE_ATOM, time()+3600*24*365),
    'limit'=>$limit
  ]);
  go(RC_API."/stations/".rawurlencode($stationId)."/schedules?".$qs, $h);
}
if ($fn === 'presenter_schedule') {
  if (!$presenterId) { header('Content-Type: application/json'); echo json_encode(['schedules'=>[]]); exit; }
  $qs = http_build_query([
    'presenterId'=>$presenterId,
    'startDate'=>$startDate ?: date(DATE_ATOM),
    'endDate'=>$endDate ?: date(DATE_ATOM, time()+3600*24*365),
    'limit'=>$limit
  ]);
  go(RC_API."/stations/".rawurlencode($stationId)."/schedules?".$qs, $h);
}

/* ---------- Upcoming (optional helper) ---------- */
if ($fn === 'upcoming') {
  $qs = http_build_query(['startDate'=>date(DATE_ATOM), 'limit'=>$limit, 'expand'=>'artist,presenter']);
  go(RC_API."/stations/".rawurlencode($stationId)."/schedules/upcoming?".$qs, $h);
}

header('Content-Type: application/json'); echo json_encode(['error'=>'Unknown fn']);
