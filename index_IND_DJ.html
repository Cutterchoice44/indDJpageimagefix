<?php
// GET  ?action=load  → { "tracks":[...] } from dj-selects-data.json (or fallback)
// POST ?action=save  → updates only "tracks" (preserves other fields), creates file
//                      if missing, and returns explicit diagnostics on failure.

@ini_set('display_errors', '0');
error_reporting(0);

header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-store, must-revalidate');
header('Access-Control-Allow-Origin: *');

$PREFERRED_STORE = __DIR__ . '/dj-selects-data.json';
$ALT_STORE       = __DIR__ . '/dj-selects-config.json';
$ADMIN_HASH_HEX  = '446b03243337b8bb55581f2c94647468d02b9dc09aa07968701be1f65071599e';

$action = isset($_GET['action']) ? strtolower($_GET['action']) : 'load';

function safe_tracks($arr){
  $out = [];
  foreach ((array)$arr as $u) {
    $u = trim((string)$u);
    if ($u === '') continue;
    if (!preg_match('~^https?://~i', $u)) continue;
    $out[] = $u;
  }
  return array_values(array_unique($out));
}

function ensure_store($path){
  if (!file_exists($path)) {
    @file_put_contents($path, json_encode(['tracks'=>[]], JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES));
    @chmod($path, 0664);
  }
  return realpath($path);
}
function read_store($primary, $alt){
  $try = file_exists($primary) ? $primary : (file_exists($alt) ? $alt : $primary);
  $resolved = ensure_store($try);
  $json = @file_get_contents($resolved);
  $data = json_decode($json, true);
  if (!is_array($data)) $data = [];
  if (!isset($data['tracks'])) $data['tracks'] = [];
  $data['tracks'] = safe_tracks($data['tracks']);
  return [$resolved, $data];
}
function write_store($primary, $alt, $data, &$diag){
  $payload = json_encode($data, JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES);
  $targets = [$primary, $alt];

  foreach ($targets as $t) {
    $resolved = ensure_store($t);
    $dir = dirname($resolved);
    $canDir  = is_writable($dir);
    $canFile = is_writable($resolved);
    if (!$canFile && $canDir) { @chmod($resolved, 0664); $canFile = is_writable($resolved); }

    if ($canDir && $canFile) {
      $ok = @file_put_contents($resolved, $payload, LOCK_EX);
      if ($ok !== false) { $diag = ['path'=>$resolved,'used'=>'ok']; return true; }
    }
    $diag = ['path'=>$resolved,'dirWritable'=>$canDir,'fileWritable'=>$canFile,'used'=>'failed'];
  }
  return false;
}

if ($action === 'load') {
  list($path, $data) = read_store($PREFERRED_STORE, $ALT_STORE);
  echo json_encode(['tracks'=>$data['tracks'],'path'=>$path], JSON_UNESCAPED_SLASHES);
  exit;
}

if ($action === 'save') {
  $raw = file_get_contents('php://input');
  $body = json_decode($raw, true);
  if (!is_array($body)) $body = $_POST;

  $auth = isset($body['auth']) ? (string)$body['auth'] : '';
  if ($auth !== $ADMIN_HASH_HEX) {
    http_response_code(403);
    echo json_encode(['error'=>'Forbidden'], JSON_UNESCAPED_SLASHES);
    exit;
  }

  $newTracks = safe_tracks($body['tracks'] ?? []);
  list($_p, $data) = read_store($PREFERRED_STORE, $ALT_STORE);
  $data['tracks'] = $newTracks;

  $diag = [];
  $ok = write_store($PREFERRED_STORE, $ALT_STORE, $data, $diag);
  if (!$ok) {
    http_response_code(500);
    echo json_encode(['error'=>'Write failed (check file/dir permissions)','detail'=>$diag], JSON_UNESCAPED_SLASHES);
    exit;
  }

  echo json_encode(['ok'=>true, 'tracks'=>$newTracks, 'detail'=>$diag], JSON_UNESCAPED_SLASHES);
  exit;
}

http_response_code(400);
echo json_encode(['error'=>'Unsupported action'], JSON_UNESCAPED_SLASHES);
