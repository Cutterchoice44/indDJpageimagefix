<?php
// dj-selects-config.php
// Simple JSON loader for DJ Selects track URLs.
// Response: { "tracks": [ "https://youtu.be/...", "https://artist.bandcamp.com/track/..." ] }

header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-store, must-revalidate');
header('Access-Control-Allow-Origin: *');

$store = __DIR__ . '/dj-selects-config.json';
$action = isset($_GET['action']) ? strtolower($_GET['action']) : 'load';

function safe_tracks($arr){
  $out = [];
  foreach ((array)$arr as $u) {
    $u = trim((string)$u);
    if ($u === '') continue;
    // only allow http(s)
    if (!preg_match('~^https?://~i', $u)) continue;
    $out[] = $u;
  }
  return array_values(array_unique($out));
}

if ($action === 'load') {
  if (!is_file($store)) {
    // create a minimal default file (empty list) so first load succeeds
    file_put_contents($store, json_encode(['tracks'=>[]], JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES));
  }
  $data = json_decode(@file_get_contents($store), true);
  if (!is_array($data)) $data = ['tracks'=>[]];
  $data['tracks'] = safe_tracks($data['tracks'] ?? []);
  echo json_encode(['tracks'=>$data['tracks']], JSON_UNESCAPED_SLASHES);
  exit;
}

// (optional) future write support behind a shared secret; disabled by default
http_response_code(400);
echo json_encode(['error'=>'Unsupported action'], JSON_UNESCAPED_SLASHES);
