<?php
// Radio Cult proxy -> https://api.radiocult.fm with x-api-key + stationId
header('Content-Type: application/json; charset=utf-8');
header('Access-Control-Allow-Origin: *');
header('Cache-Control: public, max-age=60, s-maxage=60');

$envKey = getenv('RC_PUBLISHABLE_KEY');
$key = $_GET['key'] ?? $envKey ?? 'pk_0b8abc6f834b444f949f727e88a728e0';

$fn        = $_GET['fn'] ?? '';
$stationId = $_GET['stationId'] ?? '';
$startDate = $_GET['startDate'] ?? ($_GET['from'] ?? '');
$endDate   = $_GET['endDate']   ?? ($_GET['to']   ?? '');
$artistId  = $_GET['artistId'] ?? '';

if (!preg_match('/^pk_[A-Za-z0-9]+$/', $key)) {
  http_response_code(400); echo json_encode(['error'=>'bad_key']); exit;
}
if (!preg_match('/^[A-Za-z0-9-_.]{3,}$/', $stationId)) {
  http_response_code(400); echo json_encode(['error'=>'bad_stationId']); exit;
}

$base = "https://api.radiocult.fm/api/station/$stationId";

switch ($fn) {
  case 'artists':           $url = "$base/artists"; break;
  case 'schedule_live':     $url = "$base/schedule/live"; break;
  case 'upcoming':          // NEW: most reliable for “next show”
    $limit = intval($_GET['limit'] ?? 50);
    $url = "$base/schedule/upcoming?limit=$limit&expand=artist";
    break;
  case 'schedule_range':
    if (!$startDate || !$endDate) { http_response_code(400); echo json_encode(['error'=>'missing_dates']); exit; }
    $url = "$base/schedule?startDate=".rawurlencode($startDate)."&endDate=".rawurlencode($endDate)."&expand=artist";
    break;
  case 'artist_schedule':
    if (!preg_match('/^[A-Za-z0-9_-]{6,}$/', $artistId)) { http_response_code(400); echo json_encode(['error'=>'bad_artistId']); exit; }
    if (!$startDate || !$endDate) { http_response_code(400); echo json_encode(['error'=>'missing_dates']); exit; }
    $url = "$base/artists/$artistId/schedule?startDate=".rawurlencode($startDate)."&endDate=".rawurlencode($endDate);
    break;
  default:
    http_response_code(400); echo json_encode(['error'=>'bad_fn']); exit;
}

$ch = curl_init($url);
curl_setopt_array($ch, [
  CURLOPT_RETURNTRANSFER => true,
  CURLOPT_HTTPHEADER => [
    'x-api-key: ' . $key,
    'Accept: application/json'
  ],
  CURLOPT_USERAGENT => 'CuttersChoiceRadio-Proxy/2.1',
  CURLOPT_TIMEOUT => 15,
]);

$out  = curl_exec($ch);
$http = curl_getinfo($ch, CURLINFO_HTTP_CODE);
$err  = curl_error($ch);
curl_close($ch);

if ($out === false) {
  http_response_code(502); echo json_encode(['error'=>'proxy_failed','detail'=>$err]); exit;
}

$json = json_decode($out, true);
if ($json === null && json_last_error() !== JSON_ERROR_NONE) {
  http_response_code($http ?: 200);
  echo json_encode(['error'=>'upstream_non_json','status'=>$http,'body'=>substr($out,0,2048)]);
  exit;
}

http_response_code($http ?: 200);
echo json_encode($json);
