<?php
// rc-proxy.php â€” Radio Cult + Bandcamp oEmbed passthrough
// Place in the same folder as dj-selects.html

declare(strict_types=1);
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Headers: Authorization, Content-Type, Accept, Origin');
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') { exit; }

$fn        = $_GET['fn']        ?? '';
$stationId = $_GET['stationId'] ?? '';
$artistId  = $_GET['artistId']  ?? ($_GET['artist_id'] ?? '');
$presenterId = $_GET['presenterId'] ?? ($_GET['presenter_id'] ?? '');
$startDate = $_GET['startDate'] ?? '';
$endDate   = $_GET['endDate']   ?? '';
$limit     = $_GET['limit']     ?? '200';
$apiKey    = $_GET['apiKey']    ?? '';

define('RC_API', 'https://api.radiocult.fm/v1'); // adjust if RC gives you another base

function go($url, $headers = []) {
  $ch = curl_init($url);
  curl_setopt_array($ch, [
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_FOLLOWLOCATION => true,
    CURLOPT_TIMEOUT => 25,
    CURLOPT_CONNECTTIMEOUT => 10,
    CURLOPT_HTTPHEADER => array_merge(['Accept: application/json','User-Agent: CCR-Proxy/1.0'], $headers)
  ]);
  $out = curl_exec($ch);
  $err = curl_error($ch);
  $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
  curl_close($ch);

  if ($err || $code >= 400 || $out === false) {
    http_response_code(502);
    echo json_encode(['error' => 'Upstream error', 'status'=>$code, 'detail'=>$err, 'url'=>$url], JSON_UNESCAPED_SLASHES);
    exit;
  }
  header('Content-Type: application/json; charset=utf-8');
  echo $out; exit;
}

if ($fn === 'ping') { echo json_encode(['pong'=>'ok']); exit; }

if ($fn === 'bandcamp_oembed') {
  $url = $_GET['url'] ?? '';
  if (!$url) { echo json_encode(['error'=>'Missing url']); exit; }
  $o = 'https://bandcamp.com/oembed?url='.rawurlencode($url).'&format=json';
  go($o, ['Accept: application/json']);
}

if (!$stationId && $fn !== 'bandcamp_oembed') {
  echo json_encode(['error'=>'Missing stationId']); exit;
}

$h = [];
if ($apiKey) $h[] = 'Authorization: Bearer '.$apiKey;

/* ------- Artists / Presenters lists ------- */
if ($fn === 'artists') {
  go(RC_API."/stations/".rawurlencode($stationId)."/artists?limit=".$limit, $h);
}
if ($fn === 'presenters') {
  go(RC_API."/stations/".rawurlencode($stationId)."/presenters?limit=".$limit, $h);
}

/* ------- Schedules (by artist or presenter) ------- */
if ($fn === 'artist_schedule') {
  if (!$artistId) { echo json_encode(['schedules'=>[]]); exit; }
  $qs = http_build_query([
    'artistId'=>$artistId,
    'startDate'=>$startDate ?: date(DATE_ATOM),
    'endDate'=>$endDate ?: date(DATE_ATOM, time()+3600*24*365),
    'limit'=>$limit
  ]);
  go(RC_API."/stations/".rawurlencode($stationId)."/schedules?".$qs, $h);
}
if ($fn === 'presenter_schedule') {
  if (!$presenterId) { echo json_encode(['schedules'=>[]]); exit; }
  $qs = http_build_query([
    'presenterId'=>$presenterId,
    'startDate'=>$startDate ?: date(DATE_ATOM),
    'endDate'=>$endDate ?: date(DATE_ATOM, time()+3600*24*365),
    'limit'=>$limit
  ]);
  go(RC_API."/stations/".rawurlencode($stationId)."/schedules?".$qs, $h);
}

/* ------- Upcoming schedules (not required by the page, but handy) ------- */
if ($fn === 'upcoming') {
  $qs = http_build_query(['startDate'=>date(DATE_ATOM), 'limit'=>$limit, 'expand'=>'artist,presenter']);
  go(RC_API."/stations/".rawurlencode($stationId)."/schedules/upcoming?".$qs, $h);
}

echo json_encode(['error'=>'Unknown fn']);
