<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <!-- Prevent browser caching -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Enable Cast -->
  <meta name="google-cast-enabled" content="true">

  <title>Cutters Choice Radio</title>
  <link rel="canonical" href="https://cutterschoiceradio.com/">
  <meta name="description" content="Cutters Choice Radio — underground, community-driven electronic music: breakbeat, bass, rave and more. Listen live 24/7.">
  <meta name="robots" content="index, follow">
  <meta name="theme-color" content="#5A8785">

  <!-- Social preview (Open Graph + Twitter) -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Cutters Choice Radio">
  <meta property="og:description" content="Underground, community-driven electronic music: breakbeat, bass, rave and more. Listen live 24/7.">
  <meta property="og:url" content="https://cutterschoiceradio.com/">
  <meta property="og:site_name" content="Cutters Choice Radio">
  <meta property="og:image" content="https://cutterschoiceradio.com/images/logo.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Cutters Choice Radio">
  <meta name="twitter:description" content="Underground, community-driven electronic music: breakbeat, bass, rave and more. Listen live 24/7.">
  <meta name="twitter:image" content="https://cutterschoiceradio.com/images/logo.png">

  <!-- Performance hints -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin>
  <link rel="preconnect" href="https://app.radiocult.fm" crossorigin>
  <link rel="preconnect" href="https://cdn.socket.io" crossorigin>

  <!-- Preload likely-LCP (logo) -->
  <link rel="preload" href="/images/logo.png" as="image" imagesrcset="/images/logo.png 1x">

  <!-- Main stylesheet -->
  <link rel="stylesheet" href="style.css?v=1757106631679">

  <!-- Bebas Neue & FontAwesome -->
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- INLINE NAV + HEADER + MOBILE TUNING -->
  <style>
    :root { --brand-teal: #5A8785; --wave-height-desktop: 120px; --wave-height-mobile: 80px; }

    /* NAV BAR */
    #main-nav{
      display:flex !important; align-items:center !important; gap:.5rem !important;
      width:100% !important; padding:.10rem .65rem !important; margin:0 !important;
      box-sizing:border-box !important; background-color:var(--brand-teal) !important;
      position:relative !important; z-index:1000 !important; border-top:2px solid #000; border-bottom:2px solid #000;
      flex-wrap:nowrap;
    }
    #main-nav .nav-menu{
      display:flex !important; align-items:center !important; justify-content:space-evenly !important;
      gap:clamp(.25rem,2vw,1.5rem) !important; flex:1 1 auto !important; min-width:0 !important;
    }
    #main-nav a.nav-link, #main-nav button.nav-link, #main-nav summary.nav-link{
      color:#fff !important; font-family:'Bebas Neue',sans-serif !important; font-size:2rem !important;
      text-transform:uppercase !important; text-decoration:none !important; white-space:nowrap !important;
      list-style:none !important; cursor:pointer !important; display:inline-flex; align-items:center;
    }
    .nav-details{ position:relative; }
    .nav-details .about-panel{
      position:absolute; top:calc(100% + 8px); right:0; width:min(520px, 86vw);
      background:#000; color:#fff; border:2px solid var(--brand-teal); border-radius:8px;
      padding:.75rem .9rem; line-height:1.35; box-shadow:0 8px 18px rgba(0,0,0,.45); display:none; z-index:1100;
    }
    .nav-details[open] .about-panel{ display:block; }
    .nav-details > summary::-webkit-details-marker{ display:none; }
    .nav-details > summary:focus{ outline:2px solid #fff; outline-offset:2px; }
    #main-nav .nav-actions{ display:flex !important; align-items:center !important; justify-content:flex-end !important; gap:.6rem !important; flex:0 0 auto !important; }
    #main-nav .social-icon{ display:inline-flex !important; align-items:center !important; justify-content:center !important; line-height:1 !important; text-decoration:none !important; color:#fff !important; }
    #main-nav .social-icon i{ font-size:2.1rem !important; }
    .icon-img{ width:2.6rem !important; height:auto !important; margin-left:.25rem !important; vertical-align:middle !important; display:inline-block !important; }
    #main-nav .nav-onemusic img{ max-height:2rem; width:auto; height:auto; display:block; }

    /* HEADER layout */
    .header-banner{
      position:relative; display:flex; align-items:center; justify-content:space-between;
      gap:0; background:#000; padding:clamp(12px, 3vw, 24px) 0;
      overflow:hidden; isolation:isolate; flex-wrap:nowrap;
    }
    @media (max-width:768px){ .header-banner{ flex-wrap:wrap; gap:4px; } }

    .header-gif-right, .header-gif-left{ display:none !important; }

    .header-wave{
      flex:1 1 0; width:auto; min-width:60px;
      height:var(--wave-height-desktop);
      display:block; object-fit:cover;
      border-top:2px solid #000; border-bottom:2px solid #000; background:#000;
    }
    @media (max-width:768px){ .header-wave{ height:var(--wave-height-mobile); min-width:40px; } }

    .header-banner .title{ flex:0 1 auto; text-align:center; padding:0 .25rem; min-width:260px; }
    @media (max-width:768px){ .header-banner .title{ min-width:180px; } }

    .logo{ width:160px; height:160px; aspect-ratio:1/1; margin:0; }

    .schedule, .mixcloud{ content-visibility:auto; contain-intrinsic-size: 800px 600px; }

    /* ===== MOBILE ONLY ================================================= */
    @media (max-width: 768px){
      :root{ --wave-height-mobile: 110px; }
      .header-banner{ padding:10px 0 6px; }
      .logo{ width:120px; height:120px; }
      .header-banner .title h1{ font-size:9.2vw; line-height:1; margin:0; }
      .header-banner .title .tagline{ font-size:4vw; margin-top:4px; }

      #main-nav{
        flex-direction:row;
        flex-wrap:wrap;
        align-items:center !important;
        gap:.25rem !important;
      }
      #main-nav .nav-menu{
        order:1; width:100%;
        justify-content:space-between !important;
        gap:.2rem !important;
        flex-wrap:wrap;
      }
      #main-nav a.nav-link{
        font-size:.95rem !important;
        padding:.1rem .22rem;
        letter-spacing:.02em;
      }

      .nav-details{
        order:2; flex:1 1 50%;
        display:flex; align-items:center;
      }
      .nav-details > summary.nav-link{
        font-size:.95rem !important;
        padding:.28rem .5rem;
        background:rgba(0,0,0,.15);
        border:1px solid rgba(255,255,255,.28);
        border-radius:999px;
        margin:0;
        width:max-content;
      }
      .nav-details .about-panel{ width:calc(100vw - 22px); right:-6px; }

      #main-nav .nav-actions{
        order:2; flex:1 1 50%;
        justify-content:flex-end !important;
        align-items:center !important;
        gap:.45rem !important;
      }
      #main-nav .social-icon i{ font-size:1.25rem !important; }
      .icon-img, .nav-onemusic{ display:none !important; }

      #manualCastBtn.nav-link{ font-size:.95rem !important; padding:.28rem .5rem; }
      google-cast-button#castBtn{ transform:scale(0.78); transform-origin:right center; }

      #main-nav a.nav-link,
      #main-nav button.nav-link,
      #main-nav summary.nav-link{
        font-size:.95rem !important;
        line-height:1 !important;
        padding:.28rem .5rem !important;
      }

      #main-nav + div[style*="height:2px"]{ margin-top:2px; }

      .player-container #chatPopupBtn{ position:static; margin-top:.5rem; }
    }
    /* =================================================================== */

    @media (prefers-reduced-motion: reduce){
      .header-wave{ display:none !important; }
      .header-banner{ justify-content:center; }
    }

    /* ===============================
       CCR TV PLAYER STABILITY RULES
       =============================== */
    .tv-wrapper {
      position: relative;
      width: 100%;
      max-width: 720px;
      aspect-ratio: 16 / 9;
      background: #000;
      overflow: hidden;
    }
    #ccrTv {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover; /* use 'contain' if you prefer letterbox */
      background: #000;
      display: block;
    }
  </style>

  <!-- Chromecast Init & SDK -->
  <script>
    window.__onGCastApiAvailable = isAvailable => {
      if (isAvailable) {
        cast.framework.CastContext.getInstance().setOptions({
          receiverApplicationId: '77E0F81B',
          autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
        });
      }
    };
  </script>
  <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

  <!-- Other head scripts -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js" defer></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-3MSGZZ5QL6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}  
    gtag('js', new Date());
    gtag('config', 'G-3MSGZZ5QL6');
  </script>

  <!-- Site-wide Organization JSON-LD -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "Cutters Choice Radio",
    "url": "https://cutterschoiceradio.com",
    "logo": "https://cutterschoiceradio.com/images/logo.png",
    "sameAs": [
      "https://www.instagram.com/cutterschoiceradio",
      "https://www.facebook.com/cutterschoiceradio",
      "https://www.mixcloud.com/cutterschoiceradio",
      "https://tunein.com/radio/Cutters-Choice-Radio-s344746/"
    ]
  }
  </script>
</head>

<body>
  <!-- HEADER -->
  <header class="header-banner" role="banner">
    <div class="header-gif-right"></div>
    <div class="header-gif-left"></div>

    <div class="logo-container">
      <img class="logo" src="/images/logo.png" alt="Cutters Choice Radio Logo" loading="eager" decoding="async" width="160" height="160" fetchpriority="high">
    </div>

    <!-- WEBM wave between left logo and titles -->
    <video class="header-wave header-wave-left" aria-hidden="true" muted loop autoplay playsinline preload="metadata">
      <source src="/images/audiowave.webm" type="video/webm">
    </video>

    <div class="title">
      <h1>Cutters Choice Radio</h1>
      <p class="tagline">The home of relentless flavas and significant bangers!</p>
    </div>

    <!-- WEBM wave between titles and right logo -->
    <video class="header-wave header-wave-right" aria-hidden="true" muted loop autoplay playsinline preload="metadata">
      <source src="/images/audiowave.webm" type="video/webm">
    </video>

    <div class="logo-container">
      <img class="logo" src="/images/logo.png" alt="Cutters Choice Radio Logo" loading="eager" decoding="async" width="160" height="160">
    </div>
  </header>

  <div style="height:2px;background-color:var(--brand-teal);"></div>

  <!-- NAVIGATION -->
  <nav id="main-nav" aria-label="Primary">
    <div class="nav-menu">
      <a href="our-story.html"    class="nav-link">OUR STORY</a>
      <a href="index-ourDJS.html" class="nav-link">OUR DJS</a>
      <a href="dj-selects.html"   class="nav-link">DJ SELECTS</a>
      <a href="cutty-ranks.html"  class="nav-link">CUTTY RANKS</a>
      <a href="schedule.html"     class="nav-link">SCHEDULE</a>
      <a href="merch.html"        class="nav-link">MERCH</a>

      <!-- ABOUT THE STATION -->
      <details class="nav-details" id="about-overlay">
        <summary class="nav-link" aria-label="About the station">ABOUT THE STATION</summary>
        <div class="about-panel" id="about-station-content">
          <p>
            Cutters Choice Radio is a community of resident DJs and selectors broadcasting across underground music of all genres, representing bass and rave culture. Explore each profile for bios, mixes and show times, and discover new artists on our weekly schedule.
          </p>
        </div>
      </details>
    </div>

    <div class="nav-actions">
      <a href="https://facebook.com/cutterschoiceradio"  target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Facebook">
        <i class="fab fa-facebook-f"></i>
      </a>
      <a href="https://instagram.com/cutterschoiceradio" target="_blank" rel="noopener noreferrer" class="social-icon" aria-label="Instagram">
        <i class="fab fa-instagram"></i>
      </a>

      <!-- Alexa logo -->
      <img src="/images/alexa-logo.webp" alt="Alexa" class="icon-img" loading="lazy" decoding="async" width="42" height="42">

      <!-- TuneIn logo -->
      <a href="https://tunein.com/radio/Cutters-Choice-Radio-s344746/" target="_blank" rel="noopener noreferrer" aria-label="TuneIn">
        <img src="/images/tunein-logo.png" alt="TuneIn" class="icon-img" loading="lazy" decoding="async" width="42" height="42">
      </a>

      <!-- OneMusic badge -->
      <div class="nav-onemusic">
        <a href="https://onemusicnz.com" target="_blank" rel="noopener noreferrer">
          <img src="/images/ONEMUSICLOGO.png" alt="We’re licensed to play OneMusic NZ" loading="lazy" decoding="async" width="120" height="40">
        </a>
      </div>

      <!-- Cast controls -->
      <google-cast-button id="castBtn" title="Cast"></google-cast-button>
      <button id="manualCastBtn" class="nav-link" type="button" title="Cast this stream" aria-label="Cast this stream">CAST</button>
    </div>
  </nav>

  <div style="height:2px;background-color:var(--brand-teal);"></div>

  <!-- MAIN GRID CONTENT -->
  <div class="grid-container">
    <!-- CHAT SECTION -->
    <section class="chat" aria-labelledby="chat-heading">
      <h2 id="chat-heading">Cutters Chat</h2>
      <iframe title="Cutters Choice Radio Chat"
              src="https://app.radiocult.fm/embed/chat/cutters-choice-radio?theme=midnight&primaryColor=%235A8785&corners=sharp"
              width="100%" height="700" frameborder="0"
              allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
              loading="lazy" seamless>
      </iframe>
      <div class="chat-actions"><button class="popout-btn" onclick="openChatPopup()">Pop Out Chat</button></div>
      <div class="rc-user-list-container"><div class="rc-user-list"></div></div>
    </section>

    <!-- LIVE PLAYER SECTION -->
    <section class="live-player" aria-labelledby="now-dj">
      <h2 id="now-dj">Now Playing: Live</h2>

      <div class="player-container">
        <!-- RadioCult audio / now playing widget -->
        <iframe id="inlinePlayer" title="Cutters Choice Radio player"
                src="https://app.radiocult.fm/embed/square-player/cutters-choice-radio?theme=midnight&primaryColor=%235A8785&corners=sharp"
                allow="autoplay; encrypted-media" loading="lazy"></iframe>

        <!-- text under radio player -->
        <div id="now-archive" role="status" aria-live="polite">Loading archive show…</div>

        <!-- popouts -->
        <button id="popOutBtn" class="popout-btn">Pop Out Player</button>
        <button id="chatPopupBtn" class="popout-btn chat-btn-mobile" onclick="openChatPopup()">Chat</button>

        <!-- CCR TV AUTO VIDEO FEED (HLS over HTTPS) -->
        <div class="tv-wrapper">
          <video
            id="ccrTv"
            playsinline
            muted
            controls
            preload="none"
            poster="/images/archives-logo.jpeg"
          ></video>
        </div>
      </div>
    </section>

    <!-- SCHEDULE SECTION -->
    <section class="schedule" aria-labelledby="schedule-heading">
      <h2 class="schedule-heading" id="schedule-heading">This Week’s Lineup</h2>
      <div class="schedule-scroll" id="schedule-container">
        <p>Loading this week’s schedule…</p>
      </div>
    </section>

    <!-- MIXCLOUD ARCHIVE SECTION -->
    <section class="mixcloud" aria-labelledby="mixcloud-heading">
      <h2 id="mixcloud-heading">Latest Archived Shows</h2>
      <div id="mixcloud-list"></div>
      <div class="add-mixcloud">
        <input id="mixcloud-url" type="text" placeholder="Paste Mixcloud URL here…">
        <button onclick="addMixcloud()">Add Show</button>
      </div>
    </section>
  </div>

  <!-- FOOTER -->
  <footer class="banner">
    <div style="
      background-color: var(--brand-teal);
      padding: 0.10rem 0.65rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    ">
      <a href="privacy-policy.html"
         style="
           color: #fff;
           font-family: 'Bebas Neue', sans-serif;
           font-size: 2rem;
           text-transform: uppercase;
           text-decoration: none;
         ">PRIVACY POLICY</a>
      <span style="
        color: #fff;
        font-family: 'Bebas Neue', sans-serif;
        font-size: 0.8rem;
        text-transform: uppercase;
      ">
        Amazon, Alexa and all related logos are trademarks of Amazon.com, Inc. or its affiliates.
      </span>
    </div>
  </footer>

  <!-- YOUR SCRIPTS -->
  <script src="script.js?v=1757106631679" defer></script>
  <script src="slideshow.js?v=1757106631679" defer></script>

  <!-- Move MERCH to bottom nav row on mobile, restore on desktop -->
  <script>
    (function(){
      const mq = window.matchMedia('(max-width: 768px)');
      const navMenu    = document.querySelector('#main-nav .nav-menu');
      const navActions = document.querySelector('#main-nav .nav-actions');
      const merchLink  = document.querySelector('#main-nav .nav-menu a.nav-link[href$="merch.html"]');

      if (!navMenu || !navActions || !merchLink) return;

      const anchor = document.createElement('span');
      anchor.id = 'merch-return-anchor';
      anchor.style.display = 'none';
      merchLink.after(anchor);

      function moveIfNeeded(e){
        const isMobile = (e && 'matches' in e) ? e.matches : mq.matches;

        if (isMobile) {
          if (!merchLink.dataset.moved) {
            navActions.insertBefore(merchLink, navActions.firstChild);
            merchLink.dataset.moved = '1';
          }
        } else {
          if (merchLink.dataset.moved) {
            anchor.before(merchLink);
            merchLink.dataset.moved = '';
          }
        }
      }

      moveIfNeeded();
      if (mq.addEventListener) mq.addEventListener('change', moveIfNeeded);
      else mq.addListener && mq.addListener(moveIfNeeded);
      window.addEventListener('orientationchange', moveIfNeeded);
    })();
  </script>

  <!-- Chromecast Handler & Manual Fallback -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const manualBtn   = document.getElementById('manualCastBtn');
      const officialBtn = document.querySelector('google-cast-button');

      function setButtonsByState(state) {
        const noDevices =
          !state ||
          state === cast.framework.CastState.NO_DEVICES_AVAILABLE ||
          state === cast.framework.CastState.NOT_CONNECTED;

        if (officialBtn) officialBtn.style.display = noDevices ? 'none' : 'inline-block';
        if (manualBtn)   manualBtn.style.display   = noDevices ? 'inline-flex' : 'none';
      }

      let sdkSeen = false;
      window.__onGCastApiAvailable = isAvailable => {
        if (!isAvailable) return;
        sdkSeen = true;
        const context = cast.framework.CastContext.getInstance();
        context.setOptions({
          receiverApplicationId: '77E0F81B',
          autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
        });

        try { setButtonsByState(context.getCastState()); } catch {}
        context.addEventListener(
          cast.framework.CastContextEventType.CAST_STATE_CHANGED,
          e => setButtonsByState(e.castState)
        );

        officialBtn?.addEventListener('click', async () => {
          const session = context.getCurrentSession();
          if (!session) return console.warn('No Chromecast session');
          const mediaInfo = new chrome.cast.media.MediaInfo(
            'https://cutters-choice-radio.radiocult.fm/stream',
            'application/x-mpegurl'
          );
          mediaInfo.streamType = chrome.cast.media.StreamType.LIVE;
          mediaInfo.metadata = new chrome.cast.media.MusicTrackMediaMetadata();
          mediaInfo.metadata.title = document.getElementById('now-dj').textContent;
          mediaInfo.metadata.albumName = 'Cutters Choice Radio';
          const request = new chrome.cast.media.LoadRequest(mediaInfo);
          try { await session.loadMedia(request); } catch (err) { console.error('Chromecast error:', err); }
        });
      };

      setTimeout(() => {
        if (!sdkSeen && manualBtn) manualBtn.style.display = 'inline-flex';
        if (!sdkSeen && officialBtn) officialBtn.style.display = 'none';
      }, 2500);

      manualBtn?.addEventListener('click', async () => {
        try {
          const context = cast.framework.CastContext.getInstance();
          await context.requestSession();
        } catch (err) {
          console.warn('Fallback session error', err);
        }
      });
    });
  </script>

  <!-- JSON-LD Events injector -->
  <script>
  (function(){
    const API_KEY = 'pk_0b8abc6f834b444f949f727e88a728e0';
    const STATION_ID = 'cutters-choice-radio';
    const DAYS_AHEAD = 7;

    const startISO = new Date().toISOString();
    const endISO   = new Date(Date.now() + DAYS_AHEAD * 24 * 60 * 60 * 1000).toISOString();

    const url = 'https://api.radiocult.fm/api/station/' + encodeURIComponent(STATION_ID) +
                '/schedule?startDate=' + encodeURIComponent(startISO) +
                '&endDate=' + encodeURIComponent(endISO) +
                '&expand=artist';

    fetch(url, { headers: { 'x-api-key': API_KEY } })
      .then(r => r.ok ? r.json() : Promise.reject(new Error('Schedule fetch failed: ' + r.status)))
      .then(data => {
        const events = Array.isArray(data?.schedules) ? data.schedules
                     : Array.isArray(data) ? data
                     : [];
        if (!events.length) return;

        const LISTEN_URL = 'https://cutterschoiceradio.com/listen';
        const ORG = {
          name: 'Cutters Choice Radio',
          url:  'https://cutterschoiceradio.com',
          logo: 'https://cutterschoiceradio.com/images/logo.png'
        };

        const items = events.map(ev => {
          const sISO = ev.startDateUtc || ev.startDate || ev.start;
          const eISO = ev.endDateUtc   || ev.endDate   || ev.end;
          const performers = (ev.artists || [])
            .map(a => a && a.name ? { '@type':'Person', name:a.name } : null)
            .filter(Boolean);

          const obj = {
            '@type': 'Event',
            name: ev.title || ev.name || 'Show',
            startDate: sISO,
            endDate:   eISO,
            eventStatus: 'https://schema.org/EventScheduled',
            eventAttendanceMode: 'https://schema.org/OnlineEventAttendanceMode',
            location: { '@type': 'VirtualLocation', url: LISTEN_URL },
            organizer: { '@type': 'Organization', name: ORG.name, url: ORG.url, logo: ORG.logo }
          };
          if (performers.length) obj.performer = performers;
          return obj;
        });

        const script = document.createElement('script');
        script.type = 'application/ld+json';
        script.textContent = JSON.stringify({ '@context': 'https://schema.org', '@graph': items });
        document.head.appendChild(script);
      })
      .catch(err => console.warn('[CCR JSON-LD injector]', err));
  })();
  </script>

  <!-- HLS.js loader + resilient CCR TV init (cache-busted URL, stall watchdog, self-recovery) -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
  <script>
    (function(){
      const video = document.getElementById('ccrTv');
      if (!video) return;

      const STREAM_BASE = 'https://ccr-tv.cutterschoiceradio.com/ccr-tv/ccr.m3u8';
      const makeURL = () => STREAM_BASE + '?t=' + Date.now();

      // Required for autoplay on most platforms
      video.muted = true;
      video.playsInline = true;

      let hls = null;
      let userPaused = false;
      let lastActive = Date.now();

      function attemptPlay() {
        const p = video.play();
        if (p && p.catch) p.catch(()=>{});
      }

      function attachNative(url){
        video.src = url;
        video.addEventListener('loadedmetadata', attemptPlay, { once:true });
      }

      function attachHls(url){
        if (hls) { try { hls.destroy(); } catch(e){} hls = null; }
        hls = new Hls({
          lowLatencyMode: false,
          liveSyncDurationCount: 3,   // stay ~3 segments behind live
          liveMaxLatencyDurationCount: 10,
          maxBufferLength: 10,
          backBufferLength: 30,
          enableWorker: true,
          // keep these modest so we don't hang forever
          fragLoadingTimeOut: 20000,
          manifestLoadingTimeOut: 20000
        });
        hls.loadSource(url);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, attemptPlay);

        hls.on(Hls.Events.ERROR, (evt, data) => {
          if (!data?.fatal) return;
          console.warn('[CCR-TV] fatal HLS error', data.type, data.details);

          if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
            try { hls.startLoad(); } catch(e){}
          } else if (data.type === Hls.ErrorTypes.MEDIA_ERROR) {
            try { hls.recoverMediaError(); } catch(e){}
          } else {
            try { hls.destroy(); } catch(e){}
            hls = null;
            setTimeout(() => init(true), 500);
          }
        });
      }

      function init(forceFresh){
        const url = makeURL(); // always cache-bust
        if (video.canPlayType('application/vnd.apple.mpegURL')) {
          attachNative(url);
        } else if (window.Hls && window.Hls.isSupported()) {
          attachHls(url);
        } else {
          attachNative(url);
        }
      }

      // Stall watchdog: if time hasn't advanced in ~10s and user didn't pause, kick loader
      const STALL_MS = 10000;
      setInterval(() => {
        const stalled = (Date.now() - lastActive) > STALL_MS;
        const shouldBePlaying = !video.paused && !video.ended && !userPaused;
        if (stalled && shouldBePlaying) {
          console.warn('[CCR-TV] Stall detected — nudging loader');
          if (hls) {
            try { hls.stopLoad(); } catch(e){}
            try { hls.startLoad(); } catch(e){}
          } else {
            const u = makeURL();
            const t = video.currentTime || 0;
            video.src = u;
            video.currentTime = Math.max(0, t - 2);
            attemptPlay();
          }
        }
      }, 2500);

      // Track activity
      video.addEventListener('timeupdate', () => { lastActive = Date.now(); }, { passive:true });
      video.addEventListener('playing',    () => { lastActive = Date.now(); }, { passive:true });
      video.addEventListener('waiting',    () => { /* may stall; watchdog will handle */ }, { passive:true });
      video.addEventListener('pause',      () => { userPaused = true; });
      video.addEventListener('play',       () => { userPaused = false; });

      // If tab becomes visible again, kick loader
      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          if (hls) { try { hls.startLoad(); } catch(e){} }
          attemptPlay();
        }
      });

      // Boot it
      init(true);

      // Cleanup on nav away
      window.addEventListener('beforeunload', () => { try { hls?.destroy(); } catch(e){} });
    })();
  </script>
</body>
</html>
