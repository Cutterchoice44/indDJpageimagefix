<?php
// cutty-ranks-config.php
// Simple JSON storage for Cutty Ranks. Returns JSON.

header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-store, no-cache, must-revalidate');

$DATA_FILE = __DIR__ . '/cutty-ranks-data.json';
$ADMIN_HASH_HEX = '446b03243337b8bb55581f2c94647468d02b9dc09aa07968701be1f65071599e'; // must match HTML

$action = isset($_GET['action']) ? $_GET['action'] : 'load';

function fail($msg, $code=400){
  http_response_code($code);
  echo json_encode(['ok'=>false, 'error'=>$msg]);
  exit;
}

// Ensure file exists and is readable/writable (create with sane perms if missing)
if (!file_exists($DATA_FILE)) {
  $initial = json_encode(['entries'=>[]], JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES);
  if (@file_put_contents($DATA_FILE, $initial, LOCK_EX) === false) {
    fail('Cannot create data file (permissions). Place an empty cutty-ranks-data.json with write perms.', 500);
  }
  @chmod($DATA_FILE, 0664); // web user write; adjust if needed on your host
}

if ($action === 'load') {
  $raw = @file_get_contents($DATA_FILE);
  if ($raw === false) fail('Cannot read data file.', 500);

  // Validate JSON; if corrupt, reset gracefully
  $j = json_decode($raw, true);
  if (!is_array($j) || !isset($j['entries']) || !is_array($j['entries'])) {
    $j = ['entries'=>[]];
  }
  echo json_encode($j, JSON_UNESCAPED_SLASHES);
  exit;
}

if ($action === 'save') {
  $input = json_decode(file_get_contents('php://input'), true);
  if (!is_array($input)) fail('Invalid payload');

  // Simple auth: pre-shared SHA-256 hex
  if (!isset($input['auth']) || strtolower($input['auth']) !== strtolower($ADMIN_HASH_HEX)) {
    fail('Unauthorized', 401);
  }

  $entries = isset($input['entries']) && is_array($input['entries']) ? $input['entries'] : [];
  // Normalize + trim
  $clean = [];
  foreach ($entries as $e) {
    $name = isset($e['name']) ? trim($e['name']) : '';
    $links = [];
    if (isset($e['links']) && is_array($e['links'])) {
      foreach ($e['links'] as $u) {
        $u = trim($u);
        if ($u !== '') $links[] = $u;
        if (count($links) >= 5) break;
      }
    }
    if ($name !== '' || !empty($links)) {
      $clean[] = ['name'=>$name, 'links'=>$links];
    }
  }

  $json = json_encode(['entries'=>$clean], JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES);
  if ($json === false) fail('JSON encode error', 500);

  // Write atomically
  $tmp = $DATA_FILE . '.tmp';
  if (@file_put_contents($tmp, $json, LOCK_EX) === false) fail('Cannot write temp file (permissions).', 500);
  if (!@rename($tmp, $DATA_FILE)) {
    // fallback: overwrite directly
    if (@file_put_contents($DATA_FILE, $json, LOCK_EX) === false) {
      fail('Cannot write data file (permissions).', 500);
    }
  }
  @chmod($DATA_FILE, 0664);

  echo json_encode(['ok'=>true, 'entries'=>$clean], JSON_UNESCAPED_SLASHES);
  exit;
}

fail('Unknown action', 400);
