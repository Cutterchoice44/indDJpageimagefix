<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cutty Ranks â€” Cutters Choice Radio</title>

  <!-- SEO -->
  <meta name="description" content="Cutty Ranks: the best-of archive â€” YouTube picks from Cutters Choice Radio selectors.">
  <meta name="robots" content="index, follow">
  <meta name="theme-color" content="#5A8785">

  <!-- Social preview -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="Cutty Ranks â€” Cutters Choice Radio">
  <meta property="og:description" content="A best-of archive of YouTube selections from the CCR crew.">
  <meta property="og:url" content="https://cutterschoiceradio.com/cutty-ranks.html">
  <meta property="og:site_name" content="Cutters Choice Radio">
  <meta property="og:image" content="https://cutterschoiceradio.com/images/logo.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Cutty Ranks â€” Cutters Choice Radio">
  <meta name="twitter:description" content="A best-of archive of YouTube selections from the CCR crew.">
  <meta name="twitter:image" content="https://cutterschoiceradio.com/images/logo.png">

  <!-- Performance -->
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.youtube-nocookie.com" crossorigin>

  <!-- Global site styles -->
  <link rel="stylesheet" href="/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <style>
    :root{
      --brand-teal:#5A8785;
      --grid-gap:12px;

      --rail-min:220px;
      --preview-min:640px;
      --preview-max:980px;

      --tile-gap:8px;
      --tile-height:clamp(64px, 9vw, 90px);
      --tile-radius:10px;
    }

    /* ===== Header ===== */
    .header-banner{
      position:relative; display:flex; align-items:center; justify-content:center;
      padding:clamp(16px,3vw,28px) .6rem;
      background:#000 center/cover no-repeat;
      background-image:url('/images/cutty_a.png');
      border-top:2px solid #000; border-bottom:2px solid #000; isolation:isolate;
    }
    .header-banner .title{ text-align:center; }
    .header-banner .title h1{
      margin:0; font-family:'Bebas Neue',sans-serif;
      font-size:clamp(2.3rem,6.2vw,4rem); line-height:1; color:#fff;
      text-shadow:0 2px 12px rgba(0,0,0,.6);
    }
    .header-banner .title .tagline{ margin:.2rem 0 0; color:#fff; text-shadow:0 2px 10px rgba(0,0,0,.6); }
    .header-gif-right,.header-gif-left,.header-wave,.logo-container{ display:none !important; }
    .nav-sep{height:2px;background-color:var(--brand-teal);}

    /* Nav */
    #main-nav .nav-menu{ justify-content: space-evenly !important; }
    #main-nav .nav-link, #main-nav summary.nav-link{
      color:#fff !important; font-family:'Bebas Neue',sans-serif !important;
      font-size:2rem !important; text-transform:uppercase !important;
      text-decoration:none !important; white-space:nowrap !important;
      list-style:none !important; cursor:pointer !important; display:inline-flex; align-items:center;
    }
    .nav-details{ position:relative; }
    .nav-details .about-panel{
      position:absolute; top:calc(100% + 8px); right:0; width:min(520px,86vw);
      background:#000; color:#fff; border:2px solid var(--brand-teal);
      border-radius:8px; padding:.75rem .9rem; line-height:1.35;
      box-shadow:0 8px 18px rgba(0,0,0,.45); display:none; z-index:1100;
    }
    .nav-details[open] .about-panel{ display:block; }
    .nav-details > summary::-webkit-details-marker{ display:none; }

    @media (max-width:768px){
      body.cutty nav#main-nav{
        display:flex !important; flex-direction:row !important; align-items:center !important;
        justify-content:space-between !important; padding:.40rem .65rem !important;
      }
      body.cutty nav#main-nav .nav-menu{
        display:flex !important; gap:.35rem !important; flex-wrap:nowrap !important;
        overflow-x:auto !important; white-space:nowrap !important; scrollbar-width:none;
      }
      body.cutty nav#main-nav .nav-menu::-webkit-scrollbar{ display:none; }
      body.cutty nav#main-nav .nav-link, body.cutty nav#main-nav summary.nav-link{
        font-size:clamp(.8rem,3.2vw,1rem) !important; padding:.2rem .25rem !important;
      }
    }

    /* ----- Page specific ----- */
    .cutty-title{
      position:relative; border-top:2px solid var(--brand-teal); border-bottom:2px solid var(--brand-teal);
      min-height:110px; display:flex; align-items:center; justify-content:flex-start;
      padding:.35rem .6rem; background: url('/images/cutty_b.png') right center / contain no-repeat, #000;
    }
    .cutty-title::before{
      content:""; position:absolute; inset:0;
      background:linear-gradient(90deg, rgba(0,0,0,.55), rgba(0,0,0,.25) 35%, rgba(0,0,0,0));
      pointer-events:none;
    }
    .cutty-title h2{
      position:relative; z-index:1; color:#fff; font-family:'Bebas Neue',sans-serif;
      font-size:clamp(2.6rem,5.2vw,3.6rem); line-height:1; margin:0; letter-spacing:.6px;
      text-shadow:0 2px 10px rgba(0,0,0,.65);
    }

    /* ===== Main grid: 2 rails | preview | 2 rails ===== */
    .ranks-grid{
      display:grid; gap:var(--grid-gap);
      grid-template-columns:
        minmax(var(--rail-min), 0.9fr)
        minmax(var(--rail-min), 0.9fr)
        minmax(var(--preview-min), 1.8fr)
        minmax(var(--rail-min), 0.9fr)
        minmax(var(--rail-min), 0.9fr);
      align-items:start; padding:.6rem;
    }

    .rail{
      display:flex; flex-direction:column; gap:var(--grid-gap);
      height: var(--usable, 70vh);
      overflow-y:auto; padding-right:4px; scrollbar-gutter: stable;
      background:#000; border-right:2px solid rgba(90,135,133,.45);
    }
    .right-outer{ border-right:none; }

    .dj-card{ border:1px solid #264745; background:#0a0a0a; border-radius:10px; overflow:hidden; }
    .dj-card h4{
      font-family:'Bebas Neue',sans-serif; font-size:clamp(1.05rem,1.6vw,1.25rem);
      margin:0; padding:.4rem .55rem; background:#0f0f0f; border-bottom:1px solid #1f3a39; color:#fff; letter-spacing:.4px;
    }
    .track-list{ display:grid; grid-template-columns:1fr; gap:var(--tile-gap); padding:var(--tile-gap); }

    .track-tile{
      position:relative; height:var(--tile-height);
      border:1px solid #1d3533; border-radius:var(--tile-radius);
      overflow:hidden; background:#0a0a0a center/cover no-repeat;
      cursor:pointer; transition: transform .08s ease-in-out, box-shadow .12s ease-in-out;
    }
    .track-tile:hover{ transform: translateY(-1px); box-shadow:0 4px 18px rgba(0,0,0,.35); }
    .track-tile.selected{ outline:2px solid var(--brand-teal); outline-offset:-2px; }
    .track-tile::after{
      content:""; position:absolute; inset:0;
      box-shadow: inset 0 0 0 2px rgba(90,135,133,.22);
      border-radius:var(--tile-radius); pointer-events:none;
    }
    .tile-badge{
      position:absolute; top:.28rem; left:.28rem;
      background:rgba(0,0,0,.52); color:#fff; font:600 10px/1.1 system-ui;
      padding:.16rem .34rem; border-radius:999px;
    }
    .tile-play{ position:absolute; right:.32rem; bottom:.32rem; width:30px; height:30px; border-radius:999px; background:rgba(255,255,255,.16); display:grid; place-items:center; }
    .tile-play svg{ width:14px; height:14px; color:#fff; }
    .overlayBtn{ position:absolute; inset:0; appearance:none; background:transparent; border:0; cursor:pointer; }

    .preview-shell{
      position:relative;
      background:#000 center/cover no-repeat; background-image:url('/images/cutty_c.png');
      border:2px solid var(--brand-teal); border-radius:8px; padding:10px;
      display:flex; align-items:center; justify-content:center;
      height: var(--usable, 70vh); overflow:hidden;
    }
    #mainPreview{ width:100%; max-width:var(--preview-max); margin:0 auto; }
    #mainPreview iframe{ width:100%; aspect-ratio:16/9; height:auto; border:0; display:block; }
    .placeholder{ font-family:'Bebas Neue',sans-serif; color:#6fa39f; font-size:clamp(1rem,2vw,1.25rem); padding:.6rem; text-align:center; }

    /* Playlist controls in preview */
    .playlist-controls{
      position:absolute; top:10px; right:12px; display:flex; gap:8px; z-index:5;
    }
    .playlist-controls button{
      font:600 12px/1 system-ui; color:#eaffff; background:rgba(6,16,16,.8);
      border:1px solid #2a5653; border-radius:999px; padding:.45rem .65rem; cursor:pointer;
    }
    .playlist-controls button.active{ background:#0b2322; border-color:#5A8785; }

    @media (max-width:1200px){
      .ranks-grid{
        grid-template-columns:
          minmax(var(--rail-min), 0.9fr)
          minmax(var(--preview-min), 1.8fr)
          minmax(var(--rail-min), 0.9fr);
      }
      .rail.left-outer, .rail.right-outer{ display:none; }
    }
    @media (max-width:980px){
      .ranks-grid{ grid-template-columns:1fr; }
      .preview-shell{ order:1 }
      .rail{ order:2; border-right:none; }
    }

    .rail::-webkit-scrollbar{ width:10px; }
    .rail::-webkit-scrollbar-track{ background:#061010; }
    .rail::-webkit-scrollbar-thumb{ background:#274947; border-radius:10px; border:2px solid #061010; }

    /* ===== Hidden Admin Overlay ===== */
    .adminHidden{ display:none !important; }
    #adminOverlay{
      position:fixed; inset:0; background:rgba(0,0,0,.82); color:#fff; z-index:9999;
      display:flex; align-items:center; justify-content:center;
    }
    #adminPanel{
      width:min(980px,95vw); max-height:92vh; overflow:auto;
      background:#0e1414; border:2px solid var(--brand-teal); border-radius:10px; padding:16px;
      box-shadow:0 12px 40px rgba(0,0,0,.55);
    }
    #adminPanel h3{ font-family:'Bebas Neue',sans-serif; letter-spacing:.5px; margin:0 0 10px; color:#fff; }
    #adminPanel .entry{ border:1px solid #2a5653; border-radius:8px; padding:10px; margin:10px 0; background:#081111; }
    #adminPanel .row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:6px 0; }
    #adminPanel input[type="text"]{ flex:1 1 240px; min-width:200px; background:#050808; color:#eaffff; border:1px solid #2a5653; border-radius:6px; padding:8px; }
    #adminPanel label{ font-size:.95rem; opacity:.9; color:#fff; min-width:72px; }
    #adminPanel button{ padding:8px 12px; border-radius:6px; border:1px solid #2a5653; background:#0b2322; color:#eaffff; cursor:pointer; }
    #adminStatus{ opacity:.9; font-size:.9rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:52ch; margin-left:auto; }

    /* ===== MOBILE-ONLY CLEANUP ===== */
    @media (max-width:768px){
      /* remove decorative backgrounds */
      .header-banner{ background-image:none !important; }
      .cutty-title{ background:#000 !important; min-height:auto; padding:.55rem .6rem; }
      .cutty-title::before{ background:none !important; }
      .preview-shell{ background-image:none !important; padding:6px; border-width:1px; height:auto; }

      /* tighter flow + page scroll (no inner scroll boxes) */
      .ranks-grid{ grid-template-columns:1fr; gap:8px; padding:.4rem .5rem 1rem; }
      .rail{ height:auto; max-height:none; overflow:visible; background:transparent; padding-right:0; border:none; }
      .dj-card{ border-radius:8px; }
      .dj-card h4{ font-size:1rem; padding:.35rem .5rem; }

      .track-list{ padding:4px; gap:4px; }
      .track-tile{ height:clamp(56px, 24vw, 78px); border-radius:8px; }
      .tile-badge{ top:.2rem; left:.2rem; }
      .tile-play{ right:.24rem; bottom:.24rem; width:26px; height:26px; }
      #mainPreview{ max-width:100%; }
    }
  </style>

  <!-- YouTube IFrame API for playlist auto-advance -->
  <script src="https://www.youtube.com/iframe_api"></script>
</head>

<body class="cutty">
  <!-- HEADER -->
  <header class="header-banner" role="banner">
    <div class="title">
      <h1>Cutters Choice Radio</h1>
      <p class="tagline">The home of relentless flavas and significant bangers!</p>
    </div>
  </header>

  <div class="nav-sep top"></div>

  <!-- Primary Nav -->
  <nav id="main-nav" aria-label="Primary">
    <div class="nav-menu">
      <a href="/"                  class="nav-link">HOME</a>
      <a href="/our-story.html"    class="nav-link">OUR STORY</a>
      <a href="/index-ourDJS.html" class="nav-link">OUR DJS</a>
      <a href="/dj-selects.html"   class="nav-link">DJ SELECTS</a>
      <a href="/schedule.html"     class="nav-link">SCHEDULE</a>
      <a href="/merch.html"        class="nav-link">MERCH</a>

      <details class="nav-details">
        <summary class="nav-link" aria-label="About Cutty Ranks">ABOUT CUTTY RANKS</summary>
        <div class="about-panel">
          <p>Four skinny columns flank the preview. Click any tile to play in the center.</p>
        </div>
      </details>
    </div>
  </nav>

  <!-- Title band -->
  <section class="cutty-title">
    <h2>CUTTY RANKS: THE SELECTOR ARCHIVES</h2>
  </section>

  <!-- 4 rails + preview -->
  <main id="ranksGrid" class="ranks-grid" role="main">
    <aside class="rail left-inner"  id="rail-0" aria-label="Left column 1"></aside>
    <aside class="rail left-outer"  id="rail-1" aria-label="Left column 2"></aside>

    <section class="preview-shell">
      <div class="playlist-controls" aria-label="Playlist controls">
        <button id="playAllBtn" title="Play all in order">â–¶ Play All</button>
        <button id="shuffleBtn" title="Shuffle play">ðŸ”€ Shuffle</button>
      </div>
      <div id="mainPreview"><div class="placeholder">Select any tile to play here</div></div>
    </section>

    <aside class="rail right-inner" id="rail-2" aria-label="Right column 1"></aside>
    <aside class="rail right-outer" id="rail-3" aria-label="Right column 2"></aside>
  </main>

  <!-- Hidden Admin Overlay (Shift+A) -->
  <div id="adminOverlay" class="adminHidden" aria-hidden="true">
    <div id="adminPanel" role="dialog" aria-modal="true" aria-labelledby="adminTitle">
      <h3 id="adminTitle">Cutty Ranks â€” Admin</h3>
      <div id="adminEntries"></div>
      <div id="adminActions">
        <button id="addEntryBtn"><i class="fa fa-plus"></i>&nbsp; Add DJ</button>
        <button id="adminSave">Save</button>
        <button id="adminClose">Close</button>
        <div id="adminStatus"></div>
      </div>
    </div>
  </div>

  <!-- Config -->
  <script>
    window.CUTTY_RANKS = {
      CONFIG_ENDPOINT: 'cutty-ranks-config.php',
      ADMIN_HASH_HEX: '446b03243337b8bb55581f2c94647468d02b9dc09aa07968701be1f65071599e'
    };
  </script>

  <script>
  (() => {
    const CFG = window.CUTTY_RANKS || {};
    const $  = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];

    const grid = $('#ranksGrid');
    const rails = [$('#rail-0'), $('#rail-1'), $('#rail-2'), $('#rail-3')];
    const mainPreview = $('#mainPreview');

    const playAllBtn  = $('#playAllBtn');
    const shuffleBtn  = $('#shuffleBtn');

    /* admin refs */
    const adminOverlay = $('#adminOverlay');
    const adminEntriesBox = $('#adminEntries');
    const addEntryBtn = $('#addEntryBtn');
    const adminSaveBtn = $('#adminSave');
    const adminCloseBtn = $('#adminClose');
    const adminStatus = $('#adminStatus');

    const state = { entries: [], authed:false };

    function setHeights(){
      const rect = grid.getBoundingClientRect();
      const usable = Math.max(320, window.innerHeight - rect.top - 8);
      grid.style.setProperty('--usable', usable + 'px');
    }
    window.addEventListener('resize', setHeights, {passive:true});
    window.addEventListener('load', setHeights, {passive:true});

    /* ---------- YouTube helpers / playlist engine ---------- */
    const ytId = (u) => {
      try{
        const x = new URL(u);
        const h = x.hostname.toLowerCase();
        if(h === 'youtu.be') return x.pathname.slice(1);
        if(x.pathname.startsWith('/shorts/')) return x.pathname.split('/')[2] || '';
        if(x.searchParams.get('v')) return x.searchParams.get('v');
        if(/^\/embed\//.test(x.pathname)) return x.pathname.split('/').pop();
        return '';
      }catch{ return ''; }
    };

    let queue = [];
    let currentIdx = 0;
    let autoAdvance = false;
    let player = null;
    let apiReady = false;

    window.onYouTubeIframeAPIReady = () => { apiReady = true; };

    function buildQueue(inRandom=false){
      const vids = [];
      for (const entry of state.entries){
        for (const link of (entry.links || [])){
          const id = ytId(link);
          if (id) vids.push(id);
        }
      }
      if (inRandom){
        for (let i=vids.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [vids[i],vids[j]]=[vids[j],vids[i]]; }
      }
      return vids;
    }

    function ensurePlayer(){
      if ($('#ytPlayer')) return;
      mainPreview.innerHTML = `<div id="ytPlayer"></div>`;
    }

    function createOrLoad(videoId, autoplay){
      ensurePlayer();
      const doPlay = () => {
        if (!player){
          player = new YT.Player('ytPlayer', {
            host: 'https://www.youtube-nocookie.com',
            videoId,
            playerVars:{ rel:0, modestbranding:1, playsinline:1, enablejsapi:1 },
            events:{
              onReady: (e)=>{ autoplay ? e.target.playVideo() : e.target.cueVideoById(videoId); },
              onStateChange: (e)=>{
                if (e.data === YT.PlayerState.ENDED && autoAdvance && queue.length){
                  if (currentIdx < queue.length - 1){
                    currentIdx += 1;
                    player.loadVideoById(queue[currentIdx]);
                  }else{
                    autoAdvance = false;
                    playAllBtn.classList.remove('active');
                    shuffleBtn.classList.remove('active');
                  }
                }
              }
            }
          });
        } else {
          autoplay ? player.loadVideoById(videoId) : player.cueVideoById(videoId);
        }
      };
      if (apiReady) doPlay(); else {
        const iv = setInterval(()=>{ if(apiReady){ clearInterval(iv); doPlay(); } }, 50);
        setTimeout(()=>clearInterval(iv), 4000);
      }
    }

    function playVideoId(id, {autoplay=false, fromClick=false} = {}){
      if (autoAdvance && fromClick){
        const idx = queue.indexOf(id);
        if (idx !== -1) currentIdx = idx;
      }
      createOrLoad(id, autoplay);
    }

    function firstValidId(){
      for (const entry of state.entries){
        for (const link of (entry.links || [])){
          const id = ytId(link); if (id) return id;
        }
      }
      return null;
    }

    /* ---------- UI build ---------- */
    function makeTile(id){
      const div = document.createElement('div');
      div.className = 'track-tile';
      div.style.backgroundImage = `url('https://i.ytimg.com/vi/${id}/hqdefault.jpg')`;
      div.innerHTML = `
        <span class="tile-badge">YT</span>
        <span class="tile-play" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
        </span>
        <button class="overlayBtn" aria-label="Play video"></button>
      `;
      return div;
    }

    function djCard(entry){
      const card = document.createElement('div');
      card.className = 'dj-card';
      const h = document.createElement('h4');
      h.textContent = entry.name || 'Untitled';
      card.appendChild(h);

      const list = document.createElement('div');
      list.className = 'track-list';

      (entry.links || []).slice(0,5).forEach((u) => {
        const id = ytId(u);
        if(!id) return;
        const tile = makeTile(id);
        tile.querySelector('.overlayBtn').addEventListener('click', () => {
          $$('.track-tile').forEach(t => t.classList.remove('selected'));
          tile.classList.add('selected');
          playVideoId(id, {autoplay:true, fromClick:true});
        }, {passive:true});
        list.appendChild(tile);
      });

      card.appendChild(list);
      return card;
    }

    function render(){
      rails.forEach(r => r.innerHTML = '');

      const id = firstValidId();
      if (id){
        playVideoId(id, {autoplay:false});
      }else{
        mainPreview.innerHTML = '<div class="placeholder">Select any tile to play here</div>';
      }

      state.entries.forEach((entry, idx) => {
        const rail = rails[idx % 4];
        rail.appendChild(djCard(entry));
      });

      setHeights();
    }

    async function loadConfig(){
      try{
        const r = await fetch(`${CFG.CONFIG_ENDPOINT}?action=load`, {cache:'no-store'});
        if(r.ok){
          const j = await r.json();
          if(Array.isArray(j?.entries)){ state.entries = j.entries; render(); return; }
        }
      }catch(e){ console.warn('server load failed', e); }
      try{
        const r = await fetch('cutty-ranks-data.json', {cache:'no-store'});
        if(r.ok){
          const j = await r.json();
          if(Array.isArray(j?.entries)){ state.entries = j.entries; render(); return; }
        }
      }catch(e){ console.warn('file load failed', e); }
      try{
        const s = localStorage.getItem('cutty_ranks_entries');
        if(s){
          const a = JSON.parse(s);
          if(Array.isArray(a)){ state.entries = a; render(); return; }
        }
      }catch(e){ console.warn('localStorage parse', e); }
      state.entries = [];
      render();
    }

    /* Playlist controls */
    playAllBtn.addEventListener('click', ()=>{
      queue = buildQueue(false);
      if (!queue.length) return;
      autoAdvance = true;
      currentIdx = 0;
      playAllBtn.classList.add('active');
      shuffleBtn.classList.remove('active');
      playVideoId(queue[currentIdx], {autoplay:true});
    }, {passive:true});

    shuffleBtn.addEventListener('click', ()=>{
      queue = buildQueue(true);
      if (!queue.length) return;
      autoAdvance = true;
      currentIdx = 0;
      shuffleBtn.classList.add('active');
      playAllBtn.classList.remove('active');
      playVideoId(queue[currentIdx], {autoplay:true});
    }, {passive:true});

    /* Admin (Shift+A) */
    function entryRow(data={}){
      const wrap = document.createElement('div'); wrap.className='entry';
      wrap.innerHTML = `
        <div class="row"><label>DJ</label><input type="text" class="djName" placeholder="Name"></div>
        <div class="row"><label>Link 1</label><input type="text" class="l l1" placeholder="YouTube URL"></div>
        <div class="row"><label>Link 2</label><input type="text" class="l l2" placeholder="YouTube URL"></div>
        <div class="row"><label>Link 3</label><input type="text" class="l l3" placeholder="YouTube URL"></div>
        <div class="row"><label>Link 4</label><input type="text" class="l l4" placeholder="YouTube URL"></div>
        <div class="row"><label>Link 5</label><input type="text" class="l l5" placeholder="YouTube URL"></div>
        <div class="row"><button class="delBtn"><i class="fa fa-trash"></i>&nbsp; Remove DJ</button></div>
      `;
      wrap.querySelector('.djName').value = data.name || '';
      (data.links||[]).slice(0,5).forEach((u,i)=> wrap.querySelector('.l'+(i+1)).value = u);
      wrap.querySelector('.delBtn').addEventListener('click', () => { wrap.remove(); }, {passive:true});
      return wrap;
    }

    function openAdmin(){
      adminEntriesBox.innerHTML = '';
      (state.entries || []).forEach(e => adminEntriesBox.appendChild(entryRow(e)));
      adminOverlay.classList.remove('adminHidden'); adminOverlay.setAttribute('aria-hidden','false');
      adminStatus.textContent = '';
    }
    function closeAdmin(){
      adminOverlay.classList.add('adminHidden'); adminOverlay.setAttribute('aria-hidden','true');
    }
    adminCloseBtn.addEventListener('click', closeAdmin, {passive:true});
    addEntryBtn.addEventListener('click', ()=> adminEntriesBox.appendChild(entryRow()), {passive:true});

    async function serverSave(entries){
      const r = await fetch(CFG.CONFIG_ENDPOINT+'?action=save', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({entries, auth: CFG.ADMIN_HASH_HEX})
      });
      const txt = await r.text(); let j=null; try{ j=JSON.parse(txt);}catch{}
      if(!r.ok || !(j&&j.ok)) throw new Error(j?.error ? ('Server error: '+j.error) : ('HTTP '+r.status+' '+txt.slice(0,180)));
      return j.entries || entries;
    }

    adminSaveBtn.addEventListener('click', async ()=>{
      const entries = $$('.entry', adminEntriesBox).map(box => {
        const name = box.querySelector('.djName').value.trim();
        const links = $$('.l', box).map(i=>i.value.trim()).filter(Boolean).slice(0,5);
        return name || links.length ? {name, links} : null;
      }).filter(Boolean);
      if(!entries.length){ adminStatus.textContent='Nothing to save.'; return; }

      const ok = (u)=>/^https?:\/\/(www\.)?(youtube\.com|youtu\.be)\//i.test(u);
      for(const e of entries){
        if(!e.name){ adminStatus.textContent='Each DJ needs a name.'; return; }
        if(e.links.some(u=>!ok(u))) { adminStatus.textContent='Only YouTube links supported.'; return; }
      }

      adminStatus.textContent='Savingâ€¦';
      try{
        const saved = await serverSave(entries);
        state.entries = saved;
        localStorage.setItem('cutty_ranks_entries', JSON.stringify(saved));
        render();
        adminStatus.textContent='Saved.';
      }catch(err){
        console.error(err);
        state.entries = entries;
        localStorage.setItem('cutty_ranks_entries', JSON.stringify(entries));
        render();
        adminStatus.textContent='Saved locally (check server).';
      }
    });

    function isTypingTarget(el){
      if (!el) return false;
      const tag = el.tagName;
      return tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT' || el.isContentEditable;
    }

    window.addEventListener('keydown', async (e)=>{
      const key = (e.key || '').toLowerCase();
      const isShiftA = e.shiftKey && (key === 'a' || e.code === 'KeyA');
      if (!isShiftA) return;
      if (isTypingTarget(document.activeElement)) return;

      e.preventDefault();
      if(!state.authed){
        const pw = prompt('Enter passphrase'); if(!pw) return;
        try{
          const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pw));
          const hex = [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
          if(hex===CFG.ADMIN_HASH_HEX){ state.authed=true; openAdmin(); } else alert('Incorrect passphrase');
        }catch(err){ console.warn('digest error', err); }
      } else openAdmin();
    }, true);

    function adminWantedFromURL(){ const p=new URLSearchParams(location.search); return p.get('admin')==='1' || location.hash==='#admin'; }

    document.addEventListener('DOMContentLoaded', async ()=>{
      await loadConfig();
      setHeights();
      if (adminWantedFromURL()){
        const pw = prompt('Enter passphrase');
        if (pw) {
          const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pw));
          const hex = [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
          if(hex===CFG.ADMIN_HASH_HEX){ state.authed=true; openAdmin(); } else alert('Incorrect passphrase');
        }
      }
    });
  })();
  </script>
</body>
</html>
