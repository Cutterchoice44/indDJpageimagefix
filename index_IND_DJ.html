<!-- /merch-debug block -->
<div id="merch-debug" style="max-width:100%;margin:0 auto">
  <div id="merch-status" style="padding:.75rem 1rem;border:1px solid rgba(255,255,255,.2);border-radius:12px;margin-bottom:12px;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif">
    <strong>Shop status:</strong> checking…
  </div>

  <div id="direct-embed" data-src="https://direct.app/embed/cutterschoiceradio"
       style="max-width:100%;">
    <div id="direct-fallback" style="text-align:center;padding:1rem;">
      <p>Loading the Cutters Choice Radio shop…</p>
      <p style="font-size:.95rem;opacity:.85">
        If this never loads, the shop provider or your site’s security settings may be blocking iframes.
      </p>
      <p style="margin-top:1rem;">
        <a href="https://direct.app/cutterschoiceradio" target="_blank" rel="noopener"
           style="display:inline-block;padding:.6rem 1rem;border:1px solid #fff;border-radius:12px;text-decoration:none;">
          Open shop in a new tab
        </a>
      </p>
    </div>
  </div>
</div>

<script>
(function () {
  const statusEl = document.getElementById('merch-status');
  const container = document.getElementById('direct-embed');
  const fallback = document.getElementById('direct-fallback');
  const src = container?.getAttribute('data-src') || '';

  function setStatus(msg) { if (statusEl) statusEl.textContent = 'Shop status: ' + msg; }

  if (!container || !src) { setStatus('invalid embed URL'); return; }

  // Build iframe
  const iframe = document.createElement('iframe');
  iframe.src = src;
  iframe.title = 'Cutters Choice Radio Store';
  iframe.loading = 'lazy';
  iframe.setAttribute('referrerpolicy', 'no-referrer-when-downgrade');
  iframe.setAttribute('allowpaymentrequest', '');
  iframe.style.width = '100%';
  iframe.style.minHeight = '500px';
  iframe.style.height = '1200px';
  iframe.style.border = 'none';
  iframe.style.borderRadius = '16px';
  iframe.style.display = 'block';

  let loaded = false;
  iframe.addEventListener('load', function () {
    loaded = true;
    setStatus('loaded ✅');
    if (fallback) fallback.style.display = 'none';
  });

  container.insertBefore(iframe, container.firstChild);

  // Timeout → likely blocked (XFO/CSP/ad-block). onerror won’t fire for cross-origin iframes.
  setTimeout(function () {
    if (!loaded) setStatus('did not load after 6s — likely blocked ❌ (check Console & Network headers)');
  }, 6000);

  // Surface CSP violations (useful if your site’s CSP is the cause)
  document.addEventListener('securitypolicyviolation', function (e) {
    setStatus('CSP violation: ' + e.violatedDirective + ' at ' + e.blockedURI);
    console.warn('CSP violation', {
      violatedDirective: e.violatedDirective,
      blockedURI: e.blockedURI,
      effectiveDirective: e.effectiveDirective,
      disposition: e.disposition,
      originalPolicy: e.originalPolicy
    });
  });

  // Optional: listen for provider resize messages (harmless if none)
  const expectedOrigin = new URL(src).origin;
  window.addEventListener('message', function (evt) {
    if (evt.origin !== expectedOrigin) return;
    const d = evt.data || {};
    const h = (typeof d.height === 'number' && d.height) ||
              (typeof d.directHeight === 'number' && d.directHeight) ||
              (d.type && /height|resize/i.test(String(d.type)) && typeof d.value === 'number' ? d.value : 0);
    if (h && h > 300) iframe.style.height = Math.min(h, 5000) + 'px';
  });
})();
</script>
