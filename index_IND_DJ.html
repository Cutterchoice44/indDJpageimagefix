<?php
// rc-proxy.php â€” simple passthrough for Radio Cult + Bandcamp oEmbed
// Place alongside your HTML. If your Radio Cult base path differs, edit RC_API.

declare(strict_types=1);
header('Access-Control-Allow-Origin: *');
header('Content-Type: application/json; charset=utf-8');

$fn        = $_GET['fn']        ?? '';
$stationId = $_GET['stationId'] ?? '';
$artistId  = $_GET['artistId']  ?? ($_GET['artist_id'] ?? '');
$presenterId = $_GET['presenterId'] ?? ($_GET['presenter_id'] ?? '');
$startDate = $_GET['startDate'] ?? '';
$endDate   = $_GET['endDate']   ?? '';
$limit     = $_GET['limit']     ?? '100';
$apiKey    = $_GET['apiKey']    ?? ''; // pk_... (publishable)

define('RC_API', 'https://api.radiocult.fm/v1');  // adjust if needed

function go($url, $headers = []) {
  $ch = curl_init($url);
  curl_setopt_array($ch, [
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_FOLLOWLOCATION => true,
    CURLOPT_TIMEOUT => 20,
    CURLOPT_HTTPHEADER => $headers
  ]);
  $out = curl_exec($ch);
  $err = curl_error($ch);
  $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
  curl_close($ch);
  if ($err || $code >= 400 || $out === false) {
    http_response_code(502);
    echo json_encode(['error' => 'Upstream error', 'code'=>$code, 'detail'=>$err], JSON_UNESCAPED_SLASHES);
    exit;
  }
  echo $out;
  exit;
}

if ($fn === 'bandcamp_oembed') {
  $url = $_GET['url'] ?? '';
  if (!$url) { echo json_encode(['error'=>'Missing url']); exit; }
  $o = 'https://bandcamp.com/oembed?url='.rawurlencode($url).'&format=json';
  go($o, ['Accept: application/json']);
}

if (!$stationId && $fn !== 'bandcamp_oembed') {
  echo json_encode(['error'=>'Missing stationId']); exit;
}

$h = ['Accept: application/json'];
if ($apiKey) $h[] = 'Authorization: Bearer '.$apiKey;

switch ($fn) {
  case 'artists':
    go(RC_API."/stations/".rawurlencode($stationId)."/artists?limit=".$limit, $h);
    break;

  case 'presenters':
    go(RC_API."/stations/".rawurlencode($stationId)."/presenters?limit=".$limit, $h);
    break;

  case 'artist_schedule':
    if (!$artistId) { echo json_encode(['schedules'=>[]]); exit; }
    $qs = http_build_query([
      'artistId'=>$artistId,
      'startDate'=>$startDate ?: date(DATE_ATOM),
      'endDate'=>$endDate ?: date(DATE_ATOM, time()+3600*24*365),
      'limit'=>$limit
    ]);
    go(RC_API."/stations/".rawurlencode($stationId)."/schedules?".$qs, $h);
    break;

  case 'presenter_schedule':
    if (!$presenterId) { echo json_encode(['schedules'=>[]]); exit; }
    $qs = http_build_query([
      'presenterId'=>$presenterId,
      'startDate'=>$startDate ?: date(DATE_ATOM),
      'endDate'=>$endDate ?: date(DATE_ATOM, time()+3600*24*365),
      'limit'=>$limit
    ]);
    go(RC_API."/stations/".rawurlencode($stationId)."/schedules?".$qs, $h);
    break;

  case 'upcoming':
    $qs = http_build_query(['startDate'=>date(DATE_ATOM), 'limit'=>$limit, 'expand'=>'artist,presenter']);
    go(RC_API."/stations/".rawurlencode($stationId)."/schedules/upcoming?".$qs, $h);
    break;

  default:
    echo json_encode(['error'=>'Unknown fn']); break;
}
