<?php
// rc-proxy.php â€” minimal, JSON-only proxy
// Pulls the public "share" page for slug=selector, extracts name, art, description,
// and the next upcoming show (from JSON-LD). No API keys required.

declare(strict_types=1);

// CORS + JSON
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, OPTIONS');
header('Access-Control-Allow-Headers: Accept, Content-Type');
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') exit;
header('Content-Type: application/json; charset=utf-8');

function respond(int $code, array $obj){ http_response_code($code); echo json_encode($obj, JSON_UNESCAPED_SLASHES); exit; }
function ok(array $data){ respond(200, ['ok'=>true] + $data); }
function fail(int $code, string $msg, array $extra=[]){ respond($code, ['ok'=>false,'error'=>$msg] + $extra); }

function http_get(string $url): ?string {
  // curl first
  if (function_exists('curl_init')) {
    $ch = curl_init($url);
    curl_setopt_array($ch, [
      CURLOPT_RETURNTRANSFER=>true,
      CURLOPT_FOLLOWLOCATION=>true,
      CURLOPT_TIMEOUT=>20,
      CURLOPT_CONNECTTIMEOUT=>8,
      CURLOPT_HTTPHEADER=>['User-Agent: CCR-Proxy/1.0','Accept: text/html,application/xhtml+xml']
    ]);
    $body=curl_exec($ch);
    $code=(int)curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);
    if ($code>=200 && $code<400 && is_string($body)) return $body;
  }
  // fallback
  $ctx=stream_context_create(['http'=>['method'=>'GET','header'=>"User-Agent: CCR-Proxy/1.0\r\nAccept: text/html,application/xhtml+xml\r\n",'timeout'=>20]]);
  $body=@file_get_contents($url,false,$ctx);
  return is_string($body)?$body:null;
}
function meta(string $html,string $prop,string $attr='property'):string{
  return preg_match('~'.$attr.'=["\']'.preg_quote($prop,'~').'["\']\s+content=["\']([^"\']+)["\']~i',$html,$m)?$m[1]:'';
}
function jsonld_blocks(string $html):array{
  $out=[]; if(preg_match_all('~<script[^>]+type=["\']application/ld\+json["\'][^>]*>(.*?)</script>~is',$html,$ms)){
    foreach($ms[1] as $blob){ $j=json_decode($blob,true); if(is_array($j)) $out[]=$j; }
  } return $out;
}
function next_event(array $lds):?array{
  $now=time(); $best=null;
  foreach($lds as $ld){
    $c=[]; if(($ld['@type']??'')==='Event') $c[]=$ld;
    if(isset($ld['event'])) $c=array_merge($c,is_array($ld['event'])?$ld['event']:[$ld['event']]);
    if(isset($ld['@graph'])&&is_array($ld['@graph'])) foreach($ld['@graph'] as $g) if(($g['@type']??'')==='Event') $c[]=$g;
    foreach($c as $e){ $s=$e['startDate']??($e['start']??''); if(!$s) continue; $ts=strtotime($s);
      if($ts && $ts>$now){ if(!$best||$ts<strtotime($best['start'])) $best=['title'=>$e['name']??'','start'=>date(DATE_ATOM,$ts)]; }
    }
  }
  return $best;
}

$fn = $_GET['fn'] ?? '';
$stationId = $_GET['stationId'] ?? '';
$slug = $_GET['slug'] ?? '';

if ($fn !== 'selector' || !$stationId || !$slug) {
  fail(400, 'Usage: rc-proxy.php?fn=selector&stationId=cutters-choice-radio&slug=selector');
}

$candidates = [
  "https://radiocult.fm/".rawurlencode($stationId)."/artists/".rawurlencode($slug),
  "https://radiocult.fm/".rawurlencode($stationId)."/presenters/".rawurlencode($slug),
];

foreach($candidates as $u){
  $html = http_get($u);
  if(!$html) continue;

  $name = meta($html,'og:title');
  $img  = meta($html,'og:image');
  $desc = meta($html,'description','name');
  $lds  = jsonld_blocks($html);
  $next = next_event($lds);

  // display name: prefer upcoming show title ("MARIONETTE"), else last segment after " - "
  $display = $name;
  if ($next && !empty($next['title'])) $display = $next['title'];
  elseif (strpos($name,' - ')!==false)   $display = trim(substr($name, strrpos($name,' - ')+3));

  ok([
    'name'        => $name ?: 'DJ',
    'displayName' => $display ?: ($name ?: 'DJ'),
    'image'       => $img ?: '',
    'description' => $desc ?: '',
    'shareUrl'    => $u,
    'nextShow'    => $next ?: null
  ]);
}

fail(502, 'Selector share page not reachable', ['tried'=>$candidates]);
