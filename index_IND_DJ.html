<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cutters Choice Radio — DJ Selects</title>

  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    :root { --brand-teal:#5A8785; }
    .djselects-hero{padding:.6rem .75rem .2rem;border:2px solid var(--brand-teal);border-left:0;border-right:0;margin-bottom:.35rem;display:grid;grid-template-columns:1fr 160px;gap:.6rem;align-items:end}
    .djselects-hero .strap{font-family:'Bebas Neue',sans-serif;font-size:clamp(1.1rem,2.4vw,1.7rem);line-height:1}
    .djselects-hero .monthline{font-family:'Bebas Neue',sans-serif;font-size:clamp(2.6rem,5.6vw,3.8rem);line-height:1}
    .djselects-hero #djNameText{color:var(--brand-teal)}
    .djselects-hero .hero-right img{width:100%;height:auto;border:2px solid var(--brand-teal);border-radius:4px;background:#000;display:block}
    .nextbar{margin:.2rem .6rem .5rem}
    .nextbar-inner{display:flex;align-items:center;gap:1rem;background:#0b0b0b;border:2px solid var(--brand-teal);padding:.45rem .6rem;border-radius:6px}
    .nextbar .label{font-family:'Bebas Neue',sans-serif;font-size:clamp(1.2rem,2.2vw,1.6rem)}
    .nextbar .when{font-family:'Bebas Neue',sans-serif;font-size:clamp(1.3rem,2.6vw,1.8rem);color:var(--brand-teal)}
    .compact-grid{display:grid;grid-template-columns:minmax(240px,360px) 1fr;gap:.6rem;padding:0 .6rem .9rem}
    .strip-list{display:grid;grid-template-rows:repeat(5,90px);gap:.45rem;border:2px solid var(--brand-teal);padding:.35rem;background:#000}
    .strip{position:relative;border:1px solid #264745;background:#0a0a0a;border-radius:4px;overflow:hidden;cursor:pointer}
    .strip.selected{outline:2px solid var(--brand-teal)}
    .strip iframe{width:100%;height:100%;border:0;display:block;pointer-events:none}
    .strip .select-overlay{position:absolute;inset:0}
    .strip:hover .select-overlay{box-shadow:inset 0 0 0 2px var(--brand-teal);background:rgba(90,135,133,.08)}
    .preview .ratio.big{position:relative;width:100%;padding-top:28.125%}
    .preview .ratio.big iframe{position:absolute;inset:0;width:100%;height:100%;border:0}
    .big-placeholder{font-family:'Bebas Neue',sans-serif;color:#6fa39f;font-size:clamp(1.1rem,2.4vw,1.6rem);padding:.75rem}
    .admin-btn{position:fixed;right:12px;bottom:12px;z-index:9999;background:var(--brand-teal);color:#000;border:none;width:48px;height:48px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,.35)}
    .admin-panel{position:fixed;right:12px;bottom:72px;width:min(560px,94vw);max-height:82vh;background:#0c0c0c;color:#fff;border:2px solid var(--brand-teal);border-radius:10px;display:none;flex-direction:column;z-index:9999;box-shadow:0 10px 30px rgba(0,0,0,.45)}
    .admin-panel.open{display:flex}
    .admin-head{display:flex;align-items:center;justify-content:space-between;padding:.6rem .8rem;border-bottom:1px solid #1d3b3a}
    .admin-close{background:none;border:none;color:#fff;font-size:1.6rem;cursor:pointer}
    .admin-body{padding:.8rem;overflow-y:auto;padding-bottom:5.5rem}
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
    .admin-body label{display:block;margin-bottom:.65rem}
    .admin-body input{width:100%;padding:.55rem;background:#111;color:#fff;border:1px solid #264745;border-radius:6px;margin-top:.25rem}
    #adminTracks .track-input{display:grid;grid-template-columns:1fr auto auto;gap:.5rem;margin-bottom:.5rem}
    #adminTracks button{padding:.5rem .75rem;border-radius:6px;border:1px solid #264745;background:#121212;color:#fff;cursor:pointer}
    .admin-actions{position:sticky;bottom:0;background:#0c0c0c;border-top:1px solid #1d3b3a;display:flex;gap:.6rem;padding:.7rem .8rem}
    .admin-actions .primary{background:var(--brand-teal);color:#000;border:none;padding:.6rem .9rem;border-radius:8px}
    .admin-actions .ghost{background:#171717;color:#fff;border:1px solid #2a2a2a;padding:.6rem .9rem;border-radius:8px}
    .admin-actions .danger{background:#2b1818;color:#fff;border:1px solid #5a2020;padding:.6rem .9rem;border-radius:8px}
    @media (max-width:960px){.djselects-hero{grid-template-columns:1fr}.compact-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header-banner">
    <div class="header-gif-right"></div>
    <div class="header-gif-left"></div>
    <div class="logo-container"><img class="logo" src="/images/logo.png" alt=""></div>
    <div class="title"><h1>Cutters Choice Radio</h1><p class="tagline">The home of relentless flavas and significant bangers!</p></div>
    <div class="logo-container"><img class="logo" src="/images/logo.png" alt=""></div>
  </header>

  <div style="height:2px;background-color:var(--brand-teal)"></div>

  <!-- Nav -->
  <nav id="main-nav">
    <div class="nav-menu">
      <a href="our-story.html" class="nav-link">OUR STORY</a>
      <a href="index.html" class="nav-link">HOME</a>
      <a href="index-ourDJS.html" class="nav-link">OUR DJS</a>
      <a href="dj-selects.html" class="nav-link">DJ SELECTS</a>
      <a href="schedule.html" class="nav-link">SCHEDULE</a>
      <a href="merch.html" class="nav-link">MERCH</a>
    </div>
    <div class="nav-actions"></div>
  </nav>

  <div style="height:2px;background-color:var(--brand-teal)"></div>

  <!-- Hero -->
  <section class="djselects-hero">
    <div class="hero-left">
      <div class="strap">Each month a different Cutters DJ selects 5 tracks of the month</div>
      <div class="monthline">THIS MONTH : <span id="djNameText">DJ NAME</span></div>
    </div>
    <div class="hero-right"><img id="djProfileThumb" src="/images/default-dj.png" alt="DJ profile" /></div>
  </section>

  <!-- Next Scheduled Show -->
  <section class="nextbar">
    <div class="nextbar-inner">
      <span class="label">NEXT SCHEDULED SHOW</span>
      <span class="when" id="nextShowWhen">Loading…</span>
    </div>
  </section>

  <!-- Tracks -->
  <main class="compact-grid">
    <aside id="stripList" class="strip-list"></aside>
    <section class="preview" id="mainPreview" aria-live="polite">
      <div class="big-placeholder">Select a track</div>
    </section>
  </main>

  <div id="adminMount" hidden></div>

  <!-- Page config -->
  <script>
    window.DJ_SELECTS = {
      CONFIG_ENDPOINT: 'dj-selects-config.php',
      /* IMPORTANT: use absolute HTTPS so the browser never tries file:/// */
      PROXY_ENDPOINT:  'https://www.cutterschoiceradio.com/rc-proxy.php',
      // passphrase = ccr2025!
      ADMIN_HASH_HEX: '446b03243337b8bb55581f2c94647468d02b9dc09aa07968701be1f65071599e',
      // MUST match $SERVER_TOKEN in dj-selects-config.php
      SAVE_TOKEN: 'CCR_TEMP_TOKEN_!2025'
    };
  </script>

  <!-- Logic -->
  <script>
  (()=>{
    const CFG = window.DJ_SELECTS||{};
    const $=(s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>[...r.querySelectorAll(s)];

    const stripList=$('#stripList'),
          mainPreview=$('#mainPreview'),
          djNameText=$('#djNameText'),
          djProfile=$('#djProfileThumb'),
          nextWhen=$('#nextShowWhen'),
          adminMount=$('#adminMount');

    let shared={
      djName:'DJ NAME',
      profileImage:'/images/default-dj.png',
      stationId:'cutters-choice-radio',
      apiKey:'',           // not needed by the browser if proxy is configured with env/key
      tracks:[]
    };

    /* ---------- helpers ---------- */

    const sha256hex=async t=>{
      const b=await crypto.subtle.digest('SHA-256',new TextEncoder().encode(t));
      return [...new Uint8Array(b)].map(x=>x.toString(16).padStart(2,'0')).join('');
    };

    const toEmbed=u=>{
      if(!u) return null;
      try{
        const x=new URL(u.trim());
        if(x.hostname.includes('youtu')){
          let id='';
          if(x.hostname==='youtu.be') id=x.pathname.slice(1);
          else if(x.pathname.startsWith('/shorts/')) id=x.pathname.split('/')[2]||'';
          else if(x.searchParams.get('v')) id=x.searchParams.get('v');
          else if(/^\/embed\//.test(x.pathname)) id=x.pathname.split('/').pop();
          id=(id||'').split('?')[0].split('&')[0];
          if(!id) return null;
          return `https://www.youtube-nocookie.com/embed/${id}?rel=0&modestbranding=1&playsinline=1`;
        }
        return u;
      }catch{return null;}
    };

    const iframeAttrs=(src,big=false)=>`<iframe src="${src}" title="YouTube video" loading="${big?'eager':'lazy'}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`;

    const setPreview=src=>{ mainPreview.innerHTML=`<div class="ratio big">${iframeAttrs(src,true)}</div>`; };

    const renderStrips=embeds=>{
      stripList.innerHTML='';
      embeds.slice(0,5).forEach((src,i)=>{
        const el=document.createElement('div');
        el.className='strip';
        el.innerHTML=iframeAttrs(src,false)+'<div class="select-overlay" aria-hidden="true"></div>';
        el.querySelector('.select-overlay').addEventListener('click',()=>{
          $$('.strip').forEach(s=>s.classList.remove('selected'));
          el.classList.add('selected');
          setPreview(src);
        });
        stripList.appendChild(el);
        if(i===0){ el.classList.add('selected'); setPreview(src); }
      });
      if(!embeds.length) mainPreview.innerHTML='<div class="big-placeholder">Select a track</div>';
    };

    const fmtLocal=iso=>{
      try{
        const d=new Date(iso);
        return d.toLocaleString(undefined,{weekday:'short',day:'numeric',month:'short',hour:'2-digit',minute:'2-digit',hour12:false,timeZoneName:'short'});
      }catch{ return ''; }
    };

    const slug=s=>(s||'').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
    const nameEq=(a,b)=>{const A=(a||'').trim().toLowerCase(),B=(b||'').trim().toLowerCase();return A&&B&&(A===B||slug(A)===slug(B));};
    const firstImageUrl=o=>{
      if(!o) return '';
      return (
        (o.logo && (o.logo['512x512']||o.logo.default)) ||
        o.image || o.imageUrl || o.avatar || o.avatarUrl ||
        (Array.isArray(o.images)&&o.images.length&&(o.images[0].url||o.images[0].src)) ||
        ''
      );
    };

    const fetchJSON=async url=>{
      const r=await fetch(url,{headers:{'Accept':'application/json'},cache:'no-store'});
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    };

    /* ---------- load shared config (server) ---------- */
    async function loadSharedConfig(){
      try{
        const r=await fetch(`${CFG.CONFIG_ENDPOINT}?action=load`,{cache:'no-store'});
        if(!r.ok) throw 0;
        const data=await r.json();
        if(data&&data.djName) shared={...shared,...data};
      }catch{
        const raw=localStorage.getItem('dj-selects-config');
        if(raw) shared={...shared,...JSON.parse(raw)};
      }
    }

    /* ---------- RC data via server proxy ---------- */

    async function loadDjImage(){
      // respect manual override unless default image
      if(shared.profileImage && !/default-dj\.png$/i.test(shared.profileImage)) return;

      const base=`${CFG.PROXY_ENDPOINT}?stationId=${encodeURIComponent(shared.stationId)}`;
      try{
        const [artists,presenters]=await Promise.all([
          fetchJSON(`${base}&fn=artists`).then(j=>j?.artists||j?.data||j||[]).catch(()=>[]),
          fetchJSON(`${base}&fn=presenters`).then(j=>j?.presenters||j?.data||j||[]).catch(()=>[])
        ]);
        const pool=[...artists,...presenters];
        const nm=shared.djName;
        const hit = pool.find(x=>nameEq(x?.name,nm)) ||
                    pool.find(x=>slug(x?.name)===slug(nm)) ||
                    pool.find(x=>(x?.name||'').toLowerCase().includes(nm.toLowerCase()));
        const url=firstImageUrl(hit);
        if(url) djProfile.src=url;
      }catch{/* leave default */}
    }

    async function loadNextShow(){
      nextWhen.textContent='Loading…';
      const url=`${CFG.PROXY_ENDPOINT}?fn=upcoming&stationId=${encodeURIComponent(shared.stationId)}&limit=200&expand=artist,presenter`;
      try{
        const j=await fetchJSON(url);
        const list=j?.data||j?.items||j||[];

        const dj=shared.djName, djSlug=slug(dj);
        const nameOf=e=>(e?.artist?.name||e?.presenter?.name||e?.name||e?.title||'');
        const hasTag=e=>{
          const tags=e?.tags||e?.categories||[];
          if(!Array.isArray(tags)) return false;
          return tags.map(t=>typeof t==='string'?t:(t?.slug||t?.name||'')).map(slug).includes(djSlug);
        };

        const target=list.find(e=>
          nameEq(e?.artist?.name,dj) ||
          nameEq(e?.presenter?.name,dj) ||
          nameOf(e).toLowerCase().includes(dj.toLowerCase()) ||
          hasTag(e)
        );

        if(!target){ nextWhen.textContent='No upcoming show found'; return; }

        const when=target.startDate||target.start||target.startDateUtc||target.scheduledStart||target.start_time||target.start_at||'';
        if(!when){ nextWhen.textContent='TBA'; return; }

        nextWhen.textContent=fmtLocal(when);
        nextWhen.setAttribute('data-utc',when);
        nextWhen.title=`Start (UTC): ${new Date(when).toUTCString()}`;

        // opportunistically set image from event
        if(/default-dj\.png$/i.test(djProfile.src||'')){
          const img=firstImageUrl(target.artist)||firstImageUrl(target.presenter)||target.image||'';
          if(img) djProfile.src=img;
        }
      }catch{
        nextWhen.textContent='Unable to load schedule';
        nextWhen.title=url; // quick check URL
      }
    }

    /* ---------- admin UI ---------- */
    function renderAdmin(){
      const btn=document.createElement('button');
      btn.className='admin-btn';
      btn.innerHTML='<i class="fa-solid fa-gear"></i>';

      const panel=document.createElement('div');
      panel.className='admin-panel';
      panel.innerHTML=`
        <div class="admin-head">
          <strong>DJ SELECTS — Admin</strong>
          <button id="x" class="admin-close" aria-label="Close">&times;</button>
        </div>
        <div class="admin-body">
          <label>DJ Name<input id="aDj" value="${shared.djName}"></label>
          <div class="two-col">
            <label>Station ID<input id="aSt" value="${shared.stationId}"></label>
            <label>Publishable API Key (optional)<input id="aKey" placeholder="pk_..." value="${shared.apiKey}"></label>
          </div>
          <label>Profile Image URL<input id="aImg" value="${shared.profileImage||''}"></label>
          <div class="admin-subhead" style="margin:.5rem 0 .25rem;font-family:'Bebas Neue',sans-serif;font-size:1.3rem;">YouTube Track URLs (up to 5)</div>
          <div id="aTracks"></div>
          <div class="admin-actions">
            <button id="save" class="primary">Save</button>
            <button id="logout" class="ghost">Logout</button>
            <button id="reset" class="danger">Reset (local only)</button>
          </div>
        </div>`;

      adminMount.after(btn,panel);
      adminMount.remove();

      const close=()=>panel.classList.remove('open');
      btn.onclick=()=>panel.classList.add('open');
      panel.querySelector('#x').onclick=close;

      const wrap=panel.querySelector('#aTracks');
      const draw=()=>{
        wrap.innerHTML='';
        [...shared.tracks,'','','',''].slice(0,5).forEach(v=>{
          const row=document.createElement('div');
          row.className='track-input';
          row.innerHTML=`
            <input type="url" value="${v||''}" placeholder="https://www.youtube.com/watch?v=...">
            <button data-a="clear">Clear</button>
            <button data-a="paste">Paste</button>`;
          row.querySelector('[data-a="clear"]').onclick=()=>row.querySelector('input').value='';
          row.querySelector('[data-a="paste"]').onclick=async()=>{
            try{ row.querySelector('input').value=await navigator.clipboard.readText(); }catch{}
          };
          wrap.appendChild(row);
        });
      };
      draw();

      panel.querySelector('#save').onclick=async()=>{
        shared.djName = panel.querySelector('#aDj').value.trim()||shared.djName;
        shared.stationId = panel.querySelector('#aSt').value.trim()||shared.stationId;
        shared.apiKey = panel.querySelector('#aKey').value.trim();
        shared.profileImage = panel.querySelector('#aImg').value.trim();
        shared.tracks = $$('#aTracks input',panel).map(i=>i.value.trim()).filter(Boolean).slice(0,5);

        localStorage.setItem('dj-selects-config',JSON.stringify(shared));

        try{
          const r=await fetch(`${CFG.CONFIG_ENDPOINT}?action=save`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({token:CFG.SAVE_TOKEN,data:shared})
          });
          if(!r.ok) throw 0;
          alert('Saved to server. Live for everyone.');
        }catch{
          alert('Saved locally. To save for everyone, ensure SAVE_TOKEN in this page matches $SERVER_TOKEN in dj-selects-config.php.');
        }

        apply();
        close();
      };

      panel.querySelector('#logout').onclick=()=>{ sessionStorage.removeItem('dj-selects-auth'); location.reload(); };
      panel.querySelector('#reset').onclick=()=>{ localStorage.removeItem('dj-selects-config'); alert('Local data cleared. Reloading…'); location.reload(); };
    }

    async function ensureAdmin(){
      const prompt=async()=>{
        const p=window.prompt('Enter admin passphrase:');
        if(!p) return;
        const ok=await sha256hex(p)==='446b03243337b8bb55581f2c94647468d02b9dc09aa07968701be1f65071599e';
        if(ok){ sessionStorage.setItem('dj-selects-auth','1'); renderAdmin(); }
        else alert('Wrong passphrase.');
      };
      if(new URLSearchParams(location.search).get('admin')==='1') await prompt();
      document.addEventListener('keydown',async e=>{ if(e.key.toLowerCase()==='a'&&e.shiftKey) await prompt(); });
      if(sessionStorage.getItem('dj-selects-auth')==='1') renderAdmin();
    }

    /* ---------- apply to UI ---------- */
    function apply(){
      djNameText.textContent=shared.djName||'DJ NAME';
      if(shared.profileImage) djProfile.src=shared.profileImage;

      const embeds=(shared.tracks||[]).map(toEmbed).filter(Boolean);
      renderStrips(embeds);

      loadDjImage();
      loadNextShow();
    }

    /* ---------- BOOT ---------- */
    window.addEventListener('DOMContentLoaded',async()=>{
      await loadSharedConfig();
      apply();
      ensureAdmin();
    });
  })();
  </script>
</body>
</html>
