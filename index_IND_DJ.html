<?php
/**
 * rc-proxy.php â€” Radio Cult server-side proxy (with schedule fallback)
 * - Calls RC from your server with x-api-key and returns JSON.
 * - For artist/presenter schedules: try station-scoped first, then global path.
 */
declare(strict_types=1);

const RC_BASE    = 'https://api.radiocult.fm/api';
const RC_API_KEY = 'pk_0b8abc6f834b444f949f727e88a728e0';

header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-store, must-revalidate');
header('Access-Control-Allow-Origin: *');

function build_url(string $base, string $path, array $qs = []): string {
  $q = http_build_query(array_filter($qs, static fn($v) => $v !== '' && $v !== null));
  return rtrim($base, '/') . $path . ($q ? ('?' . $q) : '');
}
function out($arr, $code=200){ http_response_code($code); echo json_encode($arr, JSON_UNESCAPED_SLASHES); exit; }

function fetch_upstream(string $url): array {
  $ch = curl_init($url);
  curl_setopt_array($ch, [
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_FOLLOWLOCATION => true,
    CURLOPT_TIMEOUT        => 15,
    CURLOPT_HTTPHEADER     => ['Accept: application/json', 'x-api-key: '.RC_API_KEY],
  ]);
  $resp = curl_exec($ch);
  $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
  $err  = curl_error($ch);
  curl_close($ch);
  return [$code, $resp, $err];
}

$fn        = $_GET['fn']        ?? 'ping';
$stationId = $_GET['stationId'] ?? '';
$limit     = isset($_GET['limit']) ? max(1, (int)$_GET['limit']) : 50;
$expand    = $_GET['expand']    ?? '';

if ($fn === 'ping') out(['ok'=>true]);
if (!$stationId && !in_array($fn, ['ping'])) out(['error'=>'stationId_required'], 400);

switch ($fn) {
  case 'artists': {
    [$code,$resp,$err] = fetch_upstream(build_url(RC_BASE, '/station/'.rawurlencode($stationId).'/artists'));
    if ($resp === false || $code >= 400) out(['error'=>'upstream_error','status'=>$code,'detail'=>$err ?: $resp], 502);
    echo $resp; exit;
  }
  case 'presenters': {
    [$code,$resp,$err] = fetch_upstream(build_url(RC_BASE, '/station/'.rawurlencode($stationId).'/presenters'));
    if ($resp === false || $code >= 400) out(['error'=>'upstream_error','status'=>$code,'detail'=>$err ?: $resp], 502);
    echo $resp; exit;
  }
  case 'upcoming': {
    $u = build_url(RC_BASE, '/station/'.rawurlencode($stationId).'/upcoming', ['limit'=>$limit, 'expand'=>$expand]);
    [$code,$resp,$err] = fetch_upstream($u);
    if ($resp === false || $code >= 400) out(['error'=>'upstream_error','status'=>$code,'detail'=>$err ?: $resp], 502);
    echo $resp; exit;
  }
  case 'artist_schedule': {
    $artistId  = $_GET['artistId']  ?? '';
    $startDate = $_GET['startDate'] ?? '';
    $endDate   = $_GET['endDate']   ?? '';
    if (!$artistId) out(['error'=>'artistId_required'], 400);

    // Try station-scoped first
    $u1 = build_url(RC_BASE, '/station/'.rawurlencode($stationId).'/artists/'.rawurlencode($artistId).'/schedule', ['startDate'=>$startDate,'endDate'=>$endDate]);
    [$c1,$r1,$e1] = fetch_upstream($u1);
    if ($r1 !== false && $c1 < 400) { echo $r1; exit; }

    // Fallback to global path
    $u2 = build_url(RC_BASE, '/artists/'.rawurlencode($artistId).'/schedule', ['startDate'=>$startDate,'endDate'=>$endDate]);
    [$c2,$r2,$e2] = fetch_upstream($u2);
    if ($r2 !== false && $c2 < 400) { echo $r2; exit; }

    out(['error'=>'upstream_error','status'=>$c2,'detail'=>$e2 ?: $r2], 502);
  }
  case 'presenter_schedule': {
    $presenterId  = $_GET['presenterId']  ?? '';
    $startDate = $_GET['startDate'] ?? '';
    $endDate   = $_GET['endDate']   ?? '';
    if (!$presenterId) out(['error'=>'presenterId_required'], 400);

    $u1 = build_url(RC_BASE, '/station/'.rawurlencode($stationId).'/presenters/'.rawurlencode($presenterId).'/schedule', ['startDate'=>$startDate,'endDate'=>$endDate]);
    [$c1,$r1,$e1] = fetch_upstream($u1);
    if ($r1 !== false && $c1 < 400) { echo $r1; exit; }

    $u2 = build_url(RC_BASE, '/presenters/'.rawurlencode($presenterId).'/schedule', ['startDate'=>$startDate,'endDate'=>$endDate]);
    [$c2,$r2,$e2] = fetch_upstream($u2);
    if ($r2 !== false && $c2 < 400) { echo $r2; exit; }

    out(['error'=>'upstream_error','status'=>$c2,'detail'=>$e2 ?: $r2], 502);
  }
  default:
    out(['error'=>'bad_fn'], 400);
}
