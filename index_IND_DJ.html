<?php
// cutty-ranks-config.php
// Minimal config store for Cutty Ranks (JSON file).
header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-store, no-cache, must-revalidate');

$DATA_FILE = __DIR__ . '/cutty-ranks-data.json';
$ADMIN_HASH_HEX = '446b03243337b8bb55581f2c94647468d02b9dc09aa07968701be1f65071599e'; // same as page

$action = $_GET['action'] ?? 'load';

if ($action === 'load') {
  if (is_file($DATA_FILE)) {
    $json = file_get_contents($DATA_FILE);
    echo $json ?: json_encode(['entries'=>[]]);
  } else {
    echo json_encode(['entries'=>[]]);
  }
  exit;
}

if ($action === 'save') {
  $raw = file_get_contents('php://input');
  $j = json_decode($raw, true);
  if (!is_array($j)) { http_response_code(400); echo json_encode(['ok'=>false,'error'=>'Bad JSON']); exit; }

  if (($j['auth'] ?? '') !== $ADMIN_HASH_HEX) { http_response_code(403); echo json_encode(['ok'=>false,'error'=>'Forbidden']); exit; }

  $entries = $j['entries'] ?? [];
  if (!is_array($entries)) { http_response_code(400); echo json_encode(['ok'=>false,'error'=>'Entries must be array']); exit; }

  // keep only name + up to 5 links (strings)
  $clean = [];
  foreach ($entries as $e) {
    $name = isset($e['name']) ? trim((string)$e['name']) : '';
    $links = [];
    if (isset($e['links']) && is_array($e['links'])) {
      foreach ($e['links'] as $k => $u) {
        if ($k >= 5) break;
        $u = trim((string)$u);
        if ($u !== '') $links[] = $u;
      }
    }
    if ($name !== '' || count($links) > 0) $clean[] = ['name'=>$name, 'links'=>$links];
  }

  $payload = json_encode(['entries'=>$clean], JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES);
  if (!file_put_contents($DATA_FILE, $payload)) {
    http_response_code(500); echo json_encode(['ok'=>false,'error'=>'Write failed']); exit;
  }
  echo json_encode(['ok'=>true, 'entries'=>$clean]);
  exit;
}

http_response_code(400);
echo json_encode(['ok'=>false,'error'=>'Unknown action']);
