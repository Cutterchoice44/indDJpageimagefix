<?php
// rc-proxy.php â€” Radio Cult + Bandcamp oEmbed passthrough
// Put this file next to dj-selects.html

declare(strict_types=1);
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Headers: Authorization, Content-Type, Accept, Origin');
header('Access-Control-Allow-Methods: GET, POST, OPTIONS');
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') { exit; }

$fn          = $_GET['fn']          ?? '';
$stationId   = $_GET['stationId']   ?? '';
$limit       = $_GET['limit']       ?? '200';
$expand      = $_GET['expand']      ?? '';
$apiKey      = $_GET['apiKey']      ?? '';
$id          = $_GET['id']          ?? '';
$slug        = $_GET['slug']        ?? '';
$startDate   = $_GET['startDate']   ?? '';
$endDate     = $_GET['endDate']     ?? '';

define('RC_API', 'https://api.radiocult.fm/v1'); // adjust only if RC provides a different base

function respond($code, $data){ http_response_code($code); header('Content-Type: application/json; charset=utf-8'); echo json_encode($data, JSON_UNESCAPED_SLASHES); exit; }

function get_json($url, $headers=[]){
  $ch = curl_init($url);
  curl_setopt_array($ch, [
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_FOLLOWLOCATION => true,
    CURLOPT_TIMEOUT => 25,
    CURLOPT_CONNECTTIMEOUT => 10,
    CURLOPT_HTTPHEADER => array_merge(['Accept: application/json','User-Agent: CCR-Proxy/1.1'], $headers)
  ]);
  $out = curl_exec($ch);
  $err = curl_error($ch);
  $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
  curl_close($ch);
  if ($err || $out===false || $code>=400) return [null, $err ?: ('HTTP '.$code)];
  return [json_decode($out, true), null];
}
function first_ok(array $urls, array $headers=[]){
  foreach($urls as $u){
    [$j,$e] = get_json($u, $headers);
    if(!$e && $j!==null) return $j;
  }
  return null;
}

if ($fn === 'ping') { respond(200, ['pong'=>'ok']); }

if ($fn === 'bandcamp_oembed') {
  $url = $_GET['url'] ?? '';
  if (!$url) respond(400, ['error'=>'Missing url']);
  [$j,$e] = get_json('https://bandcamp.com/oembed?format=json&url='.rawurlencode($url));
  if ($e) respond(502, ['error'=>'Upstream error','detail'=>$e]);
  respond(200, $j);
}

$auth = [];
if ($apiKey) $auth[] = 'Authorization: Bearer '.$apiKey;

/* ----- require station for station-scoped endpoints ----- */
$needsStation = ['artists','presenters','artist_by_slug','presenter_by_slug','artist_schedule','presenter_schedule','upcoming'];
if (in_array($fn, $needsStation, true) && !$stationId) respond(400, ['error'=>'Missing stationId']);

/* ----- lists (with expand=tags support) ----- */
if ($fn === 'artists') {
  $qs = http_build_query(array_filter(['limit'=>$limit,'expand'=>$expand]));
  [$j,$e] = get_json(RC_API."/stations/".rawurlencode($stationId)."/artists".($qs?"?".$qs:""), $auth);
  if ($e) respond(502, ['error'=>'Upstream error','detail'=>$e]);
  respond(200, $j);
}
if ($fn === 'presenters') {
  $qs = http_build_query(array_filter(['limit'=>$limit,'expand'=>$expand]));
  [$j,$e] = get_json(RC_API."/stations/".rawurlencode($stationId)."/presenters".($qs?"?".$qs:""), $auth);
  if ($e) respond(502, ['error'=>'Upstream error','detail'=>$e]);
  respond(200, $j);
}

/* ----- details by id OR slug (tries multiple patterns) ----- */
if ($fn === 'artist') {
  if (!$id) respond(400, ['error'=>'Missing id']);
  $qs = http_build_query(array_filter(['expand'=>$expand]));
  $try = [
    RC_API."/artists/".rawurlencode($id).($qs?"?".$qs:""),
    RC_API."/stations/".rawurlencode($stationId)."/artists/".rawurlencode($id).($qs?"?".$qs:""),
  ];
  $j = first_ok($try, $auth);
  if (!$j) respond(502, ['error'=>'Not found via id','tried'=>$try]);
  respond(200, $j);
}
if ($fn === 'presenter') {
  if (!$id) respond(400, ['error'=>'Missing id']);
  $qs = http_build_query(array_filter(['expand'=>$expand]));
  $try = [
    RC_API."/presenters/".rawurlencode($id).($qs?"?".$qs:""),
    RC_API."/stations/".rawurlencode($stationId)."/presenters/".rawurlencode($id).($qs?"?".$qs:""),
  ];
  $j = first_ok($try, $auth);
  if (!$j) respond(502, ['error'=>'Not found via id','tried'=>$try]);
  respond(200, $j);
}
if ($fn === 'artist_by_slug') {
  if (!$slug) respond(400, ['error'=>'Missing slug']);
  $qs = http_build_query(array_filter(['slug'=>$slug,'limit'=>1,'expand'=>$expand]));
  [$j,$e] = get_json(RC_API."/stations/".rawurlencode($stationId)."/artists?".$qs, $auth);
  if ($e) respond(502, ['error'=>'Upstream error','detail'=>$e]);
  $item = $j['artists'][0] ?? $j['data'][0] ?? null;
  if (!$item) respond(404, ['error'=>'Not found']);
  respond(200, $item);
}
if ($fn === 'presenter_by_slug') {
  if (!$slug) respond(400, ['error'=>'Missing slug']);
  $qs = http_build_query(array_filter(['slug'=>$slug,'limit'=>1,'expand'=>$expand]));
  [$j,$e] = get_json(RC_API."/stations/".rawurlencode($stationId)."/presenters?".$qs, $auth);
  if ($e) respond(502, ['error'=>'Upstream error','detail'=>$e]);
  $item = $j['presenters'][0] ?? $j['data'][0] ?? null;
  if (!$item) respond(404, ['error'=>'Not found']);
  respond(200, $item);
}

/* ----- schedules (try multiple param names so stations with different shapes work) ----- */
if ($fn === 'artist_schedule') {
  if (!$id) respond(200, ['schedules'=>[]]); // graceful empty
  $params = [
    ['artistId'=>$id],
    ['artist_id'=>$id],
    ['artistSlug'=>$id],
    ['artist_slug'=>$id],
    ['artist'=>$id],
  ];
  $urls = [];
  foreach ($params as $p){
    $qs = http_build_query(array_merge($p, [
      'startDate'=>$startDate ?: date(DATE_ATOM),
      'endDate'=>$endDate ?: date(DATE_ATOM, time()+3600*24*365),
      'limit'=>$limit
    ]));
    $urls[] = RC_API."/stations/".rawurlencode($stationId)."/schedules?".$qs;
  }
  $j = first_ok($urls, $auth);
  if (!$j) respond(200, ['schedules'=>[]]); // don't kill the page
  respond(200, $j);
}
if ($fn === 'presenter_schedule') {
  if (!$id) respond(200, ['schedules'=>[]]);
  $params = [
    ['presenterId'=>$id],
    ['presenter_id'=>$id],
    ['presenterSlug'=>$id],
    ['presenter_slug'=>$id],
    ['presenter'=>$id],
  ];
  $urls = [];
  foreach ($params as $p){
    $qs = http_build_query(array_merge($p, [
      'startDate'=>$startDate ?: date(DATE_ATOM),
      'endDate'=>$endDate ?: date(DATE_ATOM, time()+3600*24*365),
      'limit'=>$limit
    ]));
    $urls[] = RC_API."/stations/".rawurlencode($stationId)."/schedules?".$qs;
  }
  $j = first_ok($urls, $auth);
  if (!$j) respond(200, ['schedules'=>[]]);
  respond(200, $j);
}

/* ----- convenience ----- */
if ($fn === 'upcoming') {
  $qs = http_build_query(['startDate'=>date(DATE_ATOM), 'limit'=>$limit, 'expand'=>'artist,presenter']);
  [$j,$e] = get_json(RC_API."/stations/".rawurlencode($stationId)."/schedules/upcoming?".$qs, $auth);
  if ($e) respond(502, ['error'=>'Upstream error','detail'=>$e]);
  respond(200, $j);
}

respond(400, ['error'=>'Unknown fn']);
