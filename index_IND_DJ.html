<?php
// dj-selects-config.php
declare(strict_types=1);
header('Content-Type: application/json; charset=utf-8');

// Frontend sends this exact hex string as "auth" (see JS CFG.ADMIN_HASH_HEX)
const ADMIN_HASH_HEX = '446b03243337b8bb55581f2c94647468d02b9dc09aa07968701be1f65071599e';

// Where we persist
$DATA_FILE = __DIR__ . '/dj-selects-data.json';

// Helpers
function json_out($arr, int $code=200) {
  http_response_code($code);
  echo json_encode($arr, JSON_UNESCAPED_SLASHES|JSON_UNESCAPED_UNICODE|JSON_PRETTY_PRINT);
  exit;
}

$action = $_GET['action'] ?? ($_POST['action'] ?? 'load');

if ($action === 'load') {
  if (!file_exists($DATA_FILE)) {
    // First run: create an empty file with safe perms
    @file_put_contents($DATA_FILE, json_encode(['tracks'=>[]], JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES), LOCK_EX);
    @chmod($DATA_FILE, 0664);
  }
  $raw = @file_get_contents($DATA_FILE);
  $json = json_decode($raw ?: '{"tracks":[]}', true);
  if (!is_array($json)) $json = ['tracks'=>[]];
  if (!isset($json['tracks']) || !is_array($json['tracks'])) $json['tracks'] = [];
  $json['tracks'] = array_slice(array_map('strval', $json['tracks']), 0, 5);
  json_out($json);
}

if ($action === 'save') {
  // Require JSON body { tracks: [...], auth: "..." }
  $body = file_get_contents('php://input');
  $data = json_decode($body, true);
  if (!is_array($data)) json_out(['ok'=>false,'error'=>'Invalid JSON body'], 400);

  $auth = (string)($data['auth'] ?? '');
  if ($auth !== ADMIN_HASH_HEX) json_out(['ok'=>false,'error'=>'Unauthorized'], 403);

  $tracks = $data['tracks'] ?? [];
  if (!is_array($tracks)) $tracks = [];
  // Clean + cap at 5
  $tracks = array_values(array_filter(array_map(function($v){
    $s = trim((string)$v);
    return $s !== '' ? $s : null;
  }, $tracks)));

  $tracks = array_slice($tracks, 0, 5);

  // Attempt write
  $payload = ['tracks'=>$tracks, 'savedAt'=>gmdate('c')];
  $json = json_encode($payload, JSON_UNESCAPED_SLASHES|JSON_PRETTY_PRINT);

  // Ensure directory is writable
  $dir = dirname($DATA_FILE);
  if (!is_dir($dir) || !is_writable($dir)) {
    json_out([
      'ok'=>false,
      'error'=>'Directory not writable',
      'hint'=>'chmod 775 on folder; file 664 (DreamHost typical).'
    ], 500);
  }

  $ok = @file_put_contents($DATA_FILE, $json, LOCK_EX);
  if ($ok === false) {
    json_out([
      'ok'=>false,
      'error'=>'File write failed',
      'hint'=>sprintf('Check perms on %s (recommend 664).', basename($DATA_FILE))
    ], 500);
  }
  @chmod($DATA_FILE, 0664);

  json_out(['ok'=>true,'tracks'=>$tracks]);
}

json_out(['ok'=>false,'error'=>'Unknown action'], 400);
