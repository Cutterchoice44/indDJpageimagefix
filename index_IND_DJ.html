<!-- /merch.html — EMBED SECTION ONLY: replace your <main>…</main> with the block below -->

<main class="merch-section" role="main">
  <!-- Container for resilient embed -->
  <div id="direct-embed"
       data-slug="cutterschoiceradio"
       data-src="https://direct.app/embed/cutterschoiceradio"
       style="max-width:100%;margin:0 auto;">
    <!-- Fallback content (shown briefly, or if the iframe can't load) -->
    <div id="direct-fallback" style="text-align:center;padding:1rem;">
      <p style="margin-bottom:.75rem;">
        Loading the Cutters Choice Radio shop…
      </p>
      <p style="font-size:.95rem;opacity:.85">
        If this never loads, your browser or the shop provider may be blocking frames.
      </p>
      <p style="margin-top:1rem;">
        <a href="https://direct.app/cutterschoiceradio"
           target="_blank" rel="noopener"
           style="display:inline-block;padding:.65rem 1rem;border:1px solid #fff;border-radius:12px;text-decoration:none;">
          Open the shop in a new tab
        </a>
      </p>
    </div>
  </div>

  <script>
    // /assets/js/direct-embed.js (inlined here to keep it simple)
    (function () {
      var container = document.getElementById('direct-embed');
      if (!container) return;

      var src = container.getAttribute('data-src') || '';
      var slug = container.getAttribute('data-slug') || '';
      var fallback = document.getElementById('direct-fallback');

      // Basic validations
      if (!src && slug) src = "https://direct.app/embed/" + encodeURIComponent(slug);
      if (!src) return;

      // Build iframe
      var iframe = document.createElement('iframe');
      iframe.src = src;
      iframe.title = 'Cutters Choice Radio Store';
      iframe.loading = 'lazy';
      iframe.setAttribute('referrerpolicy', 'no-referrer-when-downgrade');
      iframe.setAttribute('allowpaymentrequest', '');      // needed if checkout uses Payment Request API
      iframe.style.width = '100%';
      iframe.style.minHeight = '500px';
      iframe.style.height = '1300px';                      // safe default; auto-resize may adjust
      iframe.style.border = 'none';
      iframe.style.borderRadius = '16px';
      iframe.style.display = 'block';

      // Insert iframe
      container.insertBefore(iframe, container.firstChild);

      // Hide fallback on successful load
      iframe.addEventListener('load', function () {
        if (fallback) fallback.style.display = 'none';
      });

      // Optional auto-resize if provider posts height messages
      // We accept messages only from the expected origin for safety.
      var expectedOrigin = new URL(src).origin;
      window.addEventListener('message', function (evt) {
        try {
          if (evt.origin !== expectedOrigin) return; // security: ignore other origins
          var data = evt.data || {};
          // Accept common shapes, e.g. {type:'resize', height:1234} or {directHeight:1234}
          var h = null;
          if (typeof data === 'object') {
            if (typeof data.height === 'number') h = data.height;
            if (typeof data.directHeight === 'number') h = data.directHeight;
            if (data.type && /height|resize/i.test(String(data.type)) && typeof data.value === 'number') {
              h = data.value;
            }
          }
          if (h && h > 300) {
            // minimal clamp; prevents collapsing on weird messages
            iframe.style.height = (Math.min(h, 5000)) + 'px';
          }
        } catch (_) { /* ignore */ }
      });

      // Last resort: if frame can't load (blocked by headers), leave the fallback visible.
      // Note: onerror isn't reliable for cross-origin iframes; visible fallback covers that case.
    })();
  </script>

  <!-- (Optional) If your site uses strict CSP headers, ensure these directives include direct.app:
       Content-Security-Policy:
         default-src 'self';
         frame-src https://direct.app;
         child-src https://direct.app;  /* some servers still honor child-src */
         connect-src 'self' https://direct.app; /* if you fetch assets via JS */ -->
</main>
