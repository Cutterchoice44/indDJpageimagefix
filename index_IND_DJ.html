<?php
// cutty-ranks-config.php — simple JSON storage for Cutty Ranks
// API:
//   GET  ?action=load            → {"entries":[...]} (always returns something)
//   POST ?action=save  (JSON or form) with { auth, entries } → {"ok":true, "entries":[...]}

header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-store, no-cache, must-revalidate');

$DATA_FILE = __DIR__ . '/cutty-ranks-data.json';
$ADMIN_HASH = '446b03243337b8bb55581f2c94647468d02b9dc09aa07968701be1f65071599e'; // must match page

$action = isset($_GET['action']) ? $_GET['action'] : 'load';

function respond($obj, $code = 200){
  http_response_code($code);
  echo json_encode($obj, JSON_UNESCAPED_SLASHES);
  exit;
}
function error_out($msg, $code=400){ respond(['ok'=>false, 'error'=>$msg], $code); }

// Ensure data file exists
if (!file_exists($DATA_FILE)) {
  $initial = json_encode(['entries'=>[]], JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES);
  if (@file_put_contents($DATA_FILE, $initial, LOCK_EX) === false) {
    error_out('Cannot create data file (permissions).', 500);
  }
  @chmod($DATA_FILE, 0664); // adjust on your host if needed
}

if ($action === 'load') {
  $raw = @file_get_contents($DATA_FILE);
  if ($raw === false) error_out('Cannot read data file.', 500);
  $j = json_decode($raw, true);
  if (!is_array($j) || !isset($j['entries']) || !is_array($j['entries'])) {
    $j = ['entries'=>[]];
  }
  respond($j);
}

if ($action === 'save') {
  // Accept JSON or form-encoded
  $ctype = isset($_SERVER['CONTENT_TYPE']) ? strtolower($_SERVER['CONTENT_TYPE']) : '';
  if (strpos($ctype, 'application/json') !== false) {
    $in = json_decode(file_get_contents('php://input'), true);
  } else {
    // form fallback: entries is JSON string
    $in = [
      'auth'    => isset($_POST['auth'])    ? $_POST['auth']    : null,
      'entries' => isset($_POST['entries']) ? json_decode($_POST['entries'], true) : null
    ];
  }
  if (!is_array($in)) error_out('Invalid payload');

  if (!isset($in['auth']) || strtolower($in['auth']) !== strtolower($ADMIN_HASH)) {
    error_out('Unauthorized', 401);
  }

  $entries = isset($in['entries']) && is_array($in['entries']) ? $in['entries'] : [];
  // normalize
  $clean = [];
  foreach ($entries as $e) {
    $name = isset($e['name']) ? trim($e['name']) : '';
    $links = [];
    if (isset($e['links']) && is_array($e['links'])) {
      foreach ($e['links'] as $u) {
        $u = trim($u);
        if ($u !== '') $links[] = $u;
        if (count($links) >= 5) break;
      }
    }
    if ($name !== '' || $links) $clean[] = ['name'=>$name, 'links'=>$links];
  }

  $json = json_encode(['entries'=>$clean], JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES);
  if ($json === false) error_out('JSON encode error', 500);

  // Direct write (no temp/rename) — only needs the file itself to be writable
  if (@file_put_contents($DATA_FILE, $json, LOCK_EX) === false) {
    error_out('Cannot write data file (permissions).', 500);
  }
  @chmod($DATA_FILE, 0664);

  respond(['ok'=>true, 'entries'=>$clean]);
}

error_out('Unknown action', 400);
