<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cutters Choice Radio — DJ Selects</title>

  <!-- Site-wide CSS (keep your existing file/versioning) -->
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- Page styles -->
  <style>
    :root { --brand-teal:#5A8785; }

    /* HERO */
    .djselects-hero{
      padding:.6rem .75rem .2rem;
      border:2px solid var(--brand-teal);
      border-left:0; border-right:0;
      margin-bottom:.35rem;
      display:grid; grid-template-columns:1fr 160px; gap:.6rem; align-items:end;
    }
    .djselects-hero .strap{
      font-family:'Bebas Neue',sans-serif;
      font-size:clamp(1.1rem,2.4vw,1.7rem);
      line-height:1;
    }
    .djselects-hero .monthline{
      font-family:'Bebas Neue',sans-serif;
      font-size:clamp(2.6rem,5.6vw,3.8rem);
      line-height:1;
    }
    .djselects-hero #djNameText{ color:var(--brand-teal); }
    .djselects-hero .hero-right img{
      width:100%; height:auto; border:2px solid var(--brand-teal);
      border-radius:4px; background:#000; display:block;
    }

    /* NEXT BAR */
    .nextbar{ margin:.2rem .6rem .5rem; }
    .nextbar-inner{
      display:flex; align-items:center; gap:1rem;
      background:#0b0b0b; border:2px solid var(--brand-teal);
      padding:.45rem .6rem; border-radius:6px;
    }
    .nextbar .label{
      font-family:'Bebas Neue',sans-serif; font-size:clamp(1.2rem,2.2vw,1.6rem);
    }
    .nextbar .when{
      font-family:'Bebas Neue',sans-serif; font-size:clamp(1.3rem,2.6vw,1.8rem);
      color:var(--brand-teal);
    }

    /* MAIN — strips + preview */
    .compact-grid{
      display:grid; grid-template-columns:minmax(240px,360px) 1fr;
      gap:.6rem; padding:0 .6rem .9rem;
    }
    .strip-list{
      display:grid; grid-template-rows:repeat(5,90px);
      gap:.45rem; border:2px solid var(--brand-teal); padding:.35rem; background:#000;
    }
    .strip{
      position:relative;
      border:1px solid #264745; background:#0a0a0a;
      border-radius:4px; overflow:hidden; cursor:pointer;
    }
    .strip.selected{ outline:2px solid var(--brand-teal); }
    .strip iframe{ width:100%; height:100%; border:0; display:block; pointer-events:none; }
    .strip .select-overlay{ position:absolute; inset:0; }
    .strip:hover .select-overlay{
      box-shadow:inset 0 0 0 2px var(--brand-teal);
      background:rgba(90,135,133,0.08);
    }

    /* Big preview */
    .preview .ratio.big{ position:relative; width:100%; padding-top:28.125%; }
    .preview .ratio.big iframe{ position:absolute; inset:0; width:100%; height:100%; border:0; }
    .big-placeholder{
      font-family:'Bebas Neue',sans-serif; color:#6fa39f;
      font-size:clamp(1.1rem,2.4vw,1.6rem); padding:.75rem;
    }

    /* Admin */
    .admin-btn{
      position:fixed; right:12px; bottom:12px; z-index:9999;
      background:var(--brand-teal); color:#000; border:none;
      width:48px; height:48px; border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      box-shadow:0 6px 18px rgba(0,0,0,.35);
    }
    .admin-panel{
      position:fixed; right:12px; bottom:72px; width:min(560px,94vw); max-height:82vh;
      background:#0c0c0c; color:#fff; border:2px solid var(--brand-teal); border-radius:10px;
      display:none; flex-direction:column; z-index:9999; box-shadow:0 10px 30px rgba(0,0,0,.45);
    }
    .admin-panel.open{ display:flex; }
    .admin-head{ display:flex; align-items:center; justify-content:space-between; padding:.6rem .8rem; border-bottom:1px solid #1d3b3a; }
    .admin-close{ background:none; border:none; color:#fff; font-size:1.6rem; cursor:pointer; }
    .admin-body{ padding:.8rem; overflow-y:auto; padding-bottom:5.5rem; }
    .two-col{ display:grid; grid-template-columns:1fr 1fr; gap:.6rem; }
    .admin-body label{ display:block; margin-bottom:.65rem; }
    .admin-body input{ width:100%; padding:.55rem; background:#111; color:#fff; border:1px solid #264745; border-radius:6px; margin-top:.25rem; }
    #adminTracks .track-input{ display:grid; grid-template-columns:1fr auto auto; gap:.5rem; margin-bottom:.5rem; }
    #adminTracks button{ padding:.5rem .75rem; border-radius:6px; border:1px solid #264745; background:#121212; color:#fff; cursor:pointer; }
    .admin-actions{ position:sticky; bottom:0; background:#0c0c0c; border-top:1px solid #1d3b3a; display:flex; gap:.6rem; padding:.7rem .8rem; }
    .admin-actions .primary{ background:var(--brand-teal); color:#000; border:none; padding:.6rem .9rem; border-radius:8px; }
    .admin-actions .ghost{ background:#171717; color:#fff; border:1px solid #2a2a2a; padding:.6rem .9rem; border-radius:8px; }
    .admin-actions .danger{ background:#2b1818; color:#fff; border:1px solid #5a2020; padding:.6rem .9rem; border-radius:8px; }

    @media (max-width:960px){
      .djselects-hero{ grid-template-columns:1fr; }
      .compact-grid{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <!-- Header (matches site layout) -->
  <header class="header-banner">
    <div class="header-gif-right"></div>
    <div class="header-gif-left"></div>
    <div class="logo-container"><img class="logo" src="/images/logo.png" alt=""></div>
    <div class="title"><h1>Cutters Choice Radio</h1><p class="tagline">The home of relentless flavas and significant bangers!</p></div>
    <div class="logo-container"><img class="logo" src="/images/logo.png" alt=""></div>
  </header>

  <div style="height:2px;background-color:var(--brand-teal)"></div>

  <!-- Nav -->
  <nav id="main-nav">
    <div class="nav-menu">
      <a href="our-story.html"    class="nav-link">OUR STORY</a>
      <a href="index.html"        class="nav-link">HOME</a>
      <a href="index-ourDJS.html" class="nav-link">OUR DJS</a>
      <a href="dj-selects.html"   class="nav-link">DJ SELECTS</a>
      <a href="schedule.html"     class="nav-link">SCHEDULE</a>
      <a href="merch.html"        class="nav-link">MERCH</a>
    </div>
    <div class="nav-actions"></div>
  </nav>

  <div style="height:2px;background-color:var(--brand-teal)"></div>

  <!-- Hero -->
  <section class="djselects-hero condensed">
    <div class="hero-left">
      <div class="strap">Each month a different Cutters DJ selects 5 tracks of the month</div>
      <div class="monthline">THIS MONTH : <span id="djNameText">DJ NAME</span></div>
    </div>
    <div class="hero-right">
      <img id="djProfileThumb" src="/images/default-dj.png" alt="DJ profile" />
    </div>
  </section>

  <!-- Next Scheduled Show -->
  <section class="nextbar">
    <div class="nextbar-inner">
      <span class="label">NEXT SCHEDULED SHOW</span>
      <span class="when" id="nextShowWhen">Loading…</span>
    </div>
  </section>

  <!-- Tracks layout -->
  <main class="compact-grid">
    <aside id="stripList" class="strip-list" aria-label="Selected tracks (click to preview)"></aside>
    <section class="preview" id="mainPreview" aria-live="polite">
      <div class="big-placeholder">Select a track</div>
    </section>
  </main>

  <!-- Hidden admin mount -->
  <div id="adminMount" hidden></div>

  <!-- Page config -->
  <script>
    window.DJ_SELECTS = {
      CONFIG_ENDPOINT: 'dj-selects-config.php',
      PROXY_ENDPOINT:  'rc-proxy.php',
      // SHA-256 of passphrase:  ccr2025!
      ADMIN_HASH_HEX: '446b03243337b8bb55581f2c94647468d02b9dc09aa07968701be1f65071599e',
      // Optional: set a token that matches DJ_SELECTS_TOKEN env or hardcoded token in dj-selects-config.php to save server-side
      SAVE_TOKEN: ''
    };
  </script>

  <!-- Logic -->
  <script>
  (()=>{
    const CFG = window.DJ_SELECTS || {};

    const $ = (s,r=document)=>r.querySelector(s);
    const $$=(s,r=document)=>[...r.querySelectorAll(s)];

    const stripList   = $('#stripList');
    const mainPreview = $('#mainPreview');
    const djNameText  = $('#djNameText');
    const djProfile   = $('#djProfileThumb');
    const nextWhen    = $('#nextShowWhen');
    const adminMount  = $('#adminMount');

    let shared = {
      djName:'DJ NAME',
      profileImage:'/images/default-dj.png',
      stationId:'cutters-choice-radio',
      apiKey:'',
      tracks:[]
    };

    // --- helpers ---
    const sha256hex = async (text)=>{
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return [...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');
    };

    const toEmbed = (url)=>{
      if(!url) return null;
      try{
        const u = new URL(url.trim());
        if(u.hostname.includes('youtu')){
          let id='';
          if(u.hostname==='youtu.be') id = u.pathname.slice(1);
          else if(u.pathname.startsWith('/shorts/')) id = u.pathname.split('/')[2]||'';
          else if(u.searchParams.get('v')) id = u.searchParams.get('v');
          else if(/^\/embed\//.test(u.pathname)) id = u.pathname.split('/').pop();
          id=(id||'').split('?')[0].split('&')[0];
          if(!id) return null;
          return `https://www.youtube-nocookie.com/embed/${id}?rel=0&modestbranding=1&playsinline=1`;
        }
        return url;
      }catch{ return null; }
    };

    const iframeAttrs = (src,big=false)=>
      `<iframe src="${src}" title="YouTube video" loading="${big?'eager':'lazy'}"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
        referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>`;

    const setPreview = (src)=>{
      mainPreview.innerHTML = `<div class="ratio big">${iframeAttrs(src,true)}</div>`;
    };

    const renderStrips=(embeds)=>{
      stripList.innerHTML='';
      embeds.slice(0,5).forEach((src,i)=>{
        const strip=document.createElement('div');
        strip.className='strip';
        strip.innerHTML = iframeAttrs(src,false) + '<div class="select-overlay" aria-hidden="true"></div>';
        strip.querySelector('.select-overlay').addEventListener('click',()=>{
          $$('.strip').forEach(s=>s.classList.remove('selected'));
          strip.classList.add('selected');
          setPreview(src);
        });
        stripList.appendChild(strip);
        if(i===0){ strip.classList.add('selected'); setPreview(src); }
      });
      if(embeds.length===0) mainPreview.innerHTML='<div class="big-placeholder">Select a track</div>';
    };

    // Format in viewer's local timezone (with zone abbreviation)
    const fmtLocal = (iso)=>{
      try{
        const d = new Date(iso);
        const opts={weekday:'short',day:'numeric',month:'short',hour:'2-digit',minute:'2-digit',hour12:false,timeZoneName:'short'};
        return d.toLocaleString(undefined,opts);
      }catch{ return ''; }
    };

    // --- load shared config from server, fallback to localStorage ---
    async function loadSharedConfig(){
      try{
        const res = await fetch(`${CFG.CONFIG_ENDPOINT}?action=load`, {cache:'no-store'});
        if(!res.ok) throw new Error('load failed');
        const data = await res.json();
        if(data && data.djName) shared = {...shared, ...data};
      }catch(e){
        const raw = localStorage.getItem('dj-selects-config');
        if(raw) shared = {...shared, ...JSON.parse(raw)};
      }
    }

    // --- next scheduled show via proxy ---
    async function loadNextShow(){
      nextWhen.textContent='Loading…';
      try{
        const url = `${CFG.PROXY_ENDPOINT}?fn=upcoming&stationId=${encodeURIComponent(shared.stationId)}&limit=50`;
        const res = await fetch(url, { headers:{'Accept':'application/json'}});
        if(!res.ok) throw new Error('proxy error');
        const payload = await res.json();
        const list = (payload?.data || payload || []);
        const target = list.find(evt=>{
          const nm = (evt?.artist?.name || evt?.presenter?.name || evt?.name || '').toLowerCase();
          return nm.includes((shared.djName||'').toLowerCase());
        });
        if(!target){ nextWhen.textContent='No upcoming show found'; return; }
        const whenISO = target?.startDate || target?.start || target?.scheduledStart || target?.start_time || '';
        if(!whenISO){ nextWhen.textContent='TBA'; return; }
        nextWhen.textContent = fmtLocal(whenISO);
        nextWhen.setAttribute('data-utc', whenISO);
        nextWhen.setAttribute('title', `Start (UTC): ${new Date(whenISO).toUTCString()}`);

        const img = target?.artist?.image || target?.presenter?.image || '';
        if(img && !shared.profileImage) djProfile.src = img;
      }catch(e){
        nextWhen.textContent='Unable to load schedule';
      }
    }

    // --- Admin UI (hidden until authenticated) ---
    function renderAdmin(){
      const btn=document.createElement('button');
      btn.className='admin-btn'; btn.id='adminBtn'; btn.title='Admin';
      btn.innerHTML='<i class="fa-solid fa-gear" aria-hidden="true"></i>';

      const panel=document.createElement('div');
      panel.className='admin-panel'; panel.id='adminPanel';
      panel.innerHTML=`
        <div class="admin-head">
          <strong>DJ SELECTS — Admin</strong>
          <button id="adminClose" class="admin-close" aria-label="Close">&times;</button>
        </div>
        <div class="admin-body">
          <label>DJ Name (as listed in Radio Cult)
            <input type="text" id="adminDjName" placeholder="e.g., MARIONETTE" value="${shared.djName}">
          </label>

          <div class="two-col">
            <label>Station ID
              <input type="text" id="adminStationId" placeholder="cutters-choice-radio" value="${shared.stationId}">
            </label>
            <label>Publishable API Key (optional – proxy can use server env)
              <input type="text" id="adminApiKey" placeholder="pk_..." value="${shared.apiKey}">
            </label>
          </div>

          <label>Profile Image URL (optional)
            <input type="text" id="profileOverride" placeholder="https://..." value="${shared.profileImage || ''}">
          </label>

          <div class="admin-subhead" style="margin:.5rem 0 .25rem;font-family:'Bebas Neue',sans-serif;font-size:1.3rem;">YouTube Track URLs (up to 5)</div>
          <div id="adminTracks"></div>

          <div class="admin-actions">
            <button id="adminSave" class="primary">Save</button>
            <button id="adminLogout" class="ghost">Logout</button>
            <button id="adminReset" class="danger">Reset (local only)</button>
          </div>
        </div>
      `;

      adminMount.after(btn, panel);
      adminMount.remove();

      const close=()=>panel.classList.remove('open');
      btn.addEventListener('click',()=>panel.classList.add('open'));
      panel.querySelector('#adminClose').addEventListener('click',close);

      // Tracks editor
      const tracksWrap=panel.querySelector('#adminTracks');
      const redraw=()=>{
        tracksWrap.innerHTML='';
        const current=[...shared.tracks,'','','',''].slice(0,5);
        current.forEach((val)=>{
          const row=document.createElement('div');
          row.className='track-input';
          row.innerHTML=`
            <input type="url" placeholder="https://www.youtube.com/watch?v=..." value="${val||''}">
            <button data-act="clear">Clear</button>
            <button data-act="paste">Paste</button>
          `;
          row.querySelector('[data-act="clear"]').addEventListener('click',()=>{ row.querySelector('input').value=''; });
          row.querySelector('[data-act="paste"]').addEventListener('click',async ()=>{
            try{ const txt=await navigator.clipboard.readText(); row.querySelector('input').value=txt; }catch{}
          });
          tracksWrap.appendChild(row);
        });
      };
      redraw();

      panel.querySelector('#adminSave').addEventListener('click', async ()=>{
        shared.djName = panel.querySelector('#adminDjName').value.trim() || shared.djName;
        shared.stationId = panel.querySelector('#adminStationId').value.trim() || shared.stationId;
        shared.apiKey = panel.querySelector('#adminApiKey').value.trim();
        shared.profileImage = panel.querySelector('#profileOverride').value.trim();

        const urls = $$('.track-input input', panel).map(i=>i.value.trim()).filter(Boolean);
        shared.tracks = urls.slice(0,5);

        // Local convenience
        localStorage.setItem('dj-selects-config', JSON.stringify(shared));

        // Server save (shared for everyone)
        if(CFG.SAVE_TOKEN){
          try{
            const res = await fetch(`${CFG.CONFIG_ENDPOINT}?action=save`,{
              method:'POST', headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ token: CFG.SAVE_TOKEN, data: shared })
            });
            if(!res.ok) throw new Error('save failed');
          }catch(e){
            alert('Server save failed — check token & file permissions.');
          }
        }else{
          alert('Saved locally. To save for everyone, set SAVE_TOKEN in this page and DJ_SELECTS_TOKEN (or hardcode) in dj-selects-config.php.');
        }

        applyConfig(); close();
      });

      panel.querySelector('#adminLogout').addEventListener('click',()=>{
        sessionStorage.removeItem('dj-selects-auth'); location.reload();
      });

      panel.querySelector('#adminReset').addEventListener('click',()=>{
        localStorage.removeItem('dj-selects-config'); alert('Local data cleared. Reloading…'); location.reload();
      });
    }

    async function ensureAdmin(){
      const promptAuth = async ()=>{
        const pwd = window.prompt('Enter admin passphrase:');
        if(!pwd) return;
        const hex = await sha256hex(pwd);
        if(hex === CFG.ADMIN_HASH_HEX){
          sessionStorage.setItem('dj-selects-auth','1'); renderAdmin();
        }else{
          alert('Wrong passphrase.');
        }
      };
      if(new URLSearchParams(location.search).get('admin')==='1') await promptAuth();
      document.addEventListener('keydown', async (e)=>{
        if(e.key.toLowerCase()==='a' && e.shiftKey) await promptAuth();
      });
      if(sessionStorage.getItem('dj-selects-auth')==='1') renderAdmin();
    }

    function applyConfig(){
      djNameText.textContent = shared.djName || 'DJ NAME';
      if(shared.profileImage) djProfile.src = shared.profileImage;
      const embeds = (shared.tracks||[]).map(toEmbed).filter(Boolean);
      renderStrips(embeds);
      loadNextShow();
    }

    window.addEventListener('DOMContentLoaded', async ()=>{
      await loadSharedConfig();
      applyConfig();
      ensureAdmin();
    });
  })();
  </script>
</body>
</html>
