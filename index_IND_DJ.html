<?php
declare(strict_types=1);
header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-store, no-cache, must-revalidate, max-age=0');

const DATA_FILE      = __DIR__ . '/data/best-of-2025-mixes.json';
const ADMIN_HASH_HEX = '446b03243337b8bb55581f2c94647468d02b9dc09aa07968701be1f65071599e'; // sha256('ccr2025!')

$method = $_SERVER['REQUEST_METHOD'] ?? 'GET';
$action = $_GET['action'] ?? ($_POST['action'] ?? ($method==='POST' ? 'save' : 'load'));

function respond($ok, $extra=[]){ echo json_encode(['ok'=>$ok]+$extra, JSON_UNESCAPED_SLASHES); exit; }
function fail($code,$msg){ http_response_code($code); respond(false,['error'=>$msg]); }
function ensureFile(){
  $dir = dirname(DATA_FILE); if(!is_dir($dir)) @mkdir($dir,0755,true);
  if(!file_exists(DATA_FILE)){ @file_put_contents(DATA_FILE,"[]\n",LOCK_EX); @chmod(DATA_FILE,0644); }
}
function loadAll(){ ensureFile(); $raw=@file_get_contents(DATA_FILE); $j=json_decode($raw?:'[]',true); return is_array($j)?$j:[]; }
function validWidget($u){
  $p=@parse_url($u); if(!$p||($p['scheme']??'')!=='https') return false;
  $h=strtolower($p['host']??''); if(!in_array($h,['www.mixcloud.com','mixcloud.com','player.mixcloud.com'])) return false;
  if(strpos($p['path']??'','/widget/iframe')!==0 && strpos($p['path']??'','/widget/iframe/')===false) return false;
  parse_str($p['query']??'', $q); if(empty($q['feed'])) return false;
  $feed=rawurldecode($q['feed']); return (bool)preg_match('#^/[A-Za-z0-9_.-]+/[A-Za-z0-9_.-]+/#',$feed);
}
function sanitize($rows){
  if(!is_array($rows)) return [];
  $out=[];
  foreach($rows as $r){
    $artistId = isset($r['artistId']) ? (string)$r['artistId'] : '';
    $widget   = isset($r['widgetSrc']) ? (string)$r['widgetSrc'] : '';
    $copy     = isset($r['copy']) ? (string)$r['copy'] : '';
    if($artistId && $widget && validWidget($widget)){
      $copy = trim(strip_tags($copy)); if (mb_strlen($copy)>2000) $copy=mb_substr($copy,0,2000);
      $out[] = ['artistId'=>$artistId, 'widgetSrc'=>$widget, 'copy'=>$copy];
    }
  }
  return $out;
}
function saveAll($rows){
  ensureFile();
  $json = json_encode($rows, JSON_UNESCAPED_SLASHES|JSON_PRETTY_PRINT)."\n";
  $tmp = DATA_FILE.'.tmp.'.bin2hex(random_bytes(4));
  if(@file_put_contents($tmp,$json,LOCK_EX)===false) fail(500,'Write failed');
  if(!@rename($tmp,DATA_FILE)){ @unlink($tmp); fail(500,'Replace failed'); }
  @chmod(DATA_FILE,0644); return $rows;
}
if ($action==='load'){ respond(true, ['entries'=>loadAll()]); }
if ($action==='save'){
  if($method!=='POST') fail(405,'POST required');
  $raw=file_get_contents('php://input'); if(!$raw) fail(400,'Empty body');
  $in=json_decode($raw,true); if(!is_array($in)) fail(400,'Invalid JSON');
  $auth=strtolower((string)($in['auth']??'')); if($auth!==ADMIN_HASH_HEX) fail(401,'Unauthorized');
  $rows=sanitize($in['entries']??[]); respond(true, ['entries'=>saveAll($rows)]);
}
fail(400,'Unknown action');

<!-- =====================================================================
File: /data/best-of-2025-mixes.json
Create folder /data if it doesnâ€™t exist. File contents:
===================================================================== -->
[]
