<?php
// rc-proxy.php
declare(strict_types=1);

// Usage: rc-proxy.php?fn=bandcamp_oembed&url=<bandcamp-url>
header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-store, no-cache, must-revalidate');

$fn  = $_GET['fn']  ?? '';
$url = $_GET['url'] ?? '';

function jexit($arr, int $code=200){ http_response_code($code); echo json_encode($arr, JSON_UNESCAPED_SLASHES|JSON_UNESCAPED_UNICODE); exit; }

if ($fn === 'bandcamp_oembed') {
  if (!$url || !preg_match('~https?://[^ ]+bandcamp\.com/[^ ]+~i', $url)) {
    jexit(['error'=>'Invalid Bandcamp URL'], 400);
  }

  $cacheDir = __DIR__.'/.cache';
  if (!is_dir($cacheDir)) @mkdir($cacheDir, 0775, true);
  $key = $cacheDir.'/bc-'.sha1($url).'.json';

  // Serve cached (1 day)
  if (file_exists($key) && (time() - filemtime($key) < 86400)) {
    $cached = @file_get_contents($key);
    if ($cached) { echo $cached; exit; }
  }

  $endpoint = 'https://bandcamp.com/oembed?format=json&maxwidth=1200&url='.rawurlencode($url);

  $ch = curl_init($endpoint);
  curl_setopt_array($ch, [
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_FOLLOWLOCATION => true,
    CURLOPT_TIMEOUT => 12,
    CURLOPT_SSL_VERIFYPEER => true,
    CURLOPT_SSL_VERIFYHOST => 2,
    CURLOPT_USERAGENT => 'CCR-Proxy/1.0'
  ]);
  $resp = curl_exec($ch);
  $err  = curl_error($ch);
  $code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
  curl_close($ch);

  if ($resp === false || $code >= 400) {
    jexit(['error'=>'Bandcamp fetch failed', 'status'=>$code, 'detail'=>$err], 502);
  }

  // Cache and pass through
  @file_put_contents($key, $resp, LOCK_EX);
  header('Content-Type: application/json; charset=utf-8');
  echo $resp;
  exit;
}

jexit(['error'=>'Unknown fn'], 400);
