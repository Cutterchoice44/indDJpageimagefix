\<?php
/**
 * DJ Selects config store (JSON file)
 * Place in the same directory as dj-selects.html
 * Protect this file with server-side security (e.g., .htaccess) if possible.
 */

declare(strict_types=1);
header('Content-Type: application/json; charset=utf-8');
header('Cache-Control: no-store');
header('Access-Control-Allow-Origin: *');

$DATA_FILE = __DIR__ . '/dj-selects-data.json';

/**
 * Security: require a shared token on SAVE. Keep this OUT of client-side when possible.
 * Option A (recommended): set env var DJ_SELECTS_TOKEN in your panel.
 * Option B: hardcode here (less secure).
 */
$SERVER_TOKEN = getenv('DJ_SELECTS_TOKEN') ?: 'CHANGE_ME_SERVER_TOKEN';

$action = $_GET['action'] ?? 'load';

if ($action === 'load') {
  if (!file_exists($DATA_FILE)) {
    echo json_encode([
      'djName' => 'DJ NAME',
      'profileImage' => '/images/default-dj.png',
      'stationId' => 'cutters-choice-radio',
      'apiKey' => '',
      'tracks' => []
    ]);
    exit;
  }
  $raw = file_get_contents($DATA_FILE);
  echo $raw ?: '{}';
  exit;
}

if ($action === 'save') {
  $body = json_decode(file_get_contents('php://input'), true);
  $token = $body['token'] ?? '';
  if (!$token || $token !== $SERVER_TOKEN) {
    http_response_code(403);
    echo json_encode(['error'=>'forbidden']);
    exit;
  }
  $data = $body['data'] ?? null;
  if (!$data || !is_array($data)) {
    http_response_code(400);
    echo json_encode(['error'=>'bad_data']);
    exit;
  }
  // Minimal validation
  $data['djName'] = trim((string)($data['djName'] ?? 'DJ NAME'));
  $data['stationId'] = trim((string)($data['stationId'] ?? 'cutters-choice-radio'));
  $tracks = $data['tracks'] ?? [];
  if (!is_array($tracks)) $tracks = [];
  $data['tracks'] = array_values(array_slice(array_filter($tracks, function($u){
    return is_string($u) && preg_match('#^https?://#', $u);
  }), 0, 5));

  // Write JSON atomically
  $tmp = $DATA_FILE . '.tmp';
  $ok = file_put_contents($tmp, json_encode($data, JSON_PRETTY_PRINT|JSON_UNESCAPED_SLASHES));
  if ($ok === false) { http_response_code(500); echo json_encode(['error'=>'write_failed']); exit; }
  rename($tmp, $DATA_FILE);
  @chmod($DATA_FILE, 0644);

  echo json_encode(['ok'=>true]);
  exit;
}

http_response_code(400);
echo json_encode(['error'=>'bad_action']);
